

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>submissions.views &mdash; SciPost 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="SciPost 1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> SciPost
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributors/contributors.html">For Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developers/developers.html">For Developers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">SciPost</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>submissions.views</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for submissions.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">feedparser</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="k">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">logout</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">permission_required</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Group</span><span class="p">,</span> <span class="n">Permission</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">PermissionDenied</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="k">import</span> <span class="n">EmailMessage</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Avg</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="k">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="k">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="k">import</span> <span class="n">csrf_protect</span>

<span class="kn">from</span> <span class="nn">guardian.decorators</span> <span class="k">import</span> <span class="n">permission_required_or_403</span>
<span class="kn">from</span> <span class="nn">guardian.shortcuts</span> <span class="k">import</span> <span class="n">assign_perm</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">SubmissionUtils</span>

<span class="kn">from</span> <span class="nn">comments.models</span> <span class="k">import</span> <span class="n">Comment</span>
<span class="kn">from</span> <span class="nn">journals.models</span> <span class="k">import</span> <span class="n">journals_submit_dict</span>
<span class="kn">from</span> <span class="nn">scipost.models</span> <span class="k">import</span> <span class="n">Contributor</span><span class="p">,</span> <span class="n">title_dict</span><span class="p">,</span> <span class="n">Remark</span><span class="p">,</span> <span class="n">RegistrationInvitation</span>

<span class="kn">from</span> <span class="nn">scipost.utils</span> <span class="k">import</span> <span class="n">Utils</span>

<span class="kn">from</span> <span class="nn">comments.forms</span> <span class="k">import</span> <span class="n">CommentForm</span>



<span class="c1">###############</span>
<span class="c1"># SUBMISSIONS:</span>
<span class="c1">###############</span>

<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_submit_manuscript&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">prefill_using_identifier</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">identifierform</span> <span class="o">=</span> <span class="n">SubmissionIdentifierForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifierform</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1"># we allow 1 or 2 digits for version</span>
            <span class="n">identifierpattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^[0-9]{4,}.[0-9]{4,5}v[0-9]{1,2}$&quot;</span><span class="p">)</span>
            <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identifierpattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">identifierform</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]):</span>
                <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The identifier you entered is improperly formatted &#39;</span>
                                <span class="s1">&#39;(did you forget the version number?)&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span>
                  <span class="c1">#.filter(arxiv_link__contains=identifierform.cleaned_data[&#39;identifier&#39;])</span>
                  <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">identifierform</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">])</span>
                  <span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
                <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;This preprint version has already been submitted to SciPost.&#39;</span>
            <span class="k">if</span> <span class="n">errormessage</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionForm</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_manuscript.html&#39;</span><span class="p">,</span>
                              <span class="p">{</span><span class="s1">&#39;identifierform&#39;</span><span class="p">:</span> <span class="n">identifierform</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                               <span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">})</span>
            <span class="c1"># Otherwise we query arXiv for the information:</span>
            <span class="n">identifier_without_vn_nr</span> <span class="o">=</span> <span class="n">identifierform</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">arxiv_vn_nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">identifierform</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">is_resubmission</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resubmessage</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">previous_submissions</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">arxiv_identifier_wo_vn_nr</span><span class="o">=</span><span class="n">identifier_without_vn_nr</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-arxiv_vn_nr&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">previous_submissions</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rejected&#39;</span><span class="p">,</span> <span class="s1">&#39;rejected_visible&#39;</span><span class="p">,]:</span>
                    <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;p&gt;This arXiv preprint has previously undergone refereeing &#39;</span>
                                    <span class="s1">&#39;and has been rejected. Resubmission is only possible &#39;</span>
                                    <span class="s1">&#39;if the manuscript has been substantially reworked into &#39;</span>
                                    <span class="s1">&#39;a new arXiv submission with distinct identifier.&lt;/p&gt;&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/error.html&#39;</span><span class="p">,</span>
                                  <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">errormessage</span><span class="p">)})</span>
                <span class="c1"># If the Editorial Recommendation hasn&#39;t been formulated, ask to wait</span>
                <span class="k">if</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;revision_requested&#39;</span><span class="p">:</span>
                    <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;p&gt;There exists a preprint with this arXiv identifier &#39;</span>
                                    <span class="s1">&#39;but an earlier version number, which is still undergoing &#39;</span>
                                    <span class="s1">&#39;peer refereeing.&lt;/p&gt;&#39;</span>
                                    <span class="s1">&#39;&lt;p&gt;A resubmission can only be performed after request &#39;</span>
                                    <span class="s1">&#39;from the Editor-in-charge. Please wait until the &#39;</span>
                                    <span class="s1">&#39;closing of the previous refereeing round and &#39;</span>
                                    <span class="s1">&#39;formulation of the Editorial Recommendation &#39;</span>
                                    <span class="s1">&#39;before proceeding with a resubmission.&lt;/p&gt;&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/error.html&#39;</span><span class="p">,</span>
                                  <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">errormessage</span><span class="p">)})</span>
                <span class="n">is_resubmission</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">resubmessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;There already exists a preprint with this arXiv identifier &#39;</span>
                                <span class="s1">&#39;but a different version number. </span><span class="se">\n</span><span class="s1">Your Submission will be &#39;</span>
                                <span class="s1">&#39;handled as a resubmission.&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">queryurl</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;http://export.arxiv.org/api/query?id_list=</span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="n">identifierform</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">])</span>
                <span class="n">arxivquery</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">queryurl</span><span class="p">)</span>
                <span class="c1"># Flag error if preprint doesn&#39;t exist</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;A preprint associated to this identifier does not exist.&#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># If paper has been published, should comment on published version</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arxiv_journal_ref</span> <span class="o">=</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;arxiv_journal_ref&#39;</span><span class="p">]</span>
                    <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;This paper has been published as &#39;</span> <span class="o">+</span> <span class="n">arxiv_journal_ref</span> <span class="o">+</span>
                                    <span class="s1">&#39;. You cannot submit it to SciPost anymore.&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arxiv_doi</span> <span class="o">=</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;arxiv_doi&#39;</span><span class="p">]</span>
                    <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;This paper has been published under DOI &#39;</span> <span class="o">+</span> <span class="n">arxiv_DOI</span>
                                    <span class="o">+</span> <span class="s1">&#39;. You cannot submit it to SciPost anymore.&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">errormessage</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionForm</span><span class="p">()</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;identifierform&#39;</span><span class="p">:</span> <span class="n">identifierform</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                               <span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_manuscript.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="c1"># otherwise prefill the form:</span>
                <span class="c1"># metadata = arxivquery</span>
                <span class="c1"># title = arxivquery[&#39;entries&#39;][0][&#39;title&#39;]</span>
                <span class="c1"># authorlist = arxivquery[&#39;entries&#39;][0][&#39;authors&#39;][0][&#39;name&#39;]</span>
                <span class="c1"># for author in arxivquery[&#39;entries&#39;][0][&#39;authors&#39;][1:]:</span>
                <span class="c1">#     authorlist += &#39;, &#39; + author[&#39;name&#39;]</span>
                <span class="c1"># arxiv_link = arxivquery[&#39;entries&#39;][0][&#39;id&#39;]</span>
                <span class="c1"># abstract = arxivquery[&#39;entries&#39;][0][&#39;summary&#39;]</span>
                <span class="c1"># form = SubmissionForm(</span>
                <span class="c1">#     initial={&#39;is_resubmission&#39;: is_resubmission,</span>
                <span class="c1">#              &#39;metadata&#39;: metadata,</span>
                <span class="c1">#              &#39;title&#39;: title, &#39;author_list&#39;: authorlist,</span>
                <span class="c1">#              &#39;arxiv_identifier_w_vn_nr&#39;: identifierform.cleaned_data[&#39;identifier&#39;],</span>
                <span class="c1">#              &#39;arxiv_identifier_wo_vn_nr&#39;: identifier_without_vn_nr,</span>
                <span class="c1">#              &#39;arxiv_vn_nr&#39;: arxiv_vn_nr,</span>
                <span class="c1">#              &#39;arxiv_link&#39;: arxiv_link, &#39;abstract&#39;: abstract})</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">arxivquery</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
                <span class="n">authorlist</span> <span class="o">=</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">authorlist</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">author</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">arxiv_link</span> <span class="o">=</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">abstract</span> <span class="o">=</span> <span class="n">arxivquery</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span>
                <span class="n">initialdata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_resubmission&#39;</span><span class="p">:</span> <span class="n">is_resubmission</span><span class="p">,</span>
                             <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
                             <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s1">&#39;author_list&#39;</span><span class="p">:</span> <span class="n">authorlist</span><span class="p">,</span>
                             <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">identifierform</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;arxiv_identifier_wo_vn_nr&#39;</span><span class="p">:</span> <span class="n">identifier_without_vn_nr</span><span class="p">,</span>
                             <span class="s1">&#39;arxiv_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_vn_nr</span><span class="p">,</span>
                             <span class="s1">&#39;arxiv_link&#39;</span><span class="p">:</span> <span class="n">arxiv_link</span><span class="p">,</span> <span class="s1">&#39;abstract&#39;</span><span class="p">:</span> <span class="n">abstract</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">is_resubmission</span><span class="p">:</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;submitted_to_journal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">submitted_to_journal</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;submission_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">submission_type</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;discipline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">discipline</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span>
<span class="c1">#                    initialdata[&#39;specialization&#39;] = previous_submissions[0].specialization</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;subject_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject_area</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;secondary_areas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">secondary_areas</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;referees_suggested&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">referees_suggested</span>
                    <span class="n">initialdata</span><span class="p">[</span><span class="s1">&#39;referees_flagged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">referees_flagged</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">initialdata</span><span class="p">)</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;identifierform&#39;</span><span class="p">:</span> <span class="n">identifierform</span><span class="p">,</span>
                           <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                           <span class="s1">&#39;resubmessage&#39;</span><span class="p">:</span> <span class="n">resubmessage</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_manuscript.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected error in prefill_using_identifier:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;identifierform&#39;</span><span class="p">:</span> <span class="n">identifierform</span><span class="p">,</span>
                           <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">SubmissionForm</span><span class="p">(),</span>
                           <span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">,}</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_manuscript.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:submit_manuscript&#39;</span><span class="p">))</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_submit_manuscript&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span> <span class="nf">submit_manuscript</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">submitted_by</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="c1"># Verify if submitter is among the authors</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">submitted_by</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;author_list&#39;</span><span class="p">]:</span>
                <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Your name does not match that of any of the authors. &#39;</span>
                                <span class="s1">&#39;You are not authorized to submit this preprint.&#39;</span><span class="p">)</span>
                <span class="n">identifierform</span> <span class="o">=</span> <span class="n">SubmissionIdentifierForm</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_manuscript.html&#39;</span><span class="p">,</span>
                              <span class="p">{</span><span class="s1">&#39;identifierform&#39;</span><span class="p">:</span> <span class="n">identifierform</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                               <span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">})</span>
            <span class="n">submission</span> <span class="o">=</span> <span class="n">Submission</span> <span class="p">(</span>
                <span class="n">is_current</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">is_resubmission</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_resubmission&#39;</span><span class="p">],</span>
                <span class="n">submitted_by</span> <span class="o">=</span> <span class="n">submitted_by</span><span class="p">,</span>
                <span class="n">submitted_to_journal</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;submitted_to_journal&#39;</span><span class="p">],</span>
                <span class="n">submission_type</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;submission_type&#39;</span><span class="p">],</span>
                <span class="n">discipline</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;discipline&#39;</span><span class="p">],</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">],</span>
<span class="c1">#                specialization = form.cleaned_data[&#39;specialization&#39;],</span>
                <span class="n">subject_area</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;subject_area&#39;</span><span class="p">],</span>
                <span class="n">secondary_areas</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;secondary_areas&#39;</span><span class="p">],</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                <span class="n">author_list</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;author_list&#39;</span><span class="p">],</span>
                <span class="n">abstract</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;abstract&#39;</span><span class="p">],</span>
                <span class="n">arxiv_identifier_w_vn_nr</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">],</span>
                <span class="n">arxiv_identifier_wo_vn_nr</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;arxiv_identifier_wo_vn_nr&#39;</span><span class="p">],</span>
                <span class="n">arxiv_vn_nr</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;arxiv_vn_nr&#39;</span><span class="p">],</span>
                <span class="n">arxiv_link</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;arxiv_link&#39;</span><span class="p">],</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">],</span>
                <span class="n">submission_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">remarks_for_editors</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;remarks_for_editors&#39;</span><span class="p">],</span>
                <span class="n">referees_suggested</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;referees_suggested&#39;</span><span class="p">],</span>
                <span class="n">referees_flagged</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;referees_flagged&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">submitted_by</span><span class="p">)</span> <span class="c1"># must be author to be able to submit</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># If this is a resubmission, mark previous submissions as deprecated:</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_resubmission&#39;</span><span class="p">]:</span>
                <span class="n">previous_submissions</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">arxiv_identifier_wo_vn_nr</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;arxiv_identifier_wo_vn_nr&#39;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-arxiv_vn_nr&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">previous_submissions</span><span class="p">:</span>
                    <span class="n">sub</span><span class="o">.</span><span class="n">is_current</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sub</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sub</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;resubmitted&#39;</span>
                    <span class="n">sub</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1"># Handle this submission in same way as if assignment had been accepted</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">deadline</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span> <span class="c1"># for papers</span>
                <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">submitted_to_journal</span> <span class="o">==</span> <span class="s1">&#39;SciPost Physics Lecture Notes&#39;</span><span class="p">:</span>
                    <span class="n">deadline</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">reporting_deadline</span> <span class="o">=</span> <span class="n">deadline</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">open_for_commenting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="c1"># We keep the same (most recent) Editor-in-charge by default</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span> <span class="o">=</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">editor_in_charge</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;EICassigned&#39;</span>
                <span class="c1"># Keep the info about authors:</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">authors_claims</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">authors_claims</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">previous_submissions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">authors_false_claims</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">authors_false_claims</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">author_comments</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;author_comments&#39;</span><span class="p">]</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">list_of_changes</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;list_of_changes&#39;</span><span class="p">]</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">EditorialAssignment</span><span class="p">(</span>
                    <span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                    <span class="n">to</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="p">,</span>
                    <span class="n">accepted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">date_created</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                    <span class="n">date_answered</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">})</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_authors_resubmission_ack_email</span><span class="p">()</span>
                <span class="n">assign_perm</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
                <span class="n">ed_admins</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Editorial Administrators&#39;</span><span class="p">)</span>
                <span class="n">assign_perm</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span> <span class="n">ed_admins</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_EIC_reappointment_email</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">})</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_authors_submission_ack_email</span><span class="p">()</span>

            <span class="c1">#return HttpResponseRedirect(reverse(&#39;submissions:submit_manuscript_ack&#39;))</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ack_header&#39;</span><span class="p">:</span> <span class="s1">&#39;Thank you for your Submission to SciPost&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ack_message&#39;</span><span class="p">:</span> <span class="s1">&#39;Your Submission will soon be handled by an Editor. &#39;</span><span class="p">,</span>
                       <span class="s1">&#39;followup_message&#39;</span><span class="p">:</span> <span class="s1">&#39;Return to your &#39;</span><span class="p">,</span>
                       <span class="s1">&#39;followup_link&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;scipost:personal_page&#39;</span><span class="p">),</span>
                       <span class="s1">&#39;followup_link_label&#39;</span><span class="p">:</span> <span class="s1">&#39;personal page&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/acknowledgement.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># form is invalid</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionForm</span><span class="p">()</span>
    <span class="n">identifierform</span> <span class="o">=</span> <span class="n">SubmissionIdentifierForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_manuscript.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;identifierform&#39;</span><span class="p">:</span> <span class="n">identifierform</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>


<div class="viewcode-block" id="submissions"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.submissions">[docs]</a><span class="k">def</span> <span class="nf">submissions</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_journal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main method for viewing Submissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionSearchForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">has_changed</span><span class="p">():</span>
            <span class="n">submission_search_list</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">title__icontains</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;title_keyword&#39;</span><span class="p">],</span>
                <span class="n">author_list__icontains</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span>
                <span class="n">abstract__icontains</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;abstract_keyword&#39;</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status__in</span><span class="o">=</span><span class="n">SUBMISSION_STATUS_PUBLICLY_UNLISTED</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submission_date&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">submission_search_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionSearchForm</span><span class="p">()</span>
        <span class="n">submission_search_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">submission_recent_list</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">latest_activity__gte</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="mi">60</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status__in</span><span class="o">=</span><span class="n">SUBMISSION_STATUS_PUBLICLY_UNLISTED</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">is_current</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submission_date&#39;</span><span class="p">)</span>
    <span class="c1"># If doing a journal-specific listing:</span>
    <span class="k">if</span> <span class="n">to_journal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">submission_recent_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submitted_to_journal</span><span class="o">=</span><span class="n">to_journal</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;submission_search_list&#39;</span><span class="p">:</span> <span class="n">submission_search_list</span><span class="p">,</span>
               <span class="s1">&#39;submission_recent_list&#39;</span><span class="p">:</span> <span class="n">submission_recent_list</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submissions.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">discipline</span><span class="p">,</span> <span class="n">nrweeksback</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionSearchForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">has_changed</span><span class="p">():</span>
            <span class="n">submission_search_list</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">title__icontains</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;title_keyword&#39;</span><span class="p">],</span>
                <span class="n">author_list__icontains</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span>
                <span class="n">abstract__icontains</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;abstract_keyword&#39;</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status__in</span><span class="o">=</span><span class="n">SUBMISSION_STATUS_PUBLICLY_UNLISTED</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submission_date&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">submission_search_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;submission_search_list&#39;</span><span class="p">:</span> <span class="n">submission_search_list</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submissions.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionSearchForm</span><span class="p">()</span>
    <span class="n">submission_browse_list</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">discipline</span><span class="o">=</span><span class="n">discipline</span><span class="p">,</span>
        <span class="n">latest_activity__gte</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=-</span><span class="nb">int</span><span class="p">(</span><span class="n">nrweeksback</span><span class="p">))</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status__in</span><span class="o">=</span><span class="n">SUBMISSION_STATUS_PUBLICLY_UNLISTED</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">is_current</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submission_date&#39;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;discipline&#39;</span><span class="p">:</span> <span class="n">discipline</span><span class="p">,</span> <span class="s1">&#39;nrweeksback&#39;</span><span class="p">:</span> <span class="n">nrweeksback</span><span class="p">,</span>
               <span class="s1">&#39;submission_browse_list&#39;</span><span class="p">:</span> <span class="n">submission_browse_list</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submissions.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">submission_detail_wo_vn_nr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_wo_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_wo_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_wo_vn_nr</span><span class="p">,</span>
                                   <span class="n">is_current</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">submission_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">submission_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">is_author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">is_author</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">SUBMISSION_STATUS_PUBLICLY_INVISIBLE</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SciPost Administrators&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Editorial Administrators&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Editorial College&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_author</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>
    <span class="n">other_versions</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">arxiv_identifier_wo_vn_nr</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">arxiv_identifier_wo_vn_nr</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">comment_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newcomment</span> <span class="o">=</span> <span class="n">Comment</span> <span class="p">(</span>
                <span class="n">submission</span> <span class="o">=</span> <span class="n">submission</span><span class="p">,</span>
                <span class="n">author</span> <span class="o">=</span> <span class="n">author</span><span class="p">,</span>
                <span class="n">is_rem</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_rem&#39;</span><span class="p">],</span>
                <span class="n">is_que</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_que&#39;</span><span class="p">],</span>
                <span class="n">is_ans</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_ans&#39;</span><span class="p">],</span>
                <span class="n">is_obj</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_obj&#39;</span><span class="p">],</span>
                <span class="n">is_rep</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_rep&#39;</span><span class="p">],</span>
                <span class="n">is_val</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_val&#39;</span><span class="p">],</span>
                <span class="n">is_lit</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_lit&#39;</span><span class="p">],</span>
                <span class="n">is_sug</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_sug&#39;</span><span class="p">],</span>
                <span class="n">comment_text</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;comment_text&#39;</span><span class="p">],</span>
                <span class="n">remarks_for_editors</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;remarks_for_editors&#39;</span><span class="p">],</span>
                <span class="n">date_submitted</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">author</span><span class="o">.</span><span class="n">nr_comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1">#request.session[&#39;arxiv_identifier_w_vn_nr&#39;] = submission.arxiv_identifier_w_vn_nr</span>
            <span class="c1">#return HttpResponseRedirect(reverse(&#39;comments:comment_submission_ack&#39;))</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ack_header&#39;</span><span class="p">:</span> <span class="s1">&#39;Thank you for contributing a Comment.&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ack_message&#39;</span><span class="p">:</span> <span class="s1">&#39;It will soon be vetted by an Editor.&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;followup_message&#39;</span><span class="p">:</span> <span class="s1">&#39;Back to the &#39;</span><span class="p">,</span>
                       <span class="s1">&#39;followup_link&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span>
                           <span class="s1">&#39;submissions:submission&#39;</span><span class="p">,</span>
                           <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">newcomment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}</span>
                       <span class="p">),</span>
                       <span class="s1">&#39;followup_link_label&#39;</span><span class="p">:</span> <span class="s1">&#39; Submission page you came from&#39;</span>
                   <span class="p">}</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/acknowledgement.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>

    <span class="n">reports</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">report_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">author_replies</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                                                <span class="n">is_author_reply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">status__gte</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Comment</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">author_replies</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1"># To check in template whether the user can submit a report:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">is_author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">is_author_unchecked</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_author</span>
                               <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">authors_false_claims</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                               <span class="ow">and</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">author_list</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">is_author</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">is_author_unchecked</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">recommendation</span> <span class="o">=</span> <span class="n">EICRecommendation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">EICRecommendation</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">recommendation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span>
               <span class="s1">&#39;other_versions&#39;</span><span class="p">:</span> <span class="n">other_versions</span><span class="p">,</span>
               <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">recommendation</span><span class="p">,</span>
               <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status__gte</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_author_reply</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-date_submitted&#39;</span><span class="p">)),</span>
               <span class="s1">&#39;invited_reports&#39;</span><span class="p">:</span> <span class="n">reports</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status__gte</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">invited</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
               <span class="s1">&#39;contributed_reports&#39;</span><span class="p">:</span> <span class="n">reports</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status__gte</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">invited</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
               <span class="s1">&#39;author_replies&#39;</span><span class="p">:</span> <span class="n">author_replies</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
               <span class="s1">&#39;is_author&#39;</span><span class="p">:</span> <span class="n">is_author</span><span class="p">,</span> <span class="s1">&#39;is_author_unchecked&#39;</span><span class="p">:</span> <span class="n">is_author_unchecked</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submission_detail.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1">######################</span>
<span class="c1"># Editorial workflow #</span>
<span class="c1">######################</span>

<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_take_charge_of_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="editorial_workflow"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.editorial_workflow">[docs]</a><span class="k">def</span> <span class="nf">editorial_workflow</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summary page for Editorial Fellows, containing a digest</span>
<span class="sd">    of the actions to take to handle Submissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/editorial_workflow.html&#39;</span><span class="p">)</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_view_pool&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="pool"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.pool">[docs]</a><span class="k">def</span> <span class="nf">pool</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Submissions pool contains all submissions which are undergoing</span>
<span class="sd">    the editorial process, from submission</span>
<span class="sd">    to publication acceptance or rejection.</span>
<span class="sd">    All members of the Editorial College have access.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">submissions_in_pool</span><span class="o">=</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                         <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status__in</span><span class="o">=</span><span class="n">SUBMISSION_STATUS_OUT_OF_POOL</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">is_current</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submission_date&#39;</span><span class="p">))</span>
    <span class="n">recommendations_undergoing_voting</span> <span class="o">=</span> <span class="p">(</span><span class="n">EICRecommendation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">submission__status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;put_to_EC_voting&#39;</span><span class="p">]))</span>
    <span class="n">recommendations_to_prepare_for_voting</span> <span class="o">=</span> <span class="p">(</span><span class="n">EICRecommendation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">submission__status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;voting_in_preparation&#39;</span><span class="p">]))</span>
    <span class="n">contributor</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assignments_to_consider</span> <span class="o">=</span> <span class="n">EditorialAssignment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">to</span><span class="o">=</span><span class="n">contributor</span><span class="p">,</span> <span class="n">accepted</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">consider_assignment_form</span> <span class="o">=</span> <span class="n">ConsiderAssignmentForm</span><span class="p">()</span>
    <span class="n">recs_to_vote_on</span> <span class="o">=</span> <span class="n">EICRecommendation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">eligible_to_vote__in</span><span class="o">=</span><span class="p">[</span><span class="n">contributor</span><span class="p">])</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
        <span class="n">recommendation</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">recommendation</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">voted_for__in</span><span class="o">=</span><span class="p">[</span><span class="n">contributor</span><span class="p">])</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">voted_against__in</span><span class="o">=</span><span class="p">[</span><span class="n">contributor</span><span class="p">])</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">voted_abstain__in</span><span class="o">=</span><span class="p">[</span><span class="n">contributor</span><span class="p">])</span>
    <span class="n">rec_vote_form</span> <span class="o">=</span> <span class="n">RecommendationVoteForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submissions_in_pool&#39;</span><span class="p">:</span> <span class="n">submissions_in_pool</span><span class="p">,</span>
               <span class="s1">&#39;recommendations_undergoing_voting&#39;</span><span class="p">:</span> <span class="n">recommendations_undergoing_voting</span><span class="p">,</span>
               <span class="s1">&#39;recommendations_to_prepare_for_voting&#39;</span><span class="p">:</span> <span class="n">recommendations_to_prepare_for_voting</span><span class="p">,</span>
               <span class="s1">&#39;assignments_to_consider&#39;</span><span class="p">:</span> <span class="n">assignments_to_consider</span><span class="p">,</span>
               <span class="s1">&#39;consider_assignment_form&#39;</span><span class="p">:</span> <span class="n">consider_assignment_form</span><span class="p">,</span>
               <span class="s1">&#39;recs_to_vote_on&#39;</span><span class="p">:</span> <span class="n">recs_to_vote_on</span><span class="p">,</span>
               <span class="s1">&#39;rec_vote_form&#39;</span><span class="p">:</span> <span class="n">rec_vote_form</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/pool.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_assign_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">assign_submission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission_to_assign</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span>
                                             <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="c1">#form = AssignSubmissionForm(discipline=submission_to_assign.discipline, subject_area=submission_to_assign.subject_area) # reactivate later on</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">AssignSubmissionForm</span><span class="p">(</span><span class="n">discipline</span><span class="o">=</span><span class="n">submission_to_assign</span><span class="o">.</span><span class="n">discipline</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission_to_assign&#39;</span><span class="p">:</span> <span class="n">submission_to_assign</span><span class="p">,</span>
               <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/assign_submission.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_assign_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">assign_submission_ack</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span>
                                   <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AssignSubmissionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">discipline</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">discipline</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">suggested_editor_in_charge</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;editor_in_charge&#39;</span><span class="p">]</span>
            <span class="c1"># TODO: check for possible co-authorships, disqualifying this suggested EIC</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suggested_editor_in_charge</span><span class="o">.</span><span class="n">is_currently_available</span><span class="p">():</span>
                <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;This Fellow is marked as currently unavailable. &#39;</span>
                                <span class="s1">&#39;Please go back and select another one.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/error.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">})</span>
            <span class="n">ed_assignment</span> <span class="o">=</span> <span class="n">EditorialAssignment</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                                                <span class="n">to</span><span class="o">=</span><span class="n">suggested_editor_in_charge</span><span class="p">,</span>
                                                <span class="n">date_created</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">ed_assignment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="n">ed_assignment</span><span class="p">})</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_assignment_request_email</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ack_header&#39;</span><span class="p">:</span> <span class="s1">&#39;Your assignment request has been sent successfully.&#39;</span><span class="p">,</span>
               <span class="s1">&#39;followup_message&#39;</span><span class="p">:</span> <span class="s1">&#39;Return to the &#39;</span><span class="p">,</span>
               <span class="s1">&#39;followup_link&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:pool&#39;</span><span class="p">),</span>
               <span class="s1">&#39;followup_link_label&#39;</span><span class="p">:</span> <span class="s1">&#39;Submissions pool&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/acknowledgement.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_take_charge_of_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span> <span class="nf">accept_or_decline_assignment_ack</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">assignment_id</span><span class="p">):</span>
    <span class="n">contributor</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assignment</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">EditorialAssignment</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">)</span>
    <span class="n">errormessage</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;assignment_failed&#39;</span><span class="p">:</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;This Submission has failed pre-screening and has been rejected.&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_assignment_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="p">:</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="n">title_dict</span><span class="p">[</span><span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="o">.</span><span class="n">title</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                        <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="o">+</span>
                        <span class="s1">&#39; has already agreed to be Editor-in-charge of this Submission.&#39;</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_assignment_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ConsiderAssignmentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">date_answered</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;accept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">contributor</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;EICassigned&#39;</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span> <span class="o">=</span> <span class="n">contributor</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">deadline</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span> <span class="c1"># for papers</span>
                <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">submitted_to_journal</span> <span class="o">==</span> <span class="s1">&#39;SciPost Physics Lecture Notes&#39;</span><span class="p">:</span>
                    <span class="n">deadline</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">reporting_deadline</span> <span class="o">=</span> <span class="n">deadline</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">open_for_commenting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">})</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">deprecate_other_assignments</span><span class="p">()</span>
                <span class="n">assign_perm</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span> <span class="n">contributor</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="p">)</span>
                <span class="n">ed_admins</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Editorial Administrators&#39;</span><span class="p">)</span>
                <span class="n">assign_perm</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span> <span class="n">ed_admins</span><span class="p">,</span> <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="p">)</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_EIC_appointment_email</span><span class="p">()</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_author_prescreening_passed_email</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">refusal_reason</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;refusal_reason&#39;</span><span class="p">]</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unassigned&#39;</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_assignment_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_take_charge_of_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<div class="viewcode-block" id="volunteer_as_EIC"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.volunteer_as_EIC">[docs]</a><span class="k">def</span> <span class="nf">volunteer_as_EIC</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when a Fellow volunteers while perusing the submissions pool.</span>
<span class="sd">    This is an adapted version of the accept_or_decline_assignment_ack method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">errormessage</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;assignment_failed&#39;</span><span class="p">:</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;This Submission has failed pre-screening and has been rejected.&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_assignment_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="p">:</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="n">title_dict</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="o">.</span><span class="n">title</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                        <span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="o">+</span>
                        <span class="s1">&#39; has already agreed to be Editor-in-charge of this Submission.&#39;</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_assignment_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="n">contributor</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assignment</span> <span class="o">=</span> <span class="n">EditorialAssignment</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                                     <span class="n">to</span><span class="o">=</span><span class="n">contributor</span><span class="p">,</span>
                                     <span class="n">accepted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">date_created</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                                     <span class="n">date_answered</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">deadline</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span> <span class="c1"># for papers</span>
    <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">submitted_to_journal</span> <span class="o">==</span> <span class="s1">&#39;SciPost Physics Lecture Notes&#39;</span><span class="p">:</span>
        <span class="n">deadline</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;EICassigned&#39;</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span> <span class="o">=</span> <span class="n">contributor</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">reporting_deadline</span> <span class="o">=</span> <span class="n">deadline</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">open_for_commenting</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">assignment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">})</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">deprecate_other_assignments</span><span class="p">()</span>
    <span class="n">assign_perm</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span> <span class="n">contributor</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
    <span class="n">ed_admins</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Editorial Administrators&#39;</span><span class="p">)</span>
    <span class="n">assign_perm</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span> <span class="n">ed_admins</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_EIC_appointment_email</span><span class="p">()</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_author_prescreening_passed_email</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_assignment_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_assign_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<div class="viewcode-block" id="assignment_failed"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.assignment_failed">[docs]</a><span class="k">def</span> <span class="nf">assignment_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    No Editorial Fellow has accepted or volunteered to become Editor-in-charge.</span>
<span class="sd">    The submission is rejected.</span>
<span class="sd">    This method is called from pool.html by an Editorial Administrator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;assignment_failed&#39;</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">})</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">deprecate_all_assignments</span><span class="p">()</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">assignment_failed_email_authors</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/assignment_failed_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">editorial_page</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">other_versions</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">arxiv_identifier_wo_vn_nr</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">arxiv_identifier_wo_vn_nr</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">ref_invitations</span> <span class="o">=</span> <span class="n">RefereeInvitation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">)</span>
    <span class="n">nr_reports_to_vet</span> <span class="o">=</span> <span class="p">(</span><span class="n">Report</span><span class="o">.</span><span class="n">objects</span>
                         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">submission__editor_in_charge</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="n">communications</span> <span class="o">=</span> <span class="p">(</span><span class="n">EditorialCommunication</span><span class="o">.</span><span class="n">objects</span>
                      <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">recommendation</span> <span class="o">=</span> <span class="n">EICRecommendation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">EICRecommendation</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">recommendation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span>
               <span class="s1">&#39;other_versions&#39;</span><span class="p">:</span> <span class="n">other_versions</span><span class="p">,</span>
               <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">recommendation</span><span class="p">,</span>
               <span class="s1">&#39;set_deadline_form&#39;</span><span class="p">:</span> <span class="n">SetRefereeingDeadlineForm</span><span class="p">(),</span>
               <span class="s1">&#39;ref_invitations&#39;</span><span class="p">:</span> <span class="n">ref_invitations</span><span class="p">,</span>
               <span class="s1">&#39;nr_reports_to_vet&#39;</span><span class="p">:</span> <span class="n">nr_reports_to_vet</span><span class="p">,</span>
               <span class="s1">&#39;communications&#39;</span><span class="p">:</span> <span class="n">communications</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/editorial_page.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">select_referee</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">queryresults</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">ref_search_form</span> <span class="o">=</span> <span class="n">RefereeSelectForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref_search_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">contributors_found</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">user__last_name__icontains</span><span class="o">=</span><span class="n">ref_search_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">])</span>
            <span class="c1"># Check for recent co-authorship (thus referee disqualification)</span>
            <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sub_auth_boolean_str</span> <span class="o">=</span> <span class="s1">&#39;((&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">submission</span>
                                               <span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                                               <span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">sub_auth_boolean_str</span> <span class="o">+=</span> <span class="s1">&#39;+OR+&#39;</span> <span class="o">+</span> <span class="n">author</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sub_auth_boolean_str</span> <span class="o">+=</span> <span class="s1">&#39;)+AND+&#39;</span>
                <span class="n">search_str</span> <span class="o">=</span> <span class="n">sub_auth_boolean_str</span> <span class="o">+</span> <span class="n">ref_search_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                <span class="n">queryurl</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;http://export.arxiv.org/api/query?search_query=au:</span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="n">search_str</span> <span class="o">+</span> <span class="s1">&#39;&amp;sortBy=submittedDate&amp;sortOrder=descending&#39;</span>
                            <span class="s1">&#39;&amp;max_results=5&#39;</span><span class="p">)</span>
                <span class="n">arxivquery</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">queryurl</span><span class="p">)</span>
                <span class="n">queryresults</span> <span class="o">=</span> <span class="n">arxivquery</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_search_form</span> <span class="o">=</span> <span class="n">RefereeSelectForm</span><span class="p">()</span>
        <span class="n">contributors_found</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ref_recruit_form</span> <span class="o">=</span> <span class="n">RefereeRecruitmentForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span> <span class="s1">&#39;ref_search_form&#39;</span><span class="p">:</span> <span class="n">ref_search_form</span><span class="p">,</span>
               <span class="s1">&#39;contributors_found&#39;</span><span class="p">:</span> <span class="n">contributors_found</span><span class="p">,</span>
               <span class="s1">&#39;ref_recruit_form&#39;</span><span class="p">:</span> <span class="n">ref_recruit_form</span><span class="p">,</span>
               <span class="s1">&#39;queryresults&#39;</span><span class="p">:</span> <span class="n">queryresults</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/select_referee.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<div class="viewcode-block" id="recruit_referee"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.recruit_referee">[docs]</a><span class="k">def</span> <span class="nf">recruit_referee</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the Editor-in-charge does not find the desired referee among Contributors</span>
<span class="sd">    (otherwise, the method send_refereeing_invitation below is used instead),</span>
<span class="sd">    he/she can invite somebody by providing name + contact details.</span>
<span class="sd">    This function emails a registration invitation to this person.</span>
<span class="sd">    The pending refereeing invitation is then recognized upon registration,</span>
<span class="sd">    using the invitation token.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">ref_recruit_form</span> <span class="o">=</span> <span class="n">RefereeRecruitmentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1"># TODO check if email already taken</span>
            <span class="n">ref_invitation</span> <span class="o">=</span> <span class="n">RefereeInvitation</span><span class="p">(</span>
                <span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                <span class="n">first_name</span><span class="o">=</span><span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">],</span>
                <span class="n">last_name</span><span class="o">=</span><span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">],</span>
                <span class="n">email_address</span><span class="o">=</span><span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email_address&#39;</span><span class="p">],</span>
                <span class="n">date_invited</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">invited_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
            <span class="n">ref_invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Create and send a registration invitation</span>
            <span class="n">ref_inv_message_head</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;On behalf of the Editor-in-charge &#39;</span> <span class="o">+</span>
                                    <span class="n">title_dict</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="o">.</span><span class="n">title</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                    <span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="o">+</span>
                                    <span class="s1">&#39;, we would like to invite you to referee a Submission to &#39;</span>
                                    <span class="o">+</span> <span class="n">journals_submit_dict</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">submitted_to_journal</span><span class="p">]</span>
                                    <span class="o">+</span> <span class="s1">&#39;, namely</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">submission</span><span class="o">.</span><span class="n">title</span>
                                    <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">by &#39;</span> <span class="o">+</span> <span class="n">submission</span><span class="o">.</span><span class="n">author_list</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">reg_invitation</span> <span class="o">=</span> <span class="n">RegistrationInvitation</span> <span class="p">(</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                <span class="n">first_name</span> <span class="o">=</span> <span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">],</span>
                <span class="n">last_name</span> <span class="o">=</span> <span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">],</span>
                <span class="n">email</span> <span class="o">=</span> <span class="n">ref_recruit_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email_address&#39;</span><span class="p">],</span>
                <span class="n">invitation_type</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span>
                <span class="n">invited_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">,</span>
                <span class="n">message_style</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
                <span class="n">personal_message</span> <span class="o">=</span> <span class="n">ref_inv_message_head</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">reg_invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;invitation&#39;</span><span class="p">:</span> <span class="n">reg_invitation</span><span class="p">})</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">send_registration_invitation_email</span><span class="p">()</span>
            <span class="c1"># Copy the key to the refereeing invitation:</span>
            <span class="n">ref_invitation</span><span class="o">.</span><span class="n">invitation_key</span> <span class="o">=</span> <span class="n">reg_invitation</span><span class="o">.</span><span class="n">invitation_key</span>
            <span class="n">ref_invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<div class="viewcode-block" id="send_refereeing_invitation"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.send_refereeing_invitation">[docs]</a><span class="k">def</span> <span class="nf">send_refereeing_invitation</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">,</span> <span class="n">contributor_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method is called by the EIC from the submission&#39;s editorial_page,</span>
<span class="sd">    in the case where the referee is an identified Contributor.</span>
<span class="sd">    For a referee who isn&#39;t a Contributor yet, the method recruit_referee above</span>
<span class="sd">    is called instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">contributor</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Contributor</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">contributor_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">contributor</span><span class="o">.</span><span class="n">is_currently_available</span><span class="p">():</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;This Contributor is marked as currently unavailable. &#39;</span>
                        <span class="s1">&#39;Please go back and select another referee.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/error.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">})</span>
    <span class="n">invitation</span> <span class="o">=</span> <span class="n">RefereeInvitation</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                                   <span class="n">referee</span><span class="o">=</span><span class="n">contributor</span><span class="p">,</span>
                                   <span class="n">title</span><span class="o">=</span><span class="n">contributor</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                                   <span class="n">first_name</span><span class="o">=</span><span class="n">contributor</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                                   <span class="n">last_name</span><span class="o">=</span><span class="n">contributor</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                                   <span class="n">email_address</span><span class="o">=</span><span class="n">contributor</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                   <span class="c1"># the key is only used for inviting unregistered users</span>
                                   <span class="n">invitation_key</span><span class="o">=</span><span class="s1">&#39;notused&#39;</span><span class="p">,</span>
                                   <span class="n">date_invited</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                                   <span class="n">invited_by</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
    <span class="n">invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;invitation&#39;</span><span class="p">:</span> <span class="n">invitation</span><span class="p">})</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_refereeing_invitation_email</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="ref_invitation_reminder"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.ref_invitation_reminder">[docs]</a><span class="k">def</span> <span class="nf">ref_invitation_reminder</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">,</span> <span class="n">invitation_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method is used by the Editor-in-charge from the editorial_page</span>
<span class="sd">    when a referee has been invited but hasn&#39;t answered yet.</span>
<span class="sd">    It can be used for registered as well as unregistered referees.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invitation</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">RefereeInvitation</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">invitation_id</span><span class="p">)</span>
    <span class="n">invitation</span><span class="o">.</span><span class="n">nr_reminders</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">invitation</span><span class="o">.</span><span class="n">date_last_reminded</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;invitation&#39;</span><span class="p">:</span> <span class="n">invitation</span><span class="p">})</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_ref_reminder_email</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_referee&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">accept_or_decline_ref_invitations</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">contributor</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">invitation</span> <span class="o">=</span> <span class="n">RefereeInvitation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">referee</span><span class="o">=</span><span class="n">contributor</span><span class="p">,</span> <span class="n">accepted</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ConsiderRefereeInvitationForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;invitation_to_consider&#39;</span><span class="p">:</span> <span class="n">invitation</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_ref_invitations.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_referee&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">accept_or_decline_ref_invitation_ack</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">invitation_id</span><span class="p">):</span>
    <span class="n">contributor</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">invitation</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">RefereeInvitation</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">invitation_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ConsiderRefereeInvitationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">invitation</span><span class="o">.</span><span class="n">date_responded</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;accept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                <span class="n">invitation</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invitation</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">invitation</span><span class="o">.</span><span class="n">refusal_reason</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;refusal_reason&#39;</span><span class="p">]</span>
            <span class="n">invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;invitation&#39;</span><span class="p">:</span> <span class="n">invitation</span><span class="p">})</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">email_referee_response_to_EIC</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;invitation&#39;</span><span class="p">:</span> <span class="n">invitation</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/accept_or_decline_ref_invitation_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>



<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="cancel_ref_invitation"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.cancel_ref_invitation">[docs]</a><span class="k">def</span> <span class="nf">cancel_ref_invitation</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">,</span> <span class="n">invitation_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method is used by the Editor-in-charge from the editorial_page</span>
<span class="sd">    to remove a referee for the list of invited ones.</span>
<span class="sd">    It can be used for registered as well as unregistered referees.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invitation</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">RefereeInvitation</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">invitation_id</span><span class="p">)</span>
    <span class="n">invitation</span><span class="o">.</span><span class="n">cancelled</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;invitation&#39;</span><span class="p">:</span> <span class="n">invitation</span><span class="p">})</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_ref_cancellation_email</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">extend_refereeing_deadline</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">reporting_deadline</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">days</span><span class="p">))</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">open_for_commenting</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;EICassigned&#39;</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">set_refereeing_deadline</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SetRefereeingDeadlineForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">reporting_deadline</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;deadline&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;deadline&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">open_for_commenting</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;EICassigned&#39;</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ack_header&#39;</span><span class="p">:</span> <span class="s1">&#39;New reporting deadline set.&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;followup_message&#39;</span><span class="p">:</span> <span class="s1">&#39;Return to the &#39;</span><span class="p">,</span>
                       <span class="s1">&#39;followup_link&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                                                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="o">.</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}),</span>
                       <span class="s1">&#39;followup_link_label&#39;</span><span class="p">:</span> <span class="s1">&#39;Submission</span><span class="se">\&#39;</span><span class="s1">s Editorial Page&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/acknowledgement.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;The set reporting deadline form was improperly filled&#39;</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/error.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="close_refereeing_round"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.close_refereeing_round">[docs]</a><span class="k">def</span> <span class="nf">close_refereeing_round</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by the Editor-in-charge when a satisfactory number of</span>
<span class="sd">    reports have been gathered.</span>
<span class="sd">    Automatically emails the authors to ask them if they want to</span>
<span class="sd">    round off any replies to reports or comments before the</span>
<span class="sd">    editorial recommendation is formulated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">open_for_commenting</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;EICassigned&#39;</span><span class="p">:</span> <span class="c1"># only close if currently undergoing refereeing</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;review_closed&#39;</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">reporting_deadline</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span></div>


<span class="nd">@login_required</span>
<div class="viewcode-block" id="communication"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.communication">[docs]</a><span class="k">def</span> <span class="nf">communication</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">,</span> <span class="n">comtype</span><span class="p">,</span> <span class="n">referee_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Communication between editor-in-charge, author or referee</span>
<span class="sd">    occurring during the submission refereeing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="n">errormessage</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comtype</span> <span class="ow">in</span> <span class="n">ed_comm_choices_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;Unknown type of cummunication.&#39;</span>
    <span class="c1"># TODO: Verify that this is requested by an authorized contributor (eic, ref, author)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">comtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EtoA&#39;</span><span class="p">,</span> <span class="s1">&#39;EtoR&#39;</span><span class="p">,</span> <span class="s1">&#39;EtoS&#39;</span><span class="p">]</span> <span class="ow">and</span>
          <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span> <span class="n">submission</span><span class="p">)):</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;Only the Editor-in-charge can perform this action.&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">comtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AtoE&#39;</span><span class="p">]</span> <span class="ow">and</span>
          <span class="ow">not</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span> <span class="o">==</span> <span class="n">submission</span><span class="o">.</span><span class="n">submitted_by</span><span class="p">)):</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;Only the corresponding author can perform this action.&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">comtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RtoE&#39;</span><span class="p">]</span> <span class="ow">and</span>
          <span class="ow">not</span> <span class="p">(</span><span class="n">RefereeInvitation</span><span class="o">.</span><span class="n">objects</span>
               <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span> <span class="n">referee</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())):</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;Only invited referees for this Submission can perform this action.&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">comtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;StoE&#39;</span><span class="p">]</span> <span class="ow">and</span>
          <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Editorial Administrators&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;Only Editorial Administrators can perform this action.&#39;</span>
    <span class="k">if</span> <span class="n">errormessage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">,</span> <span class="s1">&#39;comtype&#39;</span><span class="p">:</span> <span class="n">comtype</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/communication.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditorialCommunicationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">communication</span> <span class="o">=</span> <span class="n">EditorialCommunication</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                                                   <span class="n">comtype</span><span class="o">=</span><span class="n">comtype</span><span class="p">,</span>
                                                   <span class="n">timestamp</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                                                   <span class="n">text</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">referee_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">referee</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Contributor</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">referee_id</span><span class="p">)</span>
                <span class="n">communication</span><span class="o">.</span><span class="n">referee</span> <span class="o">=</span> <span class="n">referee</span>
            <span class="n">communication</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;communication&#39;</span><span class="p">:</span> <span class="n">communication</span><span class="p">})</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_communication_email</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">comtype</span> <span class="o">==</span> <span class="s1">&#39;EtoA&#39;</span> <span class="ow">or</span> <span class="n">comtype</span> <span class="o">==</span> <span class="s1">&#39;EtoR&#39;</span> <span class="ow">or</span> <span class="n">comtype</span> <span class="o">==</span> <span class="s1">&#39;EtoS&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                                        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span>
            <span class="k">elif</span> <span class="n">comtype</span> <span class="o">==</span> <span class="s1">&#39;AtoE&#39;</span> <span class="ow">or</span> <span class="n">comtype</span> <span class="o">==</span> <span class="s1">&#39;RtoE&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;scipost:personal_page&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">comtype</span> <span class="o">==</span> <span class="s1">&#39;StoE&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:pool&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditorialCommunicationForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span> <span class="s1">&#39;comtype&#39;</span><span class="p">:</span> <span class="n">comtype</span><span class="p">,</span> <span class="s1">&#39;referee_id&#39;</span><span class="p">:</span> <span class="n">referee_id</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/communication.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="nd">@login_required</span>
<span class="nd">@permission_required_or_403</span><span class="p">(</span><span class="s1">&#39;can_take_editorial_actions&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">))</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span> <span class="nf">eic_recommendation</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EICassigned&#39;</span><span class="p">,</span> <span class="s1">&#39;review_closed&#39;</span><span class="p">]:</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;This submission</span><span class="se">\&#39;</span><span class="s1">s current status is: &#39;</span>
                        <span class="o">+</span> <span class="n">submission_status_dict</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span>
                        <span class="s1">&#39;An Editorial Recommendation is not required.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/error.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EICRecommendationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1">#recommendation = form.save()</span>
            <span class="n">recommendation</span> <span class="o">=</span> <span class="n">EICRecommendation</span><span class="p">(</span>
                <span class="n">submission</span> <span class="o">=</span> <span class="n">submission</span><span class="p">,</span>
                <span class="n">date_submitted</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">remarks_for_authors</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;remarks_for_authors&#39;</span><span class="p">],</span>
                <span class="n">requested_changes</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;requested_changes&#39;</span><span class="p">],</span>
                <span class="n">remarks_for_editorial_college</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;remarks_for_editorial_college&#39;</span><span class="p">],</span>
                <span class="n">recommendation</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">],</span>
                <span class="n">voting_deadline</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">recommendation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># If recommendation is to accept or reject,</span>
            <span class="c1"># it is forwarded to the Editorial College for voting</span>
            <span class="c1"># If it is to carry out minor or major revisions,</span>
            <span class="c1"># it is returned to the Author who is asked to resubmit</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="ow">or</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="ow">or</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span> <span class="o">==</span> <span class="mi">3</span>
                <span class="ow">or</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;voting_in_preparation&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                  <span class="ow">or</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;revision_requested&#39;</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span>
                                      <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">recommendation</span><span class="p">})</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_author_revision_requested_email</span><span class="p">()</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">open_for_reporting</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># The EIC has fulfilled this editorial assignment.</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">EditorialAssignment</span><span class="p">,</span>
                                           <span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                                    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EICRecommendationForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span>
               <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/eic_recommendation.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1">###########</span>
<span class="c1"># Reports</span>
<span class="c1">###########</span>

<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_referee&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span> <span class="nf">submit_report</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="p">):</span>
    <span class="n">submission</span> <span class="o">=</span> <span class="n">get_object_or_404</span> <span class="p">(</span><span class="n">Submission</span><span class="p">,</span> <span class="n">arxiv_identifier_w_vn_nr</span><span class="o">=</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">)</span>
    <span class="c1"># Check whether the user can submit a report:</span>
    <span class="n">is_author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">is_author_unchecked</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_author</span>
                           <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">authors_false_claims</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                           <span class="ow">and</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">author_list</span><span class="p">))</span>
    <span class="n">invited</span> <span class="o">=</span> <span class="n">RefereeInvitation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                                               <span class="n">referee</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="n">errormessage</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">invited</span> <span class="ow">and</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">submission</span><span class="o">.</span><span class="n">reporting_deadline</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The reporting deadline has passed. You cannot submit&#39;</span>
                        <span class="s1">&#39; a Report anymore.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_author</span><span class="p">:</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="s1">&#39;You are an author of this Submission and cannot submit a Report.&#39;</span>
    <span class="k">if</span> <span class="n">is_author_unchecked</span><span class="p">:</span>
        <span class="n">errormessage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The system flagged you as a potential author of this Submission. &#39;</span>
                        <span class="s1">&#39;Please go to your personal page under the Submissions tab to clarify this.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errormessage</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errormessage&#39;</span><span class="p">:</span> <span class="n">errormessage</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_report_ack.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReportForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invited</span><span class="p">:</span>
                <span class="n">invitation</span> <span class="o">=</span> <span class="n">RefereeInvitation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                                                           <span class="n">referee</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                <span class="n">invitation</span><span class="o">.</span><span class="n">fulfilled</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">invitation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">flagged</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">referees_flagged</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">referees_flagged</span><span class="p">:</span>
                    <span class="n">flagged</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">newreport</span> <span class="o">=</span> <span class="n">Report</span> <span class="p">(</span>
                <span class="n">submission</span> <span class="o">=</span> <span class="n">submission</span><span class="p">,</span>
                <span class="n">author</span> <span class="o">=</span> <span class="n">author</span><span class="p">,</span>
                <span class="n">invited</span> <span class="o">=</span> <span class="n">invited</span><span class="p">,</span>
                <span class="n">flagged</span> <span class="o">=</span> <span class="n">flagged</span><span class="p">,</span>
                <span class="n">qualification</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;qualification&#39;</span><span class="p">],</span>
                <span class="n">strengths</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;strengths&#39;</span><span class="p">],</span>
                <span class="n">weaknesses</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;weaknesses&#39;</span><span class="p">],</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">],</span>
                <span class="n">requested_changes</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;requested_changes&#39;</span><span class="p">],</span>
                <span class="n">validity</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;validity&#39;</span><span class="p">],</span>
                <span class="n">significance</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;significance&#39;</span><span class="p">],</span>
                <span class="n">originality</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;originality&#39;</span><span class="p">],</span>
                <span class="n">clarity</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;clarity&#39;</span><span class="p">],</span>
                <span class="n">formatting</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;formatting&#39;</span><span class="p">],</span>
                <span class="n">grammar</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;grammar&#39;</span><span class="p">],</span>
                <span class="n">recommendation</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">],</span>
                <span class="n">remarks_for_editors</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;remarks_for_editors&#39;</span><span class="p">],</span>
                <span class="n">anonymous</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;anonymous&#39;</span><span class="p">],</span>
                <span class="n">date_submitted</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="n">newreport</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">author</span><span class="o">.</span><span class="n">nr_reports</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;report&#39;</span><span class="p">:</span> <span class="n">newreport</span><span class="p">})</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">email_EIC_report_delivered</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arxiv_identifier_w_vn_nr</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:submit_report_ack&#39;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReportForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/submit_report.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_take_charge_of_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vet_submitted_reports</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">contributor</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">report_to_vet</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">submission__editor_in_charge</span><span class="o">=</span><span class="n">contributor</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">VetReportForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;contributor&#39;</span><span class="p">:</span> <span class="n">contributor</span><span class="p">,</span> <span class="s1">&#39;report_to_vet&#39;</span><span class="p">:</span> <span class="n">report_to_vet</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span> <span class="p">}</span>
    <span class="k">return</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/vet_submitted_reports.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>


<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_take_charge_of_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span> <span class="nf">vet_submitted_report_ack</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">report_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">VetReportForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">report_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">report</span><span class="o">.</span><span class="n">vetted_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;action_option&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                <span class="c1"># accept the report as is</span>
                <span class="n">report</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">report</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">report</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">latest_activity</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">report</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;action_option&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
                <span class="c1"># the report is simply rejected</span>
                <span class="n">report</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;refusal_reason&#39;</span><span class="p">]</span>
                <span class="n">report</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># email report author</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;report&#39;</span><span class="p">:</span> <span class="n">report</span><span class="p">,</span>
                                  <span class="s1">&#39;email_response&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email_response_field&#39;</span><span class="p">]})</span>
            <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">acknowledge_report_email</span><span class="p">()</span> <span class="c1"># email report author, bcc EIC</span>
            <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_author_report_received_email</span><span class="p">()</span>
    <span class="c1">#context = {&#39;submission&#39;: report.submission}</span>
    <span class="c1">#return render(request, &#39;submissions/vet_submitted_report_ack.html&#39;, context)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ack_header&#39;</span><span class="p">:</span> <span class="s1">&#39;Submitted Report vetted.&#39;</span><span class="p">,</span>
               <span class="s1">&#39;followup_message&#39;</span><span class="p">:</span> <span class="s1">&#39;Return to the &#39;</span><span class="p">,</span>
               <span class="s1">&#39;followup_link&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:editorial_page&#39;</span><span class="p">,</span>
                                        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">arxiv_identifier_w_vn_nr</span><span class="p">}),</span>
               <span class="s1">&#39;followup_link_label&#39;</span><span class="p">:</span> <span class="s1">&#39;Submission</span><span class="se">\&#39;</span><span class="s1">s Editorial Page&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/acknowledgement.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_prepare_recommendations_for_voting&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span> <span class="nf">prepare_for_voting</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">rec_id</span><span class="p">):</span>
    <span class="n">recommendation</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">EICRecommendation</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">rec_id</span><span class="p">)</span>
    <span class="n">Fellows_with_expertise</span> <span class="o">=</span> <span class="n">Contributor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">user__groups__name__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Editorial College&#39;</span><span class="p">],</span>
        <span class="n">expertises__contains</span><span class="o">=</span><span class="p">[</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">subject_area</span><span class="p">])</span>
    <span class="n">coauthorships</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">eligibility_form</span> <span class="o">=</span> <span class="n">VotingEligibilityForm</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
            <span class="n">discipline</span><span class="o">=</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">discipline</span><span class="p">,</span>
            <span class="n">subject_area</span><span class="o">=</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">subject_area</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">eligibility_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">recommendation</span><span class="o">.</span><span class="n">eligible_to_vote</span> <span class="o">=</span> <span class="n">eligibility_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;eligible_Fellows&#39;</span><span class="p">]</span>
            <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_for</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">editor_in_charge</span><span class="p">)</span>
            <span class="n">recommendation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;put_to_EC_voting&#39;</span>
            <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">render</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/acknowledgement.html&#39;</span><span class="p">,</span>
                           <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ack_message&#39;</span><span class="p">:</span> <span class="s1">&#39;We have registered your selection.&#39;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Identify possible co-authorships in last 3 years, disqualifying Fellow from voting:</span>
        <span class="k">if</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">Fellow</span> <span class="ow">in</span> <span class="n">Fellows_with_expertise</span><span class="p">:</span>
                <span class="n">sub_auth_boolean_str</span> <span class="o">=</span> <span class="s1">&#39;((&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span>
                                               <span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                                               <span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">sub_auth_boolean_str</span> <span class="o">+=</span> <span class="s1">&#39;+OR+&#39;</span> <span class="o">+</span> <span class="n">author</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">sub_auth_boolean_str</span> <span class="o">+=</span> <span class="s1">&#39;)+AND+&#39;</span>
                    <span class="n">search_str</span> <span class="o">=</span> <span class="n">sub_auth_boolean_str</span> <span class="o">+</span> <span class="n">Fellow</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                    <span class="n">queryurl</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;http://export.arxiv.org/api/query?search_query=au:</span><span class="si">%s</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="n">search_str</span> <span class="o">+</span> <span class="s1">&#39;&amp;sortBy=submittedDate&amp;sortOrder=descending&#39;</span>
                                <span class="s1">&#39;&amp;max_results=5&#39;</span><span class="p">)</span>
                    <span class="n">arxivquery</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">queryurl</span><span class="p">)</span>
                    <span class="n">queryresults</span> <span class="o">=</span> <span class="n">arxivquery</span>
                    <span class="k">if</span> <span class="n">queryresults</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
                        <span class="n">coauthorships</span><span class="p">[</span><span class="n">Fellow</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">queryresults</span>

        <span class="n">eligibility_form</span> <span class="o">=</span> <span class="n">VotingEligibilityForm</span><span class="p">(</span>
            <span class="n">discipline</span><span class="o">=</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">discipline</span><span class="p">,</span>
            <span class="n">subject_area</span><span class="o">=</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">subject_area</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">recommendation</span><span class="p">,</span>
        <span class="s1">&#39;Fellows_with_expertise&#39;</span><span class="p">:</span> <span class="n">Fellows_with_expertise</span><span class="p">,</span>
        <span class="s1">&#39;coauthorships&#39;</span><span class="p">:</span> <span class="n">coauthorships</span><span class="p">,</span>
        <span class="s1">&#39;eligibility_form&#39;</span><span class="p">:</span> <span class="n">eligibility_form</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissions/prepare_for_voting.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_take_charge_of_submissions&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span> <span class="nf">vote_on_rec</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">rec_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">recommendation</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">EICRecommendation</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">rec_id</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">RecommendationVoteForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;vote&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;agree&#39;</span><span class="p">:</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_for</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_against</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_abstain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;vote&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;disagree&#39;</span><span class="p">:</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_for</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_against</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_abstain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;vote&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;abstain&#39;</span><span class="p">:</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_for</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_against</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
                <span class="n">recommendation</span><span class="o">.</span><span class="n">voted_abstain</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;remark&#39;</span><span class="p">]:</span>
                <span class="n">remark</span> <span class="o">=</span> <span class="n">Remark</span><span class="p">(</span><span class="n">contributor</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">contributor</span><span class="p">,</span>
                                <span class="n">recommendation</span><span class="o">=</span><span class="n">recommendation</span><span class="p">,</span>
                                <span class="n">date</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                                <span class="n">remark</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;remark&#39;</span><span class="p">])</span>
                <span class="n">remark</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">recommendation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:pool&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;submissions:pool&#39;</span><span class="p">))</span>


<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;scipost.can_fix_College_decision&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<div class="viewcode-block" id="fix_College_decision"><a class="viewcode-back" href="../../developers/codebase/modules/views.html#submissions.views.fix_College_decision">[docs]</a><span class="k">def</span> <span class="nf">fix_College_decision</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">rec_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminates the voting on a Recommendation.</span>
<span class="sd">    Called by an Editorial Administrator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recommendation</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">EICRecommendation</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">rec_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Publish as Tier I (top 10%)</span>
        <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;accepted&#39;</span>
    <span class="k">elif</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Publish as Tier II (top 50%)</span>
        <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;accepted&#39;</span>
    <span class="k">elif</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Publish as Tier III (meets criteria)</span>
        <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;accepted&#39;</span>
    <span class="k">elif</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">recommendation</span><span class="o">==-</span><span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Reject</span>
        <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;rejected&#39;</span>
        <span class="n">previous_submissions</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">arxiv_identifier_wo_vn_nr</span><span class="o">=</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">arxiv_identifier_wo_vn_nr</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">previous_submissions</span><span class="p">:</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;resubmitted_rejected&#39;</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">recommendation</span><span class="o">.</span><span class="n">submission</span><span class="p">,</span>
                          <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">recommendation</span><span class="p">})</span>
    <span class="n">SubmissionUtils</span><span class="o">.</span><span class="n">send_author_College_decision_email</span><span class="p">()</span>
    <span class="n">ack_message</span> <span class="o">=</span> <span class="s1">&#39;The Editorial College</span><span class="se">\&#39;</span><span class="s1">s decision has been fixed.&#39;</span>
    <span class="k">return</span> <span class="n">render</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;scipost/acknowledgement.html&#39;</span><span class="p">,</span>
                   <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ack_message&#39;</span><span class="p">:</span> <span class="n">ack_message</span><span class="p">})</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jean-Sbastien Caux.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>