{"parents": [{"title": "Module code", "link": "../../"}], "current_page_name": "_modules/submissions/views", "alabaster_version": "0.7.10", "customsidebar": null, "title": "submissions.views", "sidebars": null, "body": "<h1>Source code for submissions.views</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">__copyright__</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;Copyright 2016-2018, Stichting SciPost (SciPost Foundation)&quot;</span>\n<span class=\"n\">__license__</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;AGPL v3&quot;</span>\n\n\n<span class=\"kn\">import</span> <span class=\"nn\">datetime</span>\n<span class=\"kn\">import</span> <span class=\"nn\">feedparser</span>\n<span class=\"kn\">import</span> <span class=\"nn\">strings</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib</span> <span class=\"k\">import</span> <span class=\"n\">messages</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.auth.decorators</span> <span class=\"k\">import</span> <span class=\"n\">login_required</span><span class=\"p\">,</span> <span class=\"n\">permission_required</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.exceptions</span> <span class=\"k\">import</span> <span class=\"n\">PermissionDenied</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.urlresolvers</span> <span class=\"k\">import</span> <span class=\"n\">reverse</span><span class=\"p\">,</span> <span class=\"n\">reverse_lazy</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"k\">import</span> <span class=\"n\">transaction</span><span class=\"p\">,</span> <span class=\"n\">IntegrityError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"k\">import</span> <span class=\"n\">Q</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.http</span> <span class=\"k\">import</span> <span class=\"n\">Http404</span><span class=\"p\">,</span> <span class=\"n\">HttpResponse</span><span class=\"p\">,</span> <span class=\"n\">HttpResponseRedirect</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.shortcuts</span> <span class=\"k\">import</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">,</span> <span class=\"n\">get_list_or_404</span><span class=\"p\">,</span> <span class=\"n\">render</span><span class=\"p\">,</span> <span class=\"n\">redirect</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.template</span> <span class=\"k\">import</span> <span class=\"n\">Template</span><span class=\"p\">,</span> <span class=\"n\">Context</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"k\">import</span> <span class=\"n\">timezone</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.decorators</span> <span class=\"k\">import</span> <span class=\"n\">method_decorator</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.generic.base</span> <span class=\"k\">import</span> <span class=\"n\">RedirectView</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.generic.detail</span> <span class=\"k\">import</span> <span class=\"n\">SingleObjectMixin</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.generic.edit</span> <span class=\"k\">import</span> <span class=\"n\">CreateView</span><span class=\"p\">,</span> <span class=\"n\">UpdateView</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.generic.list</span> <span class=\"k\">import</span> <span class=\"n\">ListView</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.constants</span> <span class=\"k\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">STATUS_VETTED</span><span class=\"p\">,</span> <span class=\"n\">STATUS_EIC_ASSIGNED</span><span class=\"p\">,</span> <span class=\"n\">SUBMISSION_STATUS</span><span class=\"p\">,</span> <span class=\"n\">STATUS_ASSIGNMENT_FAILED</span><span class=\"p\">,</span>\n    <span class=\"n\">STATUS_DRAFT</span><span class=\"p\">,</span> <span class=\"n\">CYCLE_DIRECT_REC</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.helpers</span> <span class=\"k\">import</span> <span class=\"n\">check_verified_author</span><span class=\"p\">,</span> <span class=\"n\">check_unverified_author</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.models</span> <span class=\"k\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">EICRecommendation</span><span class=\"p\">,</span> <span class=\"n\">EditorialAssignment</span><span class=\"p\">,</span> <span class=\"n\">RefereeInvitation</span><span class=\"p\">,</span> <span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"n\">SubmissionEvent</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.mixins</span> <span class=\"k\">import</span> <span class=\"n\">SubmissionAdminViewMixin</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.forms</span> <span class=\"k\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">SubmissionIdentifierForm</span><span class=\"p\">,</span> <span class=\"n\">RequestSubmissionForm</span><span class=\"p\">,</span> <span class=\"n\">SubmissionSearchForm</span><span class=\"p\">,</span> <span class=\"n\">RecommendationVoteForm</span><span class=\"p\">,</span>\n    <span class=\"n\">ConsiderAssignmentForm</span><span class=\"p\">,</span> <span class=\"n\">InviteEditorialAssignmentForm</span><span class=\"p\">,</span> <span class=\"n\">EditorialAssignmentForm</span><span class=\"p\">,</span> <span class=\"n\">VetReportForm</span><span class=\"p\">,</span>\n    <span class=\"n\">SetRefereeingDeadlineForm</span><span class=\"p\">,</span> <span class=\"n\">RefereeSelectForm</span><span class=\"p\">,</span> <span class=\"n\">iThenticateReportForm</span><span class=\"p\">,</span> <span class=\"n\">VotingEligibilityForm</span><span class=\"p\">,</span>\n    <span class=\"n\">RefereeRecruitmentForm</span><span class=\"p\">,</span> <span class=\"n\">ConsiderRefereeInvitationForm</span><span class=\"p\">,</span> <span class=\"n\">EditorialCommunicationForm</span><span class=\"p\">,</span> <span class=\"n\">ReportForm</span><span class=\"p\">,</span>\n    <span class=\"n\">SubmissionCycleChoiceForm</span><span class=\"p\">,</span> <span class=\"n\">ReportPDFForm</span><span class=\"p\">,</span> <span class=\"n\">SubmissionReportsForm</span><span class=\"p\">,</span> <span class=\"n\">EICRecommendationForm</span><span class=\"p\">,</span>\n    <span class=\"n\">SubmissionPoolFilterForm</span><span class=\"p\">,</span> <span class=\"n\">FixCollegeDecisionForm</span><span class=\"p\">,</span> <span class=\"n\">SubmissionPrescreeningForm</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.utils</span> <span class=\"k\">import</span> <span class=\"n\">SubmissionUtils</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">colleges.permissions</span> <span class=\"k\">import</span> <span class=\"n\">fellowship_required</span><span class=\"p\">,</span> <span class=\"n\">fellowship_or_admin_required</span>\n<span class=\"kn\">from</span> <span class=\"nn\">comments.forms</span> <span class=\"k\">import</span> <span class=\"n\">CommentForm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">journals.models</span> <span class=\"k\">import</span> <span class=\"n\">Journal</span>\n<span class=\"kn\">from</span> <span class=\"nn\">mails.views</span> <span class=\"k\">import</span> <span class=\"n\">MailEditingSubView</span>\n<span class=\"kn\">from</span> <span class=\"nn\">production.forms</span> <span class=\"k\">import</span> <span class=\"n\">ProofsDecisionForm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">scipost.forms</span> <span class=\"k\">import</span> <span class=\"n\">RemarkForm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">scipost.mixins</span> <span class=\"k\">import</span> <span class=\"n\">PaginationMixin</span>\n<span class=\"kn\">from</span> <span class=\"nn\">scipost.models</span> <span class=\"k\">import</span> <span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"n\">Remark</span>\n\n\n<span class=\"c1\">###############</span>\n<span class=\"c1\"># SUBMISSIONS:</span>\n<span class=\"c1\">###############</span>\n\n<span class=\"nd\">@method_decorator</span><span class=\"p\">(</span><span class=\"n\">login_required</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s1\">&#39;dispatch&#39;</span><span class=\"p\">)</span>\n<span class=\"nd\">@method_decorator</span><span class=\"p\">(</span><span class=\"n\">permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_submit_manuscript&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">),</span>\n                  <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s1\">&#39;dispatch&#39;</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"RequestSubmission\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.RequestSubmission\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">RequestSubmission</span><span class=\"p\">(</span><span class=\"n\">CreateView</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Formview to submit a new manuscript (Submission).&quot;&quot;&quot;</span>\n\n    <span class=\"n\">success_url</span> <span class=\"o\">=</span> <span class=\"n\">reverse_lazy</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">form_class</span> <span class=\"o\">=</span> <span class=\"n\">RequestSubmissionForm</span>\n    <span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;submissions/submission_form.html&#39;</span>\n\n<div class=\"viewcode-block\" id=\"RequestSubmission.get\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.RequestSubmission.get\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Redirect to the arXiv prefill form if arXiv ID is not known.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:prefill_using_identifier&#39;</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"RequestSubmission.get_form_kwargs\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.RequestSubmission.get_form_kwargs\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_form_kwargs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Form requires extra kwargs.&quot;&quot;&quot;</span>\n        <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_form_kwargs</span><span class=\"p\">()</span>\n        <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;requested_by&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span>\n        <span class=\"k\">return</span> <span class=\"n\">kwargs</span></div>\n\n    <span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"RequestSubmission.form_valid\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.RequestSubmission.form_valid\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">form_valid</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Redirect and send out mails if all data is valid.&quot;&quot;&quot;</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_general_event</span><span class=\"p\">(</span><span class=\"s1\">&#39;The manuscript has been submitted to </span><span class=\"si\">%s</span><span class=\"s1\">.&#39;</span>\n                                     <span class=\"o\">%</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_submitted_to_journal_display</span><span class=\"p\">())</span>\n\n        <span class=\"n\">text</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;Thank you for your Submission to SciPost&lt;/h3&gt;&#39;</span>\n                <span class=\"s1\">&#39;Your Submission will soon be handled by an Editor.&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">submission_is_resubmission</span><span class=\"p\">():</span>\n            <span class=\"c1\"># Send emails</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">},</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">)</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_authors_resubmission_ack_email</span><span class=\"p\">()</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_EIC_reappointment_email</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Send emails</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">})</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_authors_submission_ack_email</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">HttpResponseRedirect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">success_url</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"RequestSubmission.form_invalid\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.RequestSubmission.form_invalid\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">form_invalid</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Add warnings as messages to make those more explicit.&quot;&quot;&quot;</span>\n        <span class=\"k\">for</span> <span class=\"n\">error_messages</span> <span class=\"ow\">in</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">():</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">error_messages</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">form_invalid</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">)</span></div></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_submit_manuscript&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"prefill_using_arxiv_identifier\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.prefill_using_arxiv_identifier\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">prefill_using_arxiv_identifier</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Form view asking for the arXiv ID related to the new Submission to submit.&quot;&quot;&quot;</span>\n    <span class=\"n\">query_form</span> <span class=\"o\">=</span> <span class=\"n\">SubmissionIdentifierForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n                                          <span class=\"n\">requested_by</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">query_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">prefill_data</span> <span class=\"o\">=</span> <span class=\"n\">query_form</span><span class=\"o\">.</span><span class=\"n\">request_arxiv_preprint_form_prefill_data</span><span class=\"p\">()</span>\n        <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">RequestSubmissionForm</span><span class=\"p\">(</span><span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">prefill_data</span><span class=\"p\">,</span> <span class=\"n\">requested_by</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Submit message to user</span>\n        <span class=\"k\">if</span> <span class=\"n\">query_form</span><span class=\"o\">.</span><span class=\"n\">submission_is_resubmission</span><span class=\"p\">():</span>\n            <span class=\"n\">resubmessage</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;There already exists a preprint with this arXiv identifier &#39;</span>\n                            <span class=\"s1\">&#39;but a different version number. </span><span class=\"se\">\\n</span><span class=\"s1\">Your Submission will be &#39;</span>\n                            <span class=\"s1\">&#39;handled as a resubmission.&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">resubmessage</span><span class=\"p\">,</span> <span class=\"n\">fail_silently</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">strings</span><span class=\"o\">.</span><span class=\"n\">acknowledge_arxiv_query</span><span class=\"p\">,</span> <span class=\"n\">fail_silently</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/submission_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">query_form</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/submission_prefill_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"SubmissionListView\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.SubmissionListView\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SubmissionListView</span><span class=\"p\">(</span><span class=\"n\">PaginationMixin</span><span class=\"p\">,</span> <span class=\"n\">ListView</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List all publicly available Submissions.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">SubmissionSearchForm</span>\n    <span class=\"n\">submission_search_list</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"n\">paginate_by</span> <span class=\"o\">=</span> <span class=\"mi\">10</span>\n\n<div class=\"viewcode-block\" id=\"SubmissionListView.get_queryset\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.SubmissionListView.get_queryset\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_queryset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return queryset, filtered with GET request data if given.&quot;&quot;&quot;</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">public_newest</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"s1\">&#39;to_journal&#39;</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">:</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n                <span class=\"n\">latest_activity__gte</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timedelta</span><span class=\"p\">(</span><span class=\"n\">days</span><span class=\"o\">=-</span><span class=\"mi\">60</span><span class=\"p\">),</span>\n                <span class=\"n\">submitted_to_journal</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;to_journal&#39;</span><span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"s1\">&#39;discipline&#39;</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span> <span class=\"ow\">and</span> <span class=\"s1\">&#39;nrweeksback&#39;</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span><span class=\"p\">:</span>\n            <span class=\"n\">discipline</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;discipline&#39;</span><span class=\"p\">]</span>\n            <span class=\"n\">nrweeksback</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;nrweeksback&#39;</span><span class=\"p\">]</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n                <span class=\"n\">discipline</span><span class=\"o\">=</span><span class=\"n\">discipline</span><span class=\"p\">,</span>\n                <span class=\"n\">latest_activity__gte</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timedelta</span><span class=\"p\">(</span><span class=\"n\">weeks</span><span class=\"o\">=-</span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">nrweeksback</span><span class=\"p\">))</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">()</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">has_changed</span><span class=\"p\">():</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">search_results</span><span class=\"p\">()</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-submission_date&#39;</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SubmissionListView.get_context_data\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.SubmissionListView.get_context_data\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_context_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Save data related to GET request if found.&quot;&quot;&quot;</span>\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_context_data</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Form into the context!</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span>\n\n        <span class=\"c1\"># To customize display in the template</span>\n        <span class=\"k\">if</span> <span class=\"s1\">&#39;to_journal&#39;</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;to_journal&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Journal</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n                    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;to_journal&#39;</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_name_display</span><span class=\"p\">()</span>\n            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">,</span> <span class=\"ne\">AttributeError</span><span class=\"p\">):</span>\n                <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;to_journal&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;to_journal&#39;</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"s1\">&#39;discipline&#39;</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span><span class=\"p\">:</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;discipline&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;discipline&#39;</span><span class=\"p\">]</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nrweeksback&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;nrweeksback&#39;</span><span class=\"p\">]</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;browse&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">()</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">has_changed</span><span class=\"p\">():</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;recent&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">context</span></div></div>\n\n\n<div class=\"viewcode-block\" id=\"submission_detail_wo_vn_nr\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.submission_detail_wo_vn_nr\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">submission_detail_wo_vn_nr</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_wo_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Redirect to the latest Submission&#39;s detail page.&quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_wo_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_wo_vn_nr</span><span class=\"p\">,</span>\n                                   <span class=\"n\">is_current</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">submission_detail</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"submission_detail\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.submission_detail\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">submission_detail</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Public detail page of Submission.&quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;can_read_editorial_information&#39;</span><span class=\"p\">:</span> <span class=\"kc\">False</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"c1\"># Check if Contributor is author of the Submission</span>\n    <span class=\"n\">is_author</span> <span class=\"o\">=</span> <span class=\"n\">check_verified_author</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">is_author_unchecked</span> <span class=\"o\">=</span> <span class=\"n\">check_unverified_author</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">visible_public</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">is_author</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_authenticated</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perm</span><span class=\"p\">(</span>\n            <span class=\"s1\">&#39;scipost.can_assign_submissions&#39;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">fellows</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n                <span class=\"n\">contributor__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n                    <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">is_author</span><span class=\"p\">:</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;proofs_decision_form&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">ProofsDecisionForm</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">open_for_commenting</span> <span class=\"ow\">and</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perms</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_submit_comments&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;comment_form&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">CommentForm</span><span class=\"p\">()</span>\n\n    <span class=\"n\">invited_reports</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reports</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">invited</span><span class=\"p\">()</span>\n    <span class=\"n\">contributed_reports</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reports</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">contributed</span><span class=\"p\">()</span>\n    <span class=\"n\">comments</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">comments</span><span class=\"o\">.</span><span class=\"n\">vetted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">regular_comments</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date_submitted&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">author_replies</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">comments</span><span class=\"o\">.</span><span class=\"n\">vetted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">author_replies</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date_submitted&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># User is referee for the Submission</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_authenticated</span><span class=\"p\">:</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;unfinished_report_for_user&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reports</span><span class=\"o\">.</span><span class=\"n\">in_draft</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">author__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;invitations&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">referee_invitations</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">referee__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">is_author</span> <span class=\"ow\">or</span> <span class=\"n\">is_author_unchecked</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Authors are not allowed to read all editorial info! Whatever</span>\n            <span class=\"c1\"># their permission level is.</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;can_read_editorial_information&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># User may read eg. Editorial Recommendations if he/she is in the Pool.</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;can_read_editorial_information&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">fellows</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n                <span class=\"n\">contributor__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span>\n\n            <span class=\"c1\"># User may also read eg. Editorial Recommendations if he/she is editorial administrator.</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;can_read_editorial_information&#39;</span><span class=\"p\">]:</span>\n                <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;can_read_editorial_information&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perm</span><span class=\"p\">(</span>\n                    <span class=\"s1\">&#39;can_oversee_refereeing&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"s1\">&#39;invitations&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">context</span> <span class=\"ow\">and</span> <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;invitations&#39;</span><span class=\"p\">]:</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;communication&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editorial_communications</span><span class=\"o\">.</span><span class=\"n\">for_referees</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">referee__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n\n    <span class=\"n\">recommendations</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">eicrecommendations</span><span class=\"o\">.</span><span class=\"n\">active</span><span class=\"p\">()</span>\n\n    <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">({</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;recommendations&#39;</span><span class=\"p\">:</span> <span class=\"n\">recommendations</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;comments&#39;</span><span class=\"p\">:</span> <span class=\"n\">comments</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;invited_reports&#39;</span><span class=\"p\">:</span> <span class=\"n\">invited_reports</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;contributed_reports&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributed_reports</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;author_replies&#39;</span><span class=\"p\">:</span> <span class=\"n\">author_replies</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;is_author&#39;</span><span class=\"p\">:</span> <span class=\"n\">is_author</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;is_author_unchecked&#39;</span><span class=\"p\">:</span> <span class=\"n\">is_author_unchecked</span><span class=\"p\">,</span>\n    <span class=\"p\">})</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/submission_detail.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"report_attachment\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.report_attachment\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">report_attachment</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">report_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Download the attachment of a Report if available.&quot;&quot;&quot;</span>\n    <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span>\n        <span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"n\">submission__arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span>\n        <span class=\"n\">file_attachment__isnull</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">report_nr</span><span class=\"o\">=</span><span class=\"n\">report_nr</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">is_vetted</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Only Admins and EICs are allowed to see non-vetted Report attachments.</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span>\n            <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n            <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">HttpResponse</span><span class=\"p\">(</span><span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">file_attachment</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(),</span> <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"s1\">&#39;application/pdf&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"si\">{}</span><span class=\"s1\">_report_attachment-</span><span class=\"si\">{}</span><span class=\"s1\">.pdf&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n        <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span>\n        <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">report_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span><span class=\"p\">[</span><span class=\"s1\">&#39;Content-Disposition&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;filename=&#39;</span> <span class=\"o\">+</span> <span class=\"n\">filename</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">response</span></div>\n\n\n<div class=\"viewcode-block\" id=\"report_detail_pdf\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.report_detail_pdf\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">report_detail_pdf</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">report_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Download the PDF of a Report if available.&quot;&quot;&quot;</span>\n    <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">(),</span>\n                               <span class=\"n\">submission__arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span>\n                               <span class=\"n\">pdf_report__isnull</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">report_nr</span><span class=\"o\">=</span><span class=\"n\">report_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">HttpResponse</span><span class=\"p\">(</span><span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">pdf_report</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(),</span> <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"s1\">&#39;application/pdf&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"si\">%s</span><span class=\"s1\">_report-</span><span class=\"si\">%i</span><span class=\"s1\">.pdf&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">report_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span><span class=\"p\">[</span><span class=\"s1\">&#39;Content-Disposition&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;filename=&#39;</span> <span class=\"o\">+</span> <span class=\"n\">filename</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">response</span></div>\n\n\n<div class=\"viewcode-block\" id=\"submission_refereeing_package_pdf\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.submission_refereeing_package_pdf\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">submission_refereeing_package_pdf</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Down the refereeing package PDF.</span>\n\n<span class=\"sd\">    This view let&#39;s the user download all Report PDF&#39;s in a single merged PDF.</span>\n<span class=\"sd\">    The merging takes places every time its downloaded to make sure all available report PDF&#39;s</span>\n<span class=\"sd\">    are included and the EdColAdmin doesn&#39;t have to compile the package every time again.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">public</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">pdf_refereeing_pack</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">HttpResponse</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">pdf_refereeing_pack</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(),</span> <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"s1\">&#39;application/pdf&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"si\">%s</span><span class=\"s1\">-refereeing-package.pdf&#39;</span> <span class=\"o\">%</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span>\n    <span class=\"n\">response</span><span class=\"p\">[</span><span class=\"s1\">&#39;Content-Disposition&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;filename=&#39;</span> <span class=\"o\">+</span> <span class=\"n\">filename</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">response</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_manage_reports&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"reports_accepted_list\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.reports_accepted_list\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">reports_accepted_list</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List all accepted Reports.</span>\n\n<span class=\"sd\">    This gives an overview of Report that need a PDF update/compilation.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">reports</span> <span class=\"o\">=</span> <span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span>\n        <span class=\"s1\">&#39;pdf_report&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">prefetch_related</span><span class=\"p\">(</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">reports</span> <span class=\"o\">=</span> <span class=\"n\">reports</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">submission__arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;reports&#39;</span><span class=\"p\">:</span> <span class=\"n\">reports</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/admin/report_list.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_manage_reports&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"report_pdf_compile\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.report_pdf_compile\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">report_pdf_compile</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">report_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Form view to receive a auto-generated LaTeX code and submit a pdf version of the Report.&quot;&quot;&quot;</span>\n    <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">report_id</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">ReportPDFForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">report</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Upload complete.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:reports_accepted_list&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span> <span class=\"n\">report</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/admin/report_compile_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_manage_reports&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"treated_submissions_list\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.treated_submissions_list\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">treated_submissions_list</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List all treated Submissions.</span>\n\n<span class=\"sd\">    This gives an overview of Submissions that need a PDF update/compilation of their Reports.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">treated</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">public</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span>\n        <span class=\"s1\">&#39;pdf_refereeing_pack&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-acceptance_date&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submissions&#39;</span><span class=\"p\">:</span> <span class=\"n\">submissions</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/treated_submission_list.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_manage_reports&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"treated_submission_pdf_compile\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.treated_submission_pdf_compile\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">treated_submission_pdf_compile</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Form view to receive a auto-generated LaTeX code and submit a pdf version of the Reports.&quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">treated</span><span class=\"p\">(),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">SubmissionReportsForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Upload complete.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:treated_submissions_list&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/treated_submission_pdf_compile.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"c1\">######################</span>\n<span class=\"c1\"># Editorial workflow #</span>\n<span class=\"c1\">######################</span>\n\n<div class=\"viewcode-block\" id=\"editorial_workflow\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.editorial_workflow\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">editorial_workflow</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Information page for Editorial Fellows.</span>\n\n<span class=\"sd\">    Summary page for Editorial Fellows, containing a digest</span>\n<span class=\"sd\">    of the actions to take to handle Submissions.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/editorial_workflow.html&#39;</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"pool\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.pool\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">pool</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List page of Submissions in refereeing.</span>\n\n<span class=\"sd\">    The Submissions pool contains all submissions which are undergoing</span>\n<span class=\"sd\">    the editorial process, from submission</span>\n<span class=\"sd\">    to publication acceptance or rejection.</span>\n<span class=\"sd\">    All members of the Editorial College have access.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># Search</span>\n    <span class=\"n\">search_form</span> <span class=\"o\">=</span> <span class=\"n\">SubmissionPoolFilterForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">search_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">search_form</span><span class=\"o\">.</span><span class=\"n\">search</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">(),</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Mainly as fallback for the old-pool while in test phase.</span>\n        <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n\n    <span class=\"n\">recs_to_vote_on</span> <span class=\"o\">=</span> <span class=\"n\">EICRecommendation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">user_must_vote_on</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">)</span>\n    <span class=\"n\">assignments_to_consider</span> <span class=\"o\">=</span> <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">to</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Forms</span>\n    <span class=\"n\">consider_assignment_form</span> <span class=\"o\">=</span> <span class=\"n\">ConsiderAssignmentForm</span><span class=\"p\">()</span>\n    <span class=\"n\">rec_vote_form</span> <span class=\"o\">=</span> <span class=\"n\">RecommendationVoteForm</span><span class=\"p\">()</span>\n    <span class=\"n\">remark_form</span> <span class=\"o\">=</span> <span class=\"n\">RemarkForm</span><span class=\"p\">()</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submissions&#39;</span><span class=\"p\">:</span> <span class=\"n\">submissions</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-submission_date&#39;</span><span class=\"p\">),</span>\n        <span class=\"s1\">&#39;search_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">search_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;submission_status&#39;</span><span class=\"p\">:</span> <span class=\"n\">SUBMISSION_STATUS</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;assignments_to_consider&#39;</span><span class=\"p\">:</span> <span class=\"n\">assignments_to_consider</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;consider_assignment_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">consider_assignment_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;recs_to_vote_on&#39;</span><span class=\"p\">:</span> <span class=\"n\">recs_to_vote_on</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;rec_vote_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">rec_vote_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;remark_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">remark_form</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"c1\"># Show specific submission in the pool</span>\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">if</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">:</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n                <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"k\">pass</span>\n\n    <span class=\"c1\"># EdColAdmin related variables</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_oversee_refereeing&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;recommendations&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">EICRecommendation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">active</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">)</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;latest_submission_events&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">SubmissionEvent</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">for_eic</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">last_hours</span><span class=\"p\">()</span>\\\n            <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;submissions&#39;</span><span class=\"p\">])</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_run_pre_screening&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;pre_screening_subs&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">prescreening</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># Pool gets Submission details via ajax request</span>\n    <span class=\"k\">if</span> <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">]</span> <span class=\"ow\">and</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">is_ajax</span><span class=\"p\">():</span>\n        <span class=\"n\">template</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;partials/submissions/pool/submission_details.html&#39;</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">template</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;submissions/pool/pool.html&#39;</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">template</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"add_remark\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.add_remark\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">add_remark</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Form view to add a Remark to a Submission.</span>\n\n<span class=\"sd\">    With this method, an Editorial Fellow or Board Member</span>\n<span class=\"sd\">    is adding a remark on a Submission.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">remark_form</span> <span class=\"o\">=</span> <span class=\"n\">RemarkForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">remark_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">remark</span> <span class=\"o\">=</span> <span class=\"n\">Remark</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">,</span>\n                        <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">,</span>\n                        <span class=\"n\">date</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n                        <span class=\"n\">remark</span><span class=\"o\">=</span><span class=\"n\">remark_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;remark&#39;</span><span class=\"p\">])</span>\n        <span class=\"n\">remark</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Your remark has succesfully been posted&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;The form was invalidly filled.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,)))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_assign_submissions&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"assign_submission\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.assign_submission\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">assign_submission</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Assign Editor-in-charge to Submission.</span>\n\n<span class=\"sd\">    Action done by SciPost Administration or Editorial College Administration.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">InviteEditorialAssignmentForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">ed_assignment</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;assignment&#39;</span><span class=\"p\">:</span> <span class=\"n\">ed_assignment</span><span class=\"p\">})</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_assignment_request_email</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Your assignment request has been sent successfully.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submission_to_assign&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;flag&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">fellows_with_expertise</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">fellows</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;coauthorships&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">flag_coauthorships_arxiv</span><span class=\"p\">(</span><span class=\"n\">fellows_with_expertise</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/admin/editorial_assignment_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"editorial_assignment\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.editorial_assignment\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">editorial_assignment</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">assignment_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Editorial Assignment form view.&quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Check if Submission is still valid for a new assignment.</span>\n    <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span>\n            <span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;</span><span class=\"si\">{}</span><span class=\"s1\"> </span><span class=\"si\">{}</span><span class=\"s1\"> has already agreed to be Editor-in-charge of this Submission.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span><span class=\"o\">.</span><span class=\"n\">get_title_display</span><span class=\"p\">(),</span>\n                <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">STATUS_ASSIGNMENT_FAILED</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span>\n            <span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Thank you for considering.&#39;</span>\n                      <span class=\"s1\">&#39; This Submission has failed pre-screening and has been rejected.&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">assignment_id</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Process existing EditorialAssignment.</span>\n        <span class=\"n\">assignment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editorial_assignments</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(),</span> <span class=\"n\">to</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">assignment_id</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Get or create EditorialAssignment for user.</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">assignment</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editorial_assignments</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n                <span class=\"n\">to__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span> <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"n\">assignment</span> <span class=\"o\">=</span> <span class=\"n\">EditorialAssignment</span><span class=\"p\">()</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">EditorialAssignmentForm</span><span class=\"p\">(</span>\n        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">assignment</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">assignment</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">has_accepted_invite</span><span class=\"p\">():</span>\n            <span class=\"c1\"># Fellow accepted to do a normal refereeing cycle.</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;assignment&#39;</span><span class=\"p\">:</span> <span class=\"n\">assignment</span><span class=\"p\">})</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_EIC_appointment_email</span><span class=\"p\">()</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_normal_cycle</span><span class=\"p\">():</span>\n                <span class=\"c1\"># Inform authors about new status.</span>\n                <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_author_prescreening_passed_email</span><span class=\"p\">()</span>\n\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_general_event</span><span class=\"p\">(</span><span class=\"s1\">&#39;The Editor-in-charge has been assigned.&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Thank you for becoming Editor-in-charge of this submission.&#39;</span>\n            <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Fellow declined the invitation.</span>\n            <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Thank you for considering&#39;</span>\n            <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Form submitted; redirect user</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;assignment&#39;</span><span class=\"p\">:</span> <span class=\"n\">assignment</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/pool/editorial_assignment.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"assignment_request\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.assignment_request\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">assignment_request</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">assignment_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Redirect to Editorial Assignment form view.</span>\n\n<span class=\"sd\">    Exists for historical reasons; email are send with this url construction.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">assignment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(),</span>\n                                   <span class=\"n\">to</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">assignment_id</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_assignment&#39;</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span>\n        <span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">assignment</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;assignment_id&#39;</span><span class=\"p\">:</span> <span class=\"n\">assignment</span><span class=\"o\">.</span><span class=\"n\">id</span>\n    <span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"volunteer_as_EIC\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.volunteer_as_EIC\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">volunteer_as_EIC</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Single click action to take charge of a Submission.</span>\n\n<span class=\"sd\">    Called when a Fellow volunteers while perusing the submissions pool.</span>\n<span class=\"sd\">    This is an adapted version of the assignment_request method.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">STATUS_ASSIGNMENT_FAILED</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&lt;h3&gt;Thank you for considering.&lt;/h3&gt;&#39;</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;This Submission has failed pre-screening and has been rejected.&#39;</span>\n    <span class=\"k\">elif</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&lt;h3&gt;Thank you for considering.&lt;/h3&gt;&#39;</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">+=</span> <span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span><span class=\"o\">.</span><span class=\"n\">get_title_display</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"s1\">&#39; &#39;</span> <span class=\"o\">+</span>\n                         <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span> <span class=\"o\">+</span>\n                         <span class=\"s1\">&#39; has already agreed to be Editor-in-charge of this Submission.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"s1\">&#39;You do not have an activated Contributor account. Therefore, you cannot take charge.&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">errormessage</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">errormessage</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">))</span>\n\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"c1\"># The Contributor may already have an EditorialAssignment due to an earlier invitation.</span>\n    <span class=\"n\">assignment</span><span class=\"p\">,</span> <span class=\"n\">__</span> <span class=\"o\">=</span> <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get_or_create</span><span class=\"p\">(</span>\n        <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"n\">to</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n    <span class=\"c1\"># Explicitly update afterwards, since update_or_create does not properly do the job.</span>\n    <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">assignment</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span>\n        <span class=\"n\">accepted</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">date_answered</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">())</span>\n\n    <span class=\"c1\"># Set deadlines</span>\n    <span class=\"n\">deadline</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timedelta</span><span class=\"p\">(</span><span class=\"n\">days</span><span class=\"o\">=</span><span class=\"mi\">28</span><span class=\"p\">)</span>  <span class=\"c1\"># for papers</span>\n    <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">submitted_to_journal</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;SciPostPhysLectNotes&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">deadline</span> <span class=\"o\">+=</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timedelta</span><span class=\"p\">(</span><span class=\"n\">days</span><span class=\"o\">=</span><span class=\"mi\">28</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Update Submission data</span>\n    <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span>\n        <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">STATUS_EIC_ASSIGNED</span><span class=\"p\">,</span>\n        <span class=\"n\">editor_in_charge</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span>\n        <span class=\"n\">open_for_reporting</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">reporting_deadline</span><span class=\"o\">=</span><span class=\"n\">deadline</span><span class=\"p\">,</span>\n        <span class=\"n\">open_for_commenting</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">latest_activity</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">())</span>\n\n    <span class=\"c1\"># Deprecate old Editorial Assignments</span>\n    <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">deprecated</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Send emails to EIC and authors regarding the EIC assignment.</span>\n    <span class=\"n\">assignment</span> <span class=\"o\">=</span> <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">assignment</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span>  <span class=\"c1\"># Update before use in mail</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;assignment&#39;</span><span class=\"p\">:</span> <span class=\"n\">assignment</span><span class=\"p\">})</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_EIC_appointment_email</span><span class=\"p\">()</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_author_prescreening_passed_email</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># Add SubmissionEvents</span>\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_general_event</span><span class=\"p\">(</span><span class=\"s1\">&#39;The Editor-in-charge has been assigned.&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Thank you for becoming Editor-in-charge of this submission.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">]))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_assign_submissions&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"assignment_failed\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.assignment_failed\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">assignment_failed</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Reject a Submission in pre-screening.</span>\n\n<span class=\"sd\">    No Editorial Fellow has accepted or volunteered to become Editor-in-charge., hence the</span>\n<span class=\"sd\">    Submission is rejected. An Editorial Administrator can access this view from the Pool.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">unassigned</span><span class=\"p\">(),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">mail_request</span> <span class=\"o\">=</span> <span class=\"n\">MailEditingSubView</span><span class=\"p\">(</span>\n        <span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;submissions_assignment_failed&#39;</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"n\">header_template</span><span class=\"o\">=</span><span class=\"s1\">&#39;partials/submissions/admin/editorial_assignment_failed.html&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"c1\"># Deprecate old Editorial Assignments</span>\n        <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">deprecated</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Update status of Submission</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">touch</span><span class=\"p\">()</span>\n        <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span>\n            <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">STATUS_ASSIGNMENT_FAILED</span><span class=\"p\">,</span> <span class=\"n\">visible_pool</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">visible_public</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span>\n            <span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Submission </span><span class=\"si\">{arxiv}</span><span class=\"s1\"> has failed pre-screening and been rejected.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">arxiv</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">))</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Authors have been informed by email.&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">return_render</span><span class=\"p\">()</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"assignments\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.assignments\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">assignments</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List editorial tasks for a Fellow.</span>\n\n<span class=\"sd\">    This page provides a Fellow with an explicit task list</span>\n<span class=\"sd\">    of editorial actions which should be undertaken.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">assignments</span> <span class=\"o\">=</span> <span class=\"n\">EditorialAssignment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">to</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date_created&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">assignments_to_consider</span> <span class=\"o\">=</span> <span class=\"n\">assignments</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span>\n    <span class=\"n\">current_assignments</span> <span class=\"o\">=</span> <span class=\"n\">assignments</span><span class=\"o\">.</span><span class=\"n\">ongoing</span><span class=\"p\">()</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;assignments_to_consider&#39;</span><span class=\"p\">:</span> <span class=\"n\">assignments_to_consider</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;current_assignments&#39;</span><span class=\"p\">:</span> <span class=\"n\">current_assignments</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/pool/assignments.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"editorial_page\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.editorial_page\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">editorial_page</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Detail page of a Submission its editorial tasks.</span>\n\n<span class=\"sd\">    The central page for the Editor-in-charge to manage all its Editorial duties. It&#39;s accessible</span>\n<span class=\"sd\">    for both the Editor-in-charge of the Submission and the Editorial Administration.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">full_access</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_oversee_refereeing&#39;</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Administrators will be able to see all Submissions</span>\n        <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span> <span class=\"o\">!=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">:</span>\n            <span class=\"c1\"># The current user is not EIC of the Submission!</span>\n            <span class=\"n\">full_access</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">voting_fellows</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">contributor__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n                <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;set_deadline_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">SetRefereeingDeadlineForm</span><span class=\"p\">(),</span>\n        <span class=\"s1\">&#39;cycle_choice_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">SubmissionCycleChoiceForm</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">),</span>\n        <span class=\"s1\">&#39;full_access&#39;</span><span class=\"p\">:</span> <span class=\"n\">full_access</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/pool/editorial_page.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"cycle_form_submit\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.cycle_form_submit\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">cycle_form_submit</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Form view to choose refereeing cycle.</span>\n\n<span class=\"sd\">    If Submission is `resubmission_incoming` the EIC should first choose what refereeing</span>\n<span class=\"sd\">    cycle to choose.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">SubmissionCycleChoiceForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">cycle</span><span class=\"o\">.</span><span class=\"n\">update_status</span><span class=\"p\">()</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">cycle</span><span class=\"o\">.</span><span class=\"n\">update_deadline</span><span class=\"p\">()</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">cycle</span><span class=\"o\">.</span><span class=\"n\">reinvite_referees</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;referees_reinvite&#39;</span><span class=\"p\">],</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;Your choice has been confirmed&lt;/h3&gt;&#39;</span>\n                                   <span class=\"s1\">&#39;The new cycle will be &lt;em&gt;</span><span class=\"si\">%s</span><span class=\"s1\">&lt;/em&gt;&#39;</span>\n                                   <span class=\"o\">%</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_refereeing_cycle_display</span><span class=\"p\">()))</span>\n        <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">refereeing_cycle</span> <span class=\"o\">==</span> <span class=\"n\">CYCLE_DIRECT_REC</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Redirect to EIC Recommendation page immediately</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:eic_recommendation&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">]))</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span>\n        <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">]))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"select_referee\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.select_referee\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">select_referee</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Invite scientist to referee a Submission.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration.</span>\n<span class=\"sd\">    It&#39;ll list possible already registered Contributors that match the search. If the scientist</span>\n<span class=\"sd\">    is not yet registered, he will be invited using a RegistrationInvitation as well. In</span>\n<span class=\"sd\">    addition the page will show possible conflicts of interests, with that information</span>\n<span class=\"sd\">    coming from the ArXiv API.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"n\">queryresults</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span>\n    <span class=\"n\">ref_search_form</span> <span class=\"o\">=</span> <span class=\"n\">RefereeSelectForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">ref_search_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">contributors_found</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">user__last_name__icontains</span><span class=\"o\">=</span><span class=\"n\">ref_search_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;last_name&#39;</span><span class=\"p\">])</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;contributors_found&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributors_found</span>\n\n        <span class=\"c1\"># Check for recent co-authorship (thus referee disqualification)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">sub_auth_boolean_str</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;((&#39;</span> <span class=\"o\">+</span> <span class=\"p\">(</span><span class=\"n\">submission</span>\n                                           <span class=\"o\">.</span><span class=\"n\">metadata</span><span class=\"p\">[</span><span class=\"s1\">&#39;entries&#39;</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"s1\">&#39;authors&#39;</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span>\n                                           <span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">()[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n            <span class=\"k\">for</span> <span class=\"n\">author</span> <span class=\"ow\">in</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">metadata</span><span class=\"p\">[</span><span class=\"s1\">&#39;entries&#39;</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"s1\">&#39;authors&#39;</span><span class=\"p\">][</span><span class=\"mi\">1</span><span class=\"p\">:]:</span>\n                <span class=\"n\">sub_auth_boolean_str</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;+OR+&#39;</span> <span class=\"o\">+</span> <span class=\"n\">author</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">()[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n            <span class=\"n\">sub_auth_boolean_str</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;)+AND+&#39;</span>\n            <span class=\"n\">search_str</span> <span class=\"o\">=</span> <span class=\"n\">sub_auth_boolean_str</span> <span class=\"o\">+</span> <span class=\"n\">ref_search_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;last_name&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;)&#39;</span>\n            <span class=\"n\">queryurl</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;https://export.arxiv.org/api/query?search_query=au:</span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span>\n                        <span class=\"o\">%</span> <span class=\"n\">search_str</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&amp;sortBy=submittedDate&amp;sortOrder=descending&#39;</span>\n                        <span class=\"s1\">&#39;&amp;max_results=5&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">arxivquery</span> <span class=\"o\">=</span> <span class=\"n\">feedparser</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"p\">(</span><span class=\"n\">queryurl</span><span class=\"p\">)</span>\n            <span class=\"n\">queryresults</span> <span class=\"o\">=</span> <span class=\"n\">arxivquery</span>\n        <span class=\"k\">except</span> <span class=\"ne\">KeyError</span><span class=\"p\">:</span>\n            <span class=\"k\">pass</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;ref_recruit_form&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">RefereeRecruitmentForm</span><span class=\"p\">()</span>\n\n    <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">({</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;ref_search_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">ref_search_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;queryresults&#39;</span><span class=\"p\">:</span> <span class=\"n\">queryresults</span>\n    <span class=\"p\">})</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/referee_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"recruit_referee\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.recruit_referee\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">recruit_referee</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Invite a non-registered scientist to register and referee a Submission.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration</span>\n<span class=\"sd\">    If the Editor-in-charge does not find the desired referee among Contributors</span>\n<span class=\"sd\">    (otherwise, the method send_refereeing_invitation is used), he/she can invite somebody</span>\n<span class=\"sd\">    by providing name + contact details. This function emails a registration invitation to this</span>\n<span class=\"sd\">    person. The pending refereeing invitation is then recognized upon registration, using the</span>\n<span class=\"sd\">    invitation token.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">ref_recruit_form</span> <span class=\"o\">=</span> <span class=\"n\">RefereeRecruitmentForm</span><span class=\"p\">(</span>\n        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">ref_recruit_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">referee_invitation</span><span class=\"p\">,</span> <span class=\"n\">registration_invitation</span> <span class=\"o\">=</span> <span class=\"n\">ref_recruit_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">mail_request</span> <span class=\"o\">=</span> <span class=\"n\">MailEditingSubView</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span>\n                                          <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;referees/invite_unregistered_to_referee&#39;</span><span class=\"p\">,</span>\n                                          <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">referee_invitation</span><span class=\"p\">)</span>\n        <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">add_form</span><span class=\"p\">(</span><span class=\"n\">ref_recruit_form</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n            <span class=\"n\">referee_invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"n\">registration_invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Referee </span><span class=\"si\">{}</span><span class=\"s1\"> invited&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">registration_invitation</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">))</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A referee has been invited.&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"si\">{}</span><span class=\"s1\"> has been recruited and invited as a referee.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">referee_invitation</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">))</span>\n\n            <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                    <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">return_render</span><span class=\"p\">()</span>\n\n    <span class=\"n\">ref_search_form</span> <span class=\"o\">=</span> <span class=\"n\">RefereeSelectForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"n\">contributors_found</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">user__email</span><span class=\"o\">=</span><span class=\"n\">ref_recruit_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_address&#39;</span><span class=\"p\">])</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;ref_recruit_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">ref_recruit_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;ref_search_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">ref_search_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;queryresults&#39;</span><span class=\"p\">:</span> <span class=\"p\">[],</span>\n        <span class=\"s1\">&#39;contributors_found&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributors_found</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/referee_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"send_refereeing_invitation\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.send_refereeing_invitation\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">send_refereeing_invitation</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"p\">,</span>\n                               <span class=\"n\">auto_reminders_allowed</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Send RefereeInvitation to a registered Contributor.</span>\n\n<span class=\"sd\">    This method is called by the EIC from the submission&#39;s editorial_page,</span>\n<span class=\"sd\">    in the case where the referee is an identified Contributor.</span>\n<span class=\"sd\">    For a referee who isn&#39;t a Contributor yet, the method recruit_referee above</span>\n<span class=\"sd\">    is called instead.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">is_currently_available</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;This Contributor is marked as currently unavailable. &#39;</span>\n                        <span class=\"s1\">&#39;Please go back and select another referee.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/error.html&#39;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"s1\">&#39;errormessage&#39;</span><span class=\"p\">:</span> <span class=\"n\">errormessage</span><span class=\"p\">})</span>\n\n    <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">RefereeInvitation</span><span class=\"p\">(</span>\n        <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"n\">referee</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span>\n        <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">title</span><span class=\"p\">,</span>\n        <span class=\"n\">first_name</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">first_name</span><span class=\"p\">,</span>\n        <span class=\"n\">last_name</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">,</span>\n        <span class=\"n\">email_address</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">email</span><span class=\"p\">,</span>\n        <span class=\"n\">auto_reminders_allowed</span><span class=\"o\">=</span><span class=\"n\">auto_reminders_allowed</span><span class=\"p\">,</span>\n        <span class=\"c1\"># the key is only used for inviting unregistered users</span>\n        <span class=\"n\">date_invited</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n        <span class=\"n\">invited_by</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n\n    <span class=\"n\">mail_request</span> <span class=\"o\">=</span> <span class=\"n\">MailEditingSubView</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;referees/invite_contributor_to_referee&#39;</span><span class=\"p\">,</span>\n                                      <span class=\"n\">invitation</span><span class=\"o\">=</span><span class=\"n\">invitation</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A referee has been invited.&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;Referee </span><span class=\"si\">%s</span><span class=\"s1\"> has been invited.&#39;</span> <span class=\"o\">%</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Invitation sent&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">mail_request</span><span class=\"o\">.</span><span class=\"n\">return_render</span><span class=\"p\">()</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"set_refinv_auto_reminder\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.set_refinv_auto_reminder\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">set_refinv_auto_reminder</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">invitation_id</span><span class=\"p\">,</span> <span class=\"n\">auto_reminders</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Set the value of the Boolean for automatic refereeing reminders.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">RefereeInvitation</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">invitation_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">auto_reminders</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">auto_reminders_allowed</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Auto reminders succesfully turned off.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"n\">auto_reminders</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">auto_reminders_allowed</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Auto reminders succesfully turned on.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Option not recognized.&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span>\n                                    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"ref_invitation_reminder\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.ref_invitation_reminder\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">ref_invitation_reminder</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">invitation_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Send reminder email to pending RefereeInvitations.</span>\n\n<span class=\"sd\">    This method is used by the Editor-in-charge from the editorial_page</span>\n<span class=\"sd\">    when a referee has been invited but hasn&#39;t answered yet.</span>\n<span class=\"sd\">    It can be used for registered as well as unregistered referees.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">referee_invitations</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">(),</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">invitation_id</span><span class=\"p\">)</span>\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">nr_reminders</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">date_last_reminded</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;invitation&#39;</span><span class=\"p\">:</span> <span class=\"n\">invitation</span><span class=\"p\">},</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">referee</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_ref_reminder_email</span><span class=\"p\">()</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_unreg_ref_reminder_email</span><span class=\"p\">()</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Reminder sent succesfully.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_referee&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"accept_or_decline_ref_invitations\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.accept_or_decline_ref_invitations\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">accept_or_decline_ref_invitations</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">invitation_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Decide on RefereeInvitation.</span>\n\n<span class=\"sd\">    RefereeInvitations need to be either accepted or declined by the invited user</span>\n<span class=\"sd\">    using this view. The decision will be taken one invitation at a time.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">RefereeInvitation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_response</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">referee__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">invitation_id</span><span class=\"p\">:</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">invitation_id</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">RefereeInvitation</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">invitation</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;There are no more Refereeing Invitations for you to consider.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">))</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">ConsiderRefereeInvitationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">date_responded</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;accept&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;True&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">accepted</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"n\">decision_string</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;accepted&#39;</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;Thank you for agreeing to referee this Submission&lt;/h3&gt;&#39;</span>\n                                       <span class=\"s1\">&#39;&lt;p&gt;When you are ready, please go to the &#39;</span>\n                                       <span class=\"s1\">&#39;&lt;a href=&quot;</span><span class=\"si\">{url}</span><span class=\"s1\">&quot;&gt;Submission</span><span class=\"se\">\\&#39;</span><span class=\"s1\">s page&lt;/a&gt; to&#39;</span>\n                                       <span class=\"s1\">&#39; submit your Report.&lt;/p&gt;&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                                            <span class=\"n\">url</span><span class=\"o\">=</span><span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">accepted</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n            <span class=\"n\">decision_string</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;declined&#39;</span>\n            <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">refusal_reason</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;refusal_reason&#39;</span><span class=\"p\">]</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;You have declined to contribute a Report&lt;/h3&gt;&#39;</span>\n                                       <span class=\"s1\">&#39;Nonetheless, we thank you very much for considering&#39;</span>\n                                       <span class=\"s1\">&#39; this refereeing invitation.&lt;/p&gt;&#39;</span><span class=\"p\">))</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;invitation&#39;</span><span class=\"p\">:</span> <span class=\"n\">invitation</span><span class=\"p\">},</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">email_referee_response_to_EIC</span><span class=\"p\">()</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">email_referee_in_response_to_decision</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Add SubmissionEvents</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A referee has </span><span class=\"si\">%s</span><span class=\"s1\"> the refereeing invitation.&#39;</span>\n                                                   <span class=\"o\">%</span> <span class=\"n\">decision_string</span><span class=\"p\">)</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;Referee </span><span class=\"si\">%s</span><span class=\"s1\"> has </span><span class=\"si\">%s</span><span class=\"s1\"> the refereeing invitation.&#39;</span>\n                                                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">referee</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">,</span>\n                                                   <span class=\"n\">decision_string</span><span class=\"p\">))</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">referee_invitations</span><span class=\"o\">.</span><span class=\"n\">awaiting_response</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:accept_or_decline_ref_invitations&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">ConsiderRefereeInvitationForm</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;invitation&#39;</span><span class=\"p\">:</span> <span class=\"n\">invitation</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/referee_invitations_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"decline_ref_invitation\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.decline_ref_invitation\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">decline_ref_invitation</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">invitation_key</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Decline a RefereeInvitation.&quot;&quot;&quot;</span>\n    <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">RefereeInvitation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(),</span> <span class=\"n\">invitation_key</span><span class=\"o\">=</span><span class=\"n\">invitation_key</span><span class=\"p\">)</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">ConsiderRefereeInvitationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;accept&#39;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">})</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;invitation&#39;</span><span class=\"p\">:</span> <span class=\"n\">invitation</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;accept&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;True&#39;</span><span class=\"p\">:</span>\n            <span class=\"c1\"># User filled in: Accept</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Please login and go to your personal page if you&#39;</span>\n                                      <span class=\"s1\">&#39; want to accept the invitation.&#39;</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/referee_invitations_decline.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">accepted</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">date_responded</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">refusal_reason</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;refusal_reason&#39;</span><span class=\"p\">]</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;invitation&#39;</span><span class=\"p\">:</span> <span class=\"n\">invitation</span><span class=\"p\">},</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">email_referee_response_to_EIC</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Add SubmissionEvents</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A referee has declined the&#39;</span>\n                                                   <span class=\"s1\">&#39; refereeing invitation.&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;Referee </span><span class=\"si\">%s</span><span class=\"s1\"> has declined the refereeing &#39;</span>\n                                                <span class=\"s1\">&#39;invitation.&#39;</span> <span class=\"o\">%</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Thank you for informing us that you will not provide a Report.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:index&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/referee_invitations_decline.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<div class=\"viewcode-block\" id=\"cancel_ref_invitation\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.cancel_ref_invitation\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">cancel_ref_invitation</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">invitation_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Cancel a RefereeInvitation.</span>\n\n<span class=\"sd\">    This method is used by the Editor-in-charge from the editorial_page to remove a referee</span>\n<span class=\"sd\">    from the list of invited ones. It can be used for registered as well as unregistered referees.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">RefereeInvitation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">invitation_id</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">RefereeInvitation</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">cancelled</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;invitation&#39;</span><span class=\"p\">:</span> <span class=\"n\">invitation</span><span class=\"p\">})</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_ref_cancellation_email</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># Add SubmissionEvents</span>\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A referee invitation has been cancelled.&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;Referee invitation for </span><span class=\"si\">%s</span><span class=\"s1\"> has been cancelled.&#39;</span>\n                                            <span class=\"o\">%</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<div class=\"viewcode-block\" id=\"extend_refereeing_deadline\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.extend_refereeing_deadline\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">extend_refereeing_deadline</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">days</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Extend Refereeing deadline for Submission and open reporting and commenting.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reporting_deadline</span> <span class=\"o\">+=</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timedelta</span><span class=\"p\">(</span><span class=\"n\">days</span><span class=\"o\">=</span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">days</span><span class=\"p\">))</span>\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">open_for_reporting</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">open_for_commenting</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"n\">STATUS_EIC_ASSIGNED</span>\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">latest_activity</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_general_event</span><span class=\"p\">(</span><span class=\"s1\">&#39;A new refereeing deadline is set.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<div class=\"viewcode-block\" id=\"set_refereeing_deadline\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.set_refereeing_deadline\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">set_refereeing_deadline</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Set Refereeing deadline for Submission and open reporting and commenting.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">SetRefereeingDeadlineForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reporting_deadline</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;deadline&#39;</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;deadline&#39;</span><span class=\"p\">]</span> <span class=\"o\">&gt;</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">date</span><span class=\"p\">():</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">open_for_reporting</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">open_for_commenting</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">latest_activity</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n        <span class=\"c1\"># submission.status = STATUS_EIC_ASSIGNED  # This is dangerous as shit.</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_general_event</span><span class=\"p\">(</span><span class=\"s1\">&#39;A new refereeing deadline is set.&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;New reporting deadline set.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;The deadline has not been set. Please try again.&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<div class=\"viewcode-block\" id=\"close_refereeing_round\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.close_refereeing_round\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">close_refereeing_round</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Close Submission for refereeing.</span>\n\n<span class=\"sd\">    Called by the Editor-in-charge when a satisfactory number of reports have been gathered.</span>\n<span class=\"sd\">    Automatically emails the authors to ask them if they want to round off any replies to</span>\n<span class=\"sd\">    reports or comments before the editorial recommendation is formulated.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span>\n        <span class=\"n\">open_for_reporting</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">open_for_commenting</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">reporting_deadline</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n        <span class=\"n\">latest_activity</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">())</span>\n    <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_general_event</span><span class=\"p\">(</span><span class=\"s1\">&#39;Refereeing round has been closed.&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Refereeing round closed.&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_oversee_refereeing&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"refereeing_overview\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.refereeing_overview\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">refereeing_overview</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List all Submissions undergoing active Refereeing.&quot;&quot;&quot;</span>\n    <span class=\"n\">submissions_under_refereeing</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span>\n        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">actively_refereeing</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;submission_date&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;submissions_under_refereeing&#39;</span><span class=\"p\">:</span> <span class=\"n\">submissions_under_refereeing</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/admin/refereeing_overview.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<div class=\"viewcode-block\" id=\"communication\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.communication\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">communication</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">comtype</span><span class=\"p\">,</span> <span class=\"n\">referee_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Send refereeing related communication.</span>\n\n<span class=\"sd\">    Communication may be between two of: editor-in-charge, author and referee.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">referee</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">if</span> <span class=\"n\">comtype</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"s1\">&#39;EtoA&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;EtoR&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;EtoS&#39;</span><span class=\"p\">]:</span>\n        <span class=\"c1\"># Editor to {Author, Referee, Editorial Administration}</span>\n        <span class=\"n\">submissions_qs</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"n\">comtype</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;AtoE&#39;</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Author to Editor</span>\n        <span class=\"n\">submissions_qs</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_author</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">referee</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"k\">elif</span> <span class=\"n\">comtype</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;RtoE&#39;</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Referee to Editor (Contributor account required)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Raise PermissionDenied to let the user know something is wrong with its account.</span>\n            <span class=\"k\">raise</span> <span class=\"n\">PermissionDenied</span>\n\n        <span class=\"n\">submissions_qs</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">referee_invitations__referee__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">referee</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"k\">elif</span> <span class=\"n\">comtype</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;StoE&#39;</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Editorial Administration to Editor</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_oversee_refereeing&#39;</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">PermissionDenied</span>\n        <span class=\"n\">submissions_qs</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">referee</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Invalid commtype in the url!</span>\n        <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n\n    <span class=\"c1\"># Get the showpiece itself or return 404</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">submissions_qs</span><span class=\"p\">,</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">referee_id</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">referee</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Get the Contributor to communicate with if not already defined (`Eto?` communication)</span>\n        <span class=\"c1\"># To Fix: Assuming the Editorial Administrator won&#39;t make any `referee_id` mistakes</span>\n        <span class=\"n\">referee</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">referee_id</span><span class=\"p\">)</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">EditorialCommunicationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">communication</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">communication</span><span class=\"o\">.</span><span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">submission</span>\n        <span class=\"n\">communication</span><span class=\"o\">.</span><span class=\"n\">comtype</span> <span class=\"o\">=</span> <span class=\"n\">comtype</span>\n        <span class=\"n\">communication</span><span class=\"o\">.</span><span class=\"n\">referee</span> <span class=\"o\">=</span> <span class=\"n\">referee</span>\n        <span class=\"n\">communication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;communication&#39;</span><span class=\"p\">:</span> <span class=\"n\">communication</span><span class=\"p\">})</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_communication_email</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">comtype</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"s1\">&#39;EtoA&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;EtoR&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;EtoS&#39;</span><span class=\"p\">]:</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                    <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span>\n        <span class=\"k\">elif</span> <span class=\"n\">comtype</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;AtoE&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">elif</span> <span class=\"n\">comtype</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;StoE&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;comtype&#39;</span><span class=\"p\">:</span> <span class=\"n\">comtype</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;referee_id&#39;</span><span class=\"p\">:</span> <span class=\"n\">referee_id</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/communication.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"eic_recommendation\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.eic_recommendation\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">eic_recommendation</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Write EIC Recommendation.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">eic_recommendation_required</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;An Editorial Recommendation is not required&lt;/h3&gt;&#39;</span>\n                                   <span class=\"s1\">&#39;This submission</span><span class=\"se\">\\&#39;</span><span class=\"s1\">s current status is: &lt;em&gt;</span><span class=\"si\">%s</span><span class=\"s1\">&lt;/em&gt;&#39;</span>\n                                   <span class=\"o\">%</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_status_display</span><span class=\"p\">()))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">]))</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">EICRecommendationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n    <span class=\"c1\"># Find EditorialAssignment for user</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">has_assignment</span><span class=\"p\">():</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;You cannot formulate an Editorial Recommendation,&#39;</span>\n                                   <span class=\"s1\">&#39; because the Editorial Assignment has not been set properly.&#39;</span>\n                                   <span class=\"s1\">&#39; Please &#39;</span>\n                                   <span class=\"s1\">&#39;&lt;a href=&quot;mailto:admin@scipost.org&quot;&gt;report the problem&lt;/a&gt;.&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">]))</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">recommendation</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">revision_requested</span><span class=\"p\">():</span>\n            <span class=\"c1\"># Send mail to authors to notify about the request for revision.</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span>\n                <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"p\">,</span>\n                <span class=\"s1\">&#39;recommendation&#39;</span><span class=\"p\">:</span> <span class=\"n\">recommendation</span><span class=\"p\">,</span>\n            <span class=\"p\">})</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_author_revision_requested_email</span><span class=\"p\">()</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Editorial Recommendation succesfully submitted&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/pool/recommendation_formulate.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"reformulate_eic_recommendation\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.reformulate_eic_recommendation\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">reformulate_eic_recommendation</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Reformulate EIC Recommendation form view.</span>\n\n<span class=\"sd\">    Accessible for: Editor-in-charge and Editorial Administration.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n                                   <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n    <span class=\"n\">recommendation</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">eicrecommendations</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">recommendation</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">Http404</span><span class=\"p\">(</span><span class=\"s1\">&#39;No EICRecommendation formulated yet.&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">may_be_reformulated</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;With the current status of the EICRecommendation you are not &#39;</span>\n                                   <span class=\"s1\">&#39;allowed to reformulate the Editorial Recommendation&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">]))</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">EICRecommendationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"n\">reformulate</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">recommendation</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">revision_requested</span><span class=\"p\">():</span>\n            <span class=\"c1\"># Send mail to authors to notify about the request for revision.</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span>\n                <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"p\">,</span>\n                <span class=\"s1\">&#39;recommendation&#39;</span><span class=\"p\">:</span> <span class=\"n\">recommendation</span><span class=\"p\">,</span>\n            <span class=\"p\">})</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_author_revision_requested_email</span><span class=\"p\">()</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Editorial Recommendation succesfully reformulated&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/pool/recommendation_formulate_rewrite.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"c1\">###########</span>\n<span class=\"c1\"># Reports</span>\n<span class=\"c1\">###########</span>\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_referee&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"submit_report\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.submit_report\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">submit_report</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Submit Report on a Submission.</span>\n\n<span class=\"sd\">    Important checks to be aware of include an author check for the submission,</span>\n<span class=\"sd\">    has the reporting deadline not been reached yet and does there exist any invitation</span>\n<span class=\"sd\">    for the current user on this submission.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"o\">=</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Check whether the user can submit a report:</span>\n    <span class=\"n\">is_author</span> <span class=\"o\">=</span> <span class=\"n\">check_verified_author</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">is_author_unchecked</span> <span class=\"o\">=</span> <span class=\"n\">check_unverified_author</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">referee_invitations</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">fulfilled</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">cancelled</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">referee__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n\n    <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">if</span> <span class=\"n\">is_author</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;You are an author of this Submission and cannot submit a Report.&#39;</span>\n    <span class=\"k\">elif</span> <span class=\"n\">is_author_unchecked</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;The system flagged you as a potential author of this Submission. &#39;</span>\n                        <span class=\"s1\">&#39;Please go to your personal page under the Submissions tab&#39;</span>\n                        <span class=\"s1\">&#39; to clarify this.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">invitation</span><span class=\"p\">:</span>\n        <span class=\"c1\"># User is going to contribute a Report. Check deadlines for doing so.</span>\n        <span class=\"k\">if</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span> <span class=\"o\">&gt;</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reporting_deadline</span> <span class=\"o\">+</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timedelta</span><span class=\"p\">(</span><span class=\"n\">days</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">):</span>\n            <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;The reporting deadline has passed. You cannot submit&#39;</span>\n                            <span class=\"s1\">&#39; a Report anymore.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">open_for_reporting</span><span class=\"p\">:</span>\n            <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Reporting for this submission has closed. You cannot submit&#39;</span>\n                            <span class=\"s1\">&#39; a Report anymore.&#39;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">errormessage</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Remove old drafts from the database</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reports</span><span class=\"o\">.</span><span class=\"n\">in_draft</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">errormessage</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">errormessage</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n    <span class=\"c1\"># Find and fill earlier version of report</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">report_in_draft</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">reports</span><span class=\"o\">.</span><span class=\"n\">in_draft</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">author__user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n        <span class=\"n\">report_in_draft</span> <span class=\"o\">=</span> <span class=\"n\">Report</span><span class=\"p\">(</span><span class=\"n\">author</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">ReportForm</span><span class=\"p\">(</span>\n        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">report_in_draft</span><span class=\"p\">,</span>\n        <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Check if data sent is valid</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">newreport</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">newreport</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">STATUS_DRAFT</span><span class=\"p\">:</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Your Report has been saved. &#39;</span>\n                                       <span class=\"s1\">&#39;You may carry on working on it,&#39;</span>\n                                       <span class=\"s1\">&#39; or leave the page and finish it later.&#39;</span><span class=\"p\">))</span>\n            <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:submit_report&#39;</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span>\n                <span class=\"s1\">&#39;arxiv_identifier_w_vn_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">}))</span>\n\n        <span class=\"c1\"># Send mails if report is submitted</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span> <span class=\"n\">newreport</span><span class=\"p\">},</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">email_EIC_report_delivered</span><span class=\"p\">()</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">email_referee_report_delivered</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Add SubmissionEvents for the EIC only, as it can also be rejected still</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"si\">%s</span><span class=\"s1\"> has submitted a new Report.&#39;</span>\n                                     <span class=\"o\">%</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Thank you for your Report&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n    <span class=\"k\">elif</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Report not submitted, please read the errors below.&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/report_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<div class=\"viewcode-block\" id=\"vet_submitted_reports_list\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.vet_submitted_reports_list\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">vet_submitted_reports_list</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List Reports with status `unvetted`.&quot;&quot;&quot;</span>\n    <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">get_list_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">))</span>\n    <span class=\"n\">reports_to_vet</span> <span class=\"o\">=</span> <span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;date_submitted&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;reports_to_vet&#39;</span><span class=\"p\">:</span> <span class=\"n\">reports_to_vet</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/vet_submitted_reports_list.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"vet_submitted_report\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.vet_submitted_report\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">vet_submitted_report</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">report_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;List Reports with status `unvetted` for vetting purposes.</span>\n\n<span class=\"sd\">    A user may only vet reports of submissions he/she is EIC of or if he/she is</span>\n<span class=\"sd\">    SciPost Administratoror Vetting Editor.</span>\n\n<span class=\"sd\">    After vetting an email is sent to the report author, bcc EIC. If report</span>\n<span class=\"sd\">    has not been refused, the submission author is also mailed.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perms</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_vet_submitted_reports&#39;</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Vetting Editors may vote on everything.</span>\n        <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">report_id</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter_for_eic</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">report_id</span><span class=\"p\">)</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">VetReportForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span> <span class=\"n\">report</span><span class=\"p\">})</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">process_vetting</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># email report author</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span> <span class=\"n\">report</span><span class=\"p\">,</span>\n                              <span class=\"s1\">&#39;email_response&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_response_field&#39;</span><span class=\"p\">]})</span>\n        <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">acknowledge_report_email</span><span class=\"p\">()</span>  <span class=\"c1\"># email report author, bcc EIC</span>\n\n        <span class=\"c1\"># Add SubmissionEvent for the EIC</span>\n        <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;The Report by </span><span class=\"si\">%s</span><span class=\"s1\"> is vetted.&#39;</span>\n                                            <span class=\"o\">%</span> <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">STATUS_VETTED</span><span class=\"p\">:</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_author_report_received_email</span><span class=\"p\">()</span>\n\n            <span class=\"c1\"># Add SubmissionEvent to tell the author about the new report</span>\n            <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A new Report has been submitted.&#39;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Submitted Report vetted for &lt;a href=&quot;</span><span class=\"si\">{url}</span><span class=\"s1\">&quot;&gt;</span><span class=\"si\">{arxiv}</span><span class=\"s1\">&lt;/a&gt;.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">url</span><span class=\"o\">=</span><span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">(),</span>\n            <span class=\"n\">arxiv</span><span class=\"o\">=</span><span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span> <span class=\"o\">==</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Redirect a EIC back to the Editorial Page!</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                    <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,)))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:vet_submitted_reports_list&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;report_to_vet&#39;</span><span class=\"p\">:</span> <span class=\"n\">report</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/vet_submitted_report.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_prepare_recommendations_for_voting&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"prepare_for_voting\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.prepare_for_voting\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">prepare_for_voting</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">rec_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Form view to prepare a EICRecommendation for voting.&quot;&quot;&quot;</span>\n    <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">recommendation</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span>\n        <span class=\"n\">EICRecommendation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">voting_in_preparation</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">),</span>\n        <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">rec_id</span><span class=\"p\">)</span>\n\n    <span class=\"n\">eligibility_form</span> <span class=\"o\">=</span> <span class=\"n\">VotingEligibilityForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">recommendation</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">eligibility_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">eligibility_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;We have registered your selection.&#39;</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Add SubmissionEvents</span>\n        <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;The Editorial Recommendation has been &#39;</span>\n                                                    <span class=\"s1\">&#39;put forward to the College for voting.&#39;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">]))</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">fellows_with_expertise</span> <span class=\"o\">=</span> <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">fellows</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span><span class=\"p\">)</span> <span class=\"o\">|</span>\n            <span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"n\">contributor__expertises__contains</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">subject_area</span><span class=\"p\">])</span> <span class=\"o\">|</span>\n            <span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"n\">contributor__expertises__contains</span><span class=\"o\">=</span><span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">secondary_areas</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span>\n                <span class=\"s1\">&#39;contributor__user__last_name&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">coauthorships</span> <span class=\"o\">=</span> <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">flag_coauthorships_arxiv</span><span class=\"p\">(</span><span class=\"n\">fellows_with_expertise</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;recommendation&#39;</span><span class=\"p\">:</span> <span class=\"n\">recommendation</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;fellows_with_expertise&#39;</span><span class=\"p\">:</span> <span class=\"n\">fellows_with_expertise</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;coauthorships&#39;</span><span class=\"p\">:</span> <span class=\"n\">coauthorships</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;eligibility_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">eligibility_form</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/admin/recommendation_prepare_for_voting.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"vote_on_rec\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.vote_on_rec\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">vote_on_rec</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">rec_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Form view for Fellows to cast their vote on EICRecommendation.&quot;&quot;&quot;</span>\n    <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">recommendation</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span>\n        <span class=\"n\">EICRecommendation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">user_must_vote_on</span><span class=\"p\">(</span>\n            <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">rec_id</span><span class=\"p\">)</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">RecommendationVoteForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;vote&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;agree&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_for</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">IntegrityError</span><span class=\"p\">:</span>\n                <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;You have already voted for this Recommendation.&#39;</span><span class=\"p\">)</span>\n                <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">))</span>\n            <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_against</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_abstain</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;vote&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;disagree&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_for</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_against</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">IntegrityError</span><span class=\"p\">:</span>\n                <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;You have already voted for this Recommendation.&#39;</span><span class=\"p\">)</span>\n                <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">))</span>\n            <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_abstain</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;vote&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;abstain&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_for</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_against</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">voted_abstain</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">IntegrityError</span><span class=\"p\">:</span>\n                <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;You have already voted for this Recommendation.&#39;</span><span class=\"p\">)</span>\n                <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;remark&#39;</span><span class=\"p\">]:</span>\n            <span class=\"n\">remark</span> <span class=\"o\">=</span> <span class=\"n\">Remark</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">,</span>\n                            <span class=\"n\">recommendation</span><span class=\"o\">=</span><span class=\"n\">recommendation</span><span class=\"p\">,</span>\n                            <span class=\"n\">date</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n                            <span class=\"n\">remark</span><span class=\"o\">=</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;remark&#39;</span><span class=\"p\">])</span>\n            <span class=\"n\">remark</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Thank you for your vote.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">))</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;recommendation&#39;</span><span class=\"p\">:</span> <span class=\"n\">recommendation</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;voting_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;submissions/pool/recommendation.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_prepare_recommendations_for_voting&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"remind_Fellows_to_vote\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.remind_Fellows_to_vote\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">remind_Fellows_to_vote</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Send an email to all Fellow with pending voting duties.</span>\n\n<span class=\"sd\">    It must be called by and Editorial Administrator.</span>\n\n<span class=\"sd\">    Possible TODO: This reminder function doesn&#39;t filter per submission?!</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">pool_editable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">recommendations</span> <span class=\"o\">=</span> <span class=\"n\">EICRecommendation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">active</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">submission__in</span><span class=\"o\">=</span><span class=\"n\">submissions</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">put_to_voting</span><span class=\"p\">()</span>\n\n    <span class=\"n\">Fellow_emails</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"n\">Fellow_names</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"k\">for</span> <span class=\"n\">rec</span> <span class=\"ow\">in</span> <span class=\"n\">recommendations</span><span class=\"p\">:</span>\n        <span class=\"k\">for</span> <span class=\"n\">Fellow</span> <span class=\"ow\">in</span> <span class=\"n\">rec</span><span class=\"o\">.</span><span class=\"n\">eligible_to_vote</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">Fellow</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">rec</span><span class=\"o\">.</span><span class=\"n\">voted_for</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n                <span class=\"ow\">and</span> <span class=\"n\">Fellow</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">rec</span><span class=\"o\">.</span><span class=\"n\">voted_against</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n                <span class=\"ow\">and</span> <span class=\"n\">Fellow</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">rec</span><span class=\"o\">.</span><span class=\"n\">voted_abstain</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n                <span class=\"ow\">and</span> <span class=\"n\">Fellow</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">email</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">Fellow_emails</span><span class=\"p\">):</span>\n                <span class=\"n\">Fellow_emails</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">Fellow</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">email</span><span class=\"p\">)</span>\n                <span class=\"n\">Fellow_names</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">Fellow</span><span class=\"p\">))</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;Fellow_emails&#39;</span><span class=\"p\">:</span> <span class=\"n\">Fellow_emails</span><span class=\"p\">})</span>\n    <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_Fellows_voting_reminder_email</span><span class=\"p\">()</span>\n    <span class=\"n\">ack_message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Email reminders have been sent to: &lt;ul&gt;&#39;</span>\n    <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">Fellow_names</span><span class=\"p\">):</span>\n        <span class=\"n\">ack_message</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;li&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/li&gt;&#39;</span>\n    <span class=\"n\">ack_message</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/ul&gt;&#39;</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;ack_message&#39;</span><span class=\"p\">:</span> <span class=\"n\">Template</span><span class=\"p\">(</span><span class=\"n\">ack_message</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">Context</span><span class=\"p\">({})),</span>\n               <span class=\"s1\">&#39;followup_message&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;Return to the &#39;</span><span class=\"p\">,</span>\n               <span class=\"s1\">&#39;followup_link&#39;</span><span class=\"p\">:</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">),</span>\n               <span class=\"s1\">&#39;followup_link_label&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;Submissions pool&#39;</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/acknowledgement.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"PreScreeningView\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.PreScreeningView\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">PreScreeningView</span><span class=\"p\">(</span><span class=\"n\">SubmissionAdminViewMixin</span><span class=\"p\">,</span> <span class=\"n\">UpdateView</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Do pre-screening of new incoming Submissions.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">permission_required</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;scipost.can_run_pre_screening&#39;</span>\n    <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">prescreening</span><span class=\"p\">()</span>\n    <span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;submissions/admin/submission_prescreening.html&#39;</span>\n    <span class=\"n\">form_class</span> <span class=\"o\">=</span> <span class=\"n\">SubmissionPrescreeningForm</span>\n    <span class=\"n\">editorial_page</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">success_url</span> <span class=\"o\">=</span> <span class=\"n\">reverse_lazy</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"EICRecommendationView\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.EICRecommendationView\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">EICRecommendationView</span><span class=\"p\">(</span><span class=\"n\">SubmissionAdminViewMixin</span><span class=\"p\">,</span> <span class=\"n\">UpdateView</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;EICRecommendation detail view.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">permission_required</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;scipost.can_fix_College_decision&#39;</span>\n    <span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;submissions/pool/recommendation.html&#39;</span>\n    <span class=\"n\">editorial_page</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">form_class</span> <span class=\"o\">=</span> <span class=\"n\">FixCollegeDecisionForm</span>\n    <span class=\"n\">success_url</span> <span class=\"o\">=</span> <span class=\"n\">reverse_lazy</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:pool&#39;</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"EICRecommendationView.get_object\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.EICRecommendationView.get_object\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_object</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get EICRecommendation.&quot;&quot;&quot;</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_object</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">eicrecommendations</span><span class=\"o\">.</span><span class=\"n\">put_to_voting</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;rec_id&#39;</span><span class=\"p\">])</span></div>\n\n<div class=\"viewcode-block\" id=\"EICRecommendationView.get_form_kwargs\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.EICRecommendationView.get_form_kwargs\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_form_kwargs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Form accepts request as argument.&quot;&quot;&quot;</span>\n        <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_form_kwargs</span><span class=\"p\">()</span>\n        <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;request&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span>\n        <span class=\"k\">return</span> <span class=\"n\">kwargs</span></div>\n\n<div class=\"viewcode-block\" id=\"EICRecommendationView.get_context_data\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.EICRecommendationView.get_context_data\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_context_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get the EICRecommendation as a submission-related instance.&quot;&quot;&quot;</span>\n        <span class=\"n\">ctx</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_context_data</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"n\">ctx</span><span class=\"p\">[</span><span class=\"s1\">&#39;recommendation&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">ctx</span><span class=\"p\">[</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"n\">ctx</span></div>\n\n    <span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"EICRecommendationView.form_valid\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.EICRecommendationView.form_valid\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">form_valid</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Redirect and send out mails if decision is fixed.&quot;&quot;&quot;</span>\n        <span class=\"n\">recommendation</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_fixed</span><span class=\"p\">():</span>\n            <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span>\n\n            <span class=\"c1\"># Temporary: Update submission instance for utils email func.</span>\n            <span class=\"c1\"># Won&#39;t be needed in new mail construct.</span>\n            <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">recommendation</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"s1\">&#39;recommendation&#39;</span><span class=\"p\">:</span> <span class=\"n\">recommendation</span><span class=\"p\">})</span>\n            <span class=\"n\">SubmissionUtils</span><span class=\"o\">.</span><span class=\"n\">send_author_College_decision_email</span><span class=\"p\">()</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;The Editorial College</span><span class=\"se\">\\&#39;</span><span class=\"s1\">s decision has been fixed.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;The Editorial College</span><span class=\"se\">\\&#39;</span><span class=\"s1\">s decision has been deprecated.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">HttpResponseRedirect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">success_url</span><span class=\"p\">)</span></div></div>\n\n\n<div class=\"viewcode-block\" id=\"PlagiarismView\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.PlagiarismView\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">PlagiarismView</span><span class=\"p\">(</span><span class=\"n\">SubmissionAdminViewMixin</span><span class=\"p\">,</span> <span class=\"n\">UpdateView</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Administration detail page of Plagiarism report.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">permission_required</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;scipost.can_do_plagiarism_checks&#39;</span>\n    <span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;submissions/admin/plagiarism_report.html&#39;</span>\n    <span class=\"n\">editorial_page</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">form_class</span> <span class=\"o\">=</span> <span class=\"n\">iThenticateReportForm</span>\n\n<div class=\"viewcode-block\" id=\"PlagiarismView.get_object\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.PlagiarismView.get_object\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_object</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get the plagiarism_report as a linked object from the Submission.&quot;&quot;&quot;</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_object</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">plagiarism_report</span></div></div>\n\n\n<div class=\"viewcode-block\" id=\"PlagiarismReportPDFView\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.PlagiarismReportPDFView\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">PlagiarismReportPDFView</span><span class=\"p\">(</span><span class=\"n\">SubmissionAdminViewMixin</span><span class=\"p\">,</span> <span class=\"n\">SingleObjectMixin</span><span class=\"p\">,</span> <span class=\"n\">RedirectView</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Redirect to Plagiarism report PDF at iThenticate.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">permission_required</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;scipost.can_do_plagiarism_checks&#39;</span>\n    <span class=\"n\">editorial_page</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n<div class=\"viewcode-block\" id=\"PlagiarismReportPDFView.get_redirect_url\"><a class=\"viewcode-back\" href=\"../../../apps/submissions/#submissions.views.PlagiarismReportPDFView.get_redirect_url\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_redirect_url</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get the temporary url provided by the iThenticate API.&quot;&quot;&quot;</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_object</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">plagiarism_report</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n        <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">plagiarism_report</span><span class=\"o\">.</span><span class=\"n\">get_report_url</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">url</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n        <span class=\"k\">return</span> <span class=\"n\">url</span></div></div>\n</pre></div>"}