{"parents": [{"title": "Module code", "link": "../../"}], "current_page_name": "_modules/comments/views", "alabaster_version": "0.7.10", "customsidebar": null, "title": "comments.views", "sidebars": null, "body": "<h1>Source code for comments.views</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"n\">__copyright__</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;Copyright 2016-2018, Stichting SciPost (SciPost Foundation)&quot;</span>\n<span class=\"n\">__license__</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;AGPL v3&quot;</span>\n\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.auth.decorators</span> <span class=\"k\">import</span> <span class=\"n\">permission_required</span><span class=\"p\">,</span> <span class=\"n\">login_required</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib</span> <span class=\"k\">import</span> <span class=\"n\">messages</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.urlresolvers</span> <span class=\"k\">import</span> <span class=\"n\">reverse</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"k\">import</span> <span class=\"n\">transaction</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.http</span> <span class=\"k\">import</span> <span class=\"n\">HttpResponse</span><span class=\"p\">,</span> <span class=\"n\">Http404</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"k\">import</span> <span class=\"n\">timezone</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.shortcuts</span> <span class=\"k\">import</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">,</span> <span class=\"n\">render</span><span class=\"p\">,</span> <span class=\"n\">redirect</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">guardian.shortcuts</span> <span class=\"k\">import</span> <span class=\"n\">get_objects_for_user</span>\n<span class=\"kn\">import</span> <span class=\"nn\">strings</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.constants</span> <span class=\"k\">import</span> <span class=\"n\">EXTENTIONS_IMAGES</span><span class=\"p\">,</span> <span class=\"n\">EXTENTIONS_PDF</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.models</span> <span class=\"k\">import</span> <span class=\"n\">Comment</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.forms</span> <span class=\"k\">import</span> <span class=\"n\">CommentForm</span><span class=\"p\">,</span> <span class=\"n\">VetCommentForm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.utils</span> <span class=\"k\">import</span> <span class=\"n\">validate_file_extention</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">commentaries.models</span> <span class=\"k\">import</span> <span class=\"n\">Commentary</span>\n<span class=\"kn\">from</span> <span class=\"nn\">mails.utils</span> <span class=\"k\">import</span> <span class=\"n\">DirectMailUtil</span>\n<span class=\"kn\">from</span> <span class=\"nn\">submissions.utils</span> <span class=\"k\">import</span> <span class=\"n\">SubmissionUtils</span>\n<span class=\"kn\">from</span> <span class=\"nn\">submissions.models</span> <span class=\"k\">import</span> <span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">Report</span>\n<span class=\"kn\">from</span> <span class=\"nn\">theses.models</span> <span class=\"k\">import</span> <span class=\"n\">ThesisLink</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_submit_comments&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">new_comment</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">CommentForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">object_id</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;object_id&quot;</span><span class=\"p\">])</span>\n        <span class=\"n\">type_of_object</span> <span class=\"o\">=</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;type_of_object&quot;</span><span class=\"p\">]</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;thesislink&quot;</span><span class=\"p\">:</span>\n            <span class=\"n\">_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">ThesisLink</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">open_for_commenting</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;submission&quot;</span><span class=\"p\">:</span>\n            <span class=\"n\">_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">open_for_commenting</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">)</span>\n            <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;A new comment has been added.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;commentary&quot;</span><span class=\"p\">:</span>\n            <span class=\"n\">_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Commentary</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">open_for_commenting</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">)</span>\n\n        <span class=\"n\">new_comment</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">new_comment</span><span class=\"o\">.</span><span class=\"n\">author</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n        <span class=\"n\">new_comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span> <span class=\"o\">=</span> <span class=\"n\">_object</span>\n        <span class=\"n\">new_comment</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">new_comment</span><span class=\"o\">.</span><span class=\"n\">grant_permissions</span><span class=\"p\">()</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">strings</span><span class=\"o\">.</span><span class=\"n\">acknowledge_submit_comment</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span><span class=\"p\">(</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;comments/add_comment.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_vet_comments&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">vet_submitted_comments_list</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">comments_to_vet</span> <span class=\"o\">=</span> <span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;date_submitted&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">VetCommentForm</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;comments_to_vet&#39;</span><span class=\"p\">:</span> <span class=\"n\">comments_to_vet</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span><span class=\"p\">(</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;comments/vet_submitted_comments.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<span class=\"k\">def</span> <span class=\"nf\">vet_submitted_comment</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">comment_id</span><span class=\"p\">):</span>\n    <span class=\"c1\"># Method `get_objects_for_user` gets all Comments that are assigned to the user</span>\n    <span class=\"c1\"># or *all* comments if user has the `scipost.can_vet_comments` permission.</span>\n    <span class=\"n\">comment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">((</span><span class=\"n\">get_objects_for_user</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"s1\">&#39;comments.can_vet_comments&#39;</span><span class=\"p\">)</span>\n                                 <span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()),</span>\n                                <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">comment_id</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">VetCommentForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;action_option&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Accept the comment as is</span>\n            <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n            <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">vetted_by</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n            <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n            <span class=\"c1\"># Update `latest_activity` fields</span>\n            <span class=\"n\">content_object</span> <span class=\"o\">=</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span>\n            <span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">latest_activity</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n            <span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">content_object</span><span class=\"p\">,</span> <span class=\"n\">Submission</span><span class=\"p\">):</span>\n                <span class=\"c1\"># Add events to Submission and send mail to author of the Submission</span>\n                <span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;A Comment has been accepted.&#39;</span><span class=\"p\">)</span>\n                <span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A new Comment has been added.&#39;</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">is_author_reply</span><span class=\"p\">:</span>\n                    <span class=\"n\">mail_sender</span> <span class=\"o\">=</span> <span class=\"n\">DirectMailUtil</span><span class=\"p\">(</span>\n                        <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;authors/inform_authors_comment_received&#39;</span><span class=\"p\">,</span>\n                        <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">content_object</span><span class=\"p\">)</span>\n                    <span class=\"n\">mail_sender</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n            <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">content_object</span><span class=\"p\">,</span> <span class=\"n\">Report</span><span class=\"p\">):</span>\n                <span class=\"c1\"># Add events to related Submission and send mail to author of the Submission</span>\n                <span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;A Comment has been accepted.&#39;</span><span class=\"p\">)</span>\n                <span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_author</span><span class=\"p\">(</span><span class=\"s1\">&#39;A new Comment has been added.&#39;</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">is_author_reply</span><span class=\"p\">:</span>\n                    <span class=\"c1\"># Email Report author: Submission authors have replied</span>\n                    <span class=\"n\">mail_sender</span> <span class=\"o\">=</span> <span class=\"n\">DirectMailUtil</span><span class=\"p\">(</span>\n                        <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;referees/inform_referee_authors_replied_to_report&#39;</span><span class=\"p\">,</span>\n                        <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">content_object</span><span class=\"p\">)</span>\n                    <span class=\"n\">mail_sender</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span> <span class=\"c1\"># this is a Comment on the Report from another Contributor</span>\n                    <span class=\"c1\"># Email Report author: Contributor has commented the Report</span>\n                    <span class=\"n\">mail_sender</span> <span class=\"o\">=</span> <span class=\"n\">DirectMailUtil</span><span class=\"p\">(</span>\n                        <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;referees/inform_referee_contributor_commented_report&#39;</span><span class=\"p\">,</span>\n                        <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">content_object</span><span class=\"p\">)</span>\n                    <span class=\"n\">mail_sender</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n                    <span class=\"c1\"># Email submission authors: Contributor has commented the Report</span>\n                    <span class=\"n\">mail_sender</span> <span class=\"o\">=</span> <span class=\"n\">DirectMailUtil</span><span class=\"p\">(</span>\n                        <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;authors/inform_authors_contributor_commented_report&#39;</span><span class=\"p\">,</span>\n                        <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">content_object</span><span class=\"p\">)</span>\n                    <span class=\"n\">mail_sender</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n\n            <span class=\"c1\"># In all cases, email the comment author</span>\n            <span class=\"n\">mail_sender</span> <span class=\"o\">=</span> <span class=\"n\">DirectMailUtil</span><span class=\"p\">(</span>\n                <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;commenters/inform_commenter_comment_vetted&#39;</span><span class=\"p\">,</span>\n                <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">comment</span><span class=\"p\">)</span>\n            <span class=\"n\">mail_sender</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n\n        <span class=\"k\">elif</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;action_option&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;2&#39;</span><span class=\"p\">:</span>\n            <span class=\"c1\"># The comment request is simply rejected</span>\n            <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;refusal_reason&#39;</span><span class=\"p\">])</span>\n            <span class=\"k\">if</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"o\">-</span><span class=\"mi\">1</span>  <span class=\"c1\"># Why&#39;s this here??</span>\n            <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n            <span class=\"c1\"># Send emails</span>\n            <span class=\"n\">mail_sender</span> <span class=\"o\">=</span> <span class=\"n\">DirectMailUtil</span><span class=\"p\">(</span>\n                <span class=\"n\">mail_code</span><span class=\"o\">=</span><span class=\"s1\">&#39;commenters/inform_commenter_comment_rejected&#39;</span><span class=\"p\">,</span>\n                <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">comment</span><span class=\"p\">,</span>\n                <span class=\"n\">email_response</span><span class=\"o\">=</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_response_field&#39;</span><span class=\"p\">])</span> <span class=\"c1\"># TODO: needs kwargs to mail template</span>\n            <span class=\"n\">mail_sender</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n\n\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"p\">,</span> <span class=\"n\">Submission</span><span class=\"p\">):</span>\n                <span class=\"c1\"># Add event if commented to Submission</span>\n                <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;A Comment has been rejected.&#39;</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"p\">,</span> <span class=\"n\">Report</span><span class=\"p\">):</span>\n                <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_event_for_eic</span><span class=\"p\">(</span><span class=\"s1\">&#39;A Comment has been rejected.&#39;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Submitted Comment vetted.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"p\">,</span> <span class=\"n\">Submission</span><span class=\"p\">):</span>\n            <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span>\n            <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span> <span class=\"o\">==</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Redirect a EIC back to the Editorial Page!</span>\n                <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                        <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,)))</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"p\">,</span> <span class=\"n\">Report</span><span class=\"p\">):</span>\n            <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">submission</span>\n            <span class=\"k\">if</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">editor_in_charge</span> <span class=\"o\">==</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Redirect a EIC back to the Editorial Page!</span>\n                <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;submissions:editorial_page&#39;</span><span class=\"p\">,</span>\n                                        <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_w_vn_nr</span><span class=\"p\">,)))</span>\n        <span class=\"k\">elif</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">has_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_vet_comments&#39;</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Redirect vetters back to check for other unvetted comments!</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;comments:vet_submitted_comments_list&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;comment&#39;</span><span class=\"p\">:</span> <span class=\"n\">comment</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span><span class=\"p\">(</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;comments/vet_submitted_comment.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_submit_comments&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">reply_to_comment</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">comment_id</span><span class=\"p\">):</span>\n    <span class=\"n\">comment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">comment_id</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Verify if this is from an author:</span>\n    <span class=\"n\">related_object</span> <span class=\"o\">=</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">content_object</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">related_object</span><span class=\"p\">,</span> <span class=\"n\">Submission</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">related_object</span><span class=\"p\">,</span> <span class=\"n\">Commentary</span><span class=\"p\">):</span>\n        <span class=\"n\">is_author</span> <span class=\"o\">=</span> <span class=\"n\">related_object</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span>\n    <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">related_object</span><span class=\"p\">,</span> <span class=\"n\">Report</span><span class=\"p\">):</span>\n        <span class=\"n\">is_author</span> <span class=\"o\">=</span> <span class=\"n\">related_object</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span>\n    <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">related_object</span><span class=\"p\">,</span> <span class=\"n\">ThesisLink</span><span class=\"p\">):</span>\n        <span class=\"c1\"># ThesisLink</span>\n        <span class=\"n\">is_author</span> <span class=\"o\">=</span> <span class=\"n\">related_object</span><span class=\"o\">.</span><span class=\"n\">author</span> <span class=\"o\">==</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"c1\"># No idea what this could be, but just to be sure</span>\n        <span class=\"n\">is_author</span> <span class=\"o\">=</span> <span class=\"n\">related_object</span><span class=\"o\">.</span><span class=\"n\">author</span> <span class=\"o\">==</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">CommentForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">newcomment</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">content_object</span> <span class=\"o\">=</span> <span class=\"n\">comment</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">is_author_reply</span> <span class=\"o\">=</span> <span class=\"n\">is_author</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">author</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">grant_permissions</span><span class=\"p\">()</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&lt;h3&gt;Thank you for contributing a Reply&lt;/h3&gt;&#39;</span>\n                                  <span class=\"s1\">&#39;It will soon be vetted by an Editor.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;comment&#39;</span><span class=\"p\">:</span> <span class=\"n\">comment</span><span class=\"p\">,</span> <span class=\"s1\">&#39;is_author&#39;</span><span class=\"p\">:</span> <span class=\"n\">is_author</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;comments/reply_to_comment.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_submit_comments&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">reply_to_report</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">report_id</span><span class=\"p\">):</span>\n    <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">report_id</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Verify if this is from an author:</span>\n    <span class=\"n\">is_author</span> <span class=\"o\">=</span> <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">CommentForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">is_report_comment</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">newcomment</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">content_object</span> <span class=\"o\">=</span> <span class=\"n\">report</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">is_author_reply</span> <span class=\"o\">=</span> <span class=\"n\">is_author</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">author</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">grant_permissions</span><span class=\"p\">()</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&lt;h3&gt;Thank you for contributing a Reply&lt;/h3&gt;&#39;</span>\n                                  <span class=\"s1\">&#39;It will soon be vetted by an Editor.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">newcomment</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span> <span class=\"n\">report</span><span class=\"p\">,</span> <span class=\"s1\">&#39;is_author&#39;</span><span class=\"p\">:</span> <span class=\"n\">is_author</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;comments/reply_to_report.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_express_opinion_on_comments&#39;</span><span class=\"p\">,</span> <span class=\"n\">raise_exception</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">express_opinion</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">comment_id</span><span class=\"p\">,</span> <span class=\"n\">opinion</span><span class=\"p\">):</span>\n    <span class=\"c1\"># A contributor has expressed an opinion on a comment</span>\n    <span class=\"n\">comment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">comment_id</span><span class=\"p\">)</span>\n    <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">update_opinions</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">opinion</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n\n<div class=\"viewcode-block\" id=\"attachment\"><a class=\"viewcode-back\" href=\"../../../apps/comments/#comments.views.attachment\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">attachment</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">comment_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Open/read attachment of Comment if available.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">comment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">file_attachment</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">),</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">comment_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">validate_file_extention</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">file_attachment</span><span class=\"p\">,</span> <span class=\"n\">EXTENTIONS_IMAGES</span><span class=\"p\">):</span>\n        <span class=\"n\">content_type</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;image/jpeg&#39;</span>\n    <span class=\"k\">elif</span> <span class=\"n\">validate_file_extention</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">file_attachment</span><span class=\"p\">,</span> <span class=\"n\">EXTENTIONS_PDF</span><span class=\"p\">):</span>\n        <span class=\"n\">content_type</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;application/pdf&#39;</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">HttpResponse</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">file_attachment</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(),</span> <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"n\">content_type</span><span class=\"p\">)</span>\n    <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;comment-attachment-</span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">file_attachment</span><span class=\"o\">.</span><span class=\"n\">name</span>\n    <span class=\"n\">response</span><span class=\"p\">[</span><span class=\"s1\">&#39;Content-Disposition&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;filename=&#39;</span> <span class=\"o\">+</span> <span class=\"n\">filename</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">response</span></div>\n</pre></div>"}