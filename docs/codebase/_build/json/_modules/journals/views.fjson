{"customsidebar": null, "body": "<h1>Source code for journals.views</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n<span class=\"kn\">import</span> <span class=\"nn\">json</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">import</span> <span class=\"nn\">random</span>\n<span class=\"kn\">import</span> <span class=\"nn\">requests</span>\n<span class=\"kn\">import</span> <span class=\"nn\">shutil</span>\n<span class=\"kn\">import</span> <span class=\"nn\">string</span>\n<span class=\"kn\">import</span> <span class=\"nn\">xml.etree.ElementTree</span> <span class=\"k\">as</span> <span class=\"nn\">ET</span>\n\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.auth.decorators</span> <span class=\"k\">import</span> <span class=\"n\">login_required</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.contenttypes.models</span> <span class=\"k\">import</span> <span class=\"n\">ContentType</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.paginator</span> <span class=\"k\">import</span> <span class=\"n\">Paginator</span><span class=\"p\">,</span> <span class=\"n\">EmptyPage</span><span class=\"p\">,</span> <span class=\"n\">PageNotAnInteger</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.urlresolvers</span> <span class=\"k\">import</span> <span class=\"n\">reverse</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"k\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib</span> <span class=\"k\">import</span> <span class=\"n\">messages</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"k\">import</span> <span class=\"n\">transaction</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.http</span> <span class=\"k\">import</span> <span class=\"n\">Http404</span><span class=\"p\">,</span> <span class=\"n\">HttpResponse</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"k\">import</span> <span class=\"n\">timezone</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.shortcuts</span> <span class=\"k\">import</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">,</span> <span class=\"n\">render</span><span class=\"p\">,</span> <span class=\"n\">redirect</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.exceptions</span> <span class=\"k\">import</span> <span class=\"n\">PaperNumberingError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.helpers</span> <span class=\"k\">import</span> <span class=\"n\">paper_nr_string</span><span class=\"p\">,</span> <span class=\"n\">issue_doi_label_from_doi_label</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.models</span> <span class=\"k\">import</span> <span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">Issue</span><span class=\"p\">,</span> <span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">Deposit</span><span class=\"p\">,</span> <span class=\"n\">DOAJDeposit</span><span class=\"p\">,</span>\\\n                    <span class=\"n\">GenericDOIDeposit</span><span class=\"p\">,</span> <span class=\"n\">PublicationAuthorsTable</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.forms</span> <span class=\"k\">import</span> <span class=\"n\">FundingInfoForm</span><span class=\"p\">,</span> <span class=\"n\">InitiatePublicationForm</span><span class=\"p\">,</span> <span class=\"n\">ValidatePublicationForm</span><span class=\"p\">,</span>\\\n                   <span class=\"n\">UnregisteredAuthorForm</span><span class=\"p\">,</span> <span class=\"n\">CreateMetadataXMLForm</span><span class=\"p\">,</span> <span class=\"n\">CitationListBibitemsForm</span><span class=\"p\">,</span>\\\n                   <span class=\"n\">ReferenceFormSet</span><span class=\"p\">,</span> <span class=\"n\">CreateMetadataDOAJForm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.utils</span> <span class=\"k\">import</span> <span class=\"n\">JournalUtils</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">comments.models</span> <span class=\"k\">import</span> <span class=\"n\">Comment</span>\n<span class=\"kn\">from</span> <span class=\"nn\">funders.models</span> <span class=\"k\">import</span> <span class=\"n\">Funder</span>\n<span class=\"kn\">from</span> <span class=\"nn\">submissions.models</span> <span class=\"k\">import</span> <span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">Report</span>\n<span class=\"kn\">from</span> <span class=\"nn\">scipost.models</span> <span class=\"k\">import</span> <span class=\"n\">Contributor</span>\n<span class=\"kn\">from</span> <span class=\"nn\">production.constants</span> <span class=\"k\">import</span> <span class=\"n\">PROOFS_PUBLISHED</span>\n<span class=\"kn\">from</span> <span class=\"nn\">production.models</span> <span class=\"k\">import</span> <span class=\"n\">ProductionEvent</span>\n<span class=\"kn\">from</span> <span class=\"nn\">production.signals</span> <span class=\"k\">import</span> <span class=\"n\">notify_stream_status_change</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">funders.forms</span> <span class=\"k\">import</span> <span class=\"n\">FunderSelectForm</span><span class=\"p\">,</span> <span class=\"n\">GrantSelectForm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">scipost.forms</span> <span class=\"k\">import</span> <span class=\"n\">ConfirmationForm</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">guardian.decorators</span> <span class=\"k\">import</span> <span class=\"n\">permission_required</span>\n\n\n<span class=\"c1\">############</span>\n<span class=\"c1\"># Journals</span>\n<span class=\"c1\">############</span>\n\n<div class=\"viewcode-block\" id=\"journals\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.journals\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">journals</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&#39;&#39;&#39;Main landing page for Journals application.&#39;&#39;&#39;</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;journals&#39;</span><span class=\"p\">:</span> <span class=\"n\">Journal</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/journals.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">landing_page</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n    <span class=\"n\">current_issue</span> <span class=\"o\">=</span> <span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">(</span>\n        <span class=\"n\">in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">,</span>\n        <span class=\"n\">start_date__lte</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n        <span class=\"n\">until_date__gte</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">())</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-until_date&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n    <span class=\"n\">latest_issue</span> <span class=\"o\">=</span> <span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">(</span>\n        <span class=\"n\">in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">,</span>\n        <span class=\"n\">until_date__lte</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">())</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-until_date&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">()</span>\n\n    <span class=\"n\">prev_issue</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">if</span> <span class=\"n\">current_issue</span><span class=\"p\">:</span>\n        <span class=\"n\">prev_issue</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">(</span><span class=\"n\">in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">,</span>\n                                              <span class=\"n\">start_date__lt</span><span class=\"o\">=</span><span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">start_date</span><span class=\"p\">)</span>\n                                   <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;start_date&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">last</span><span class=\"p\">())</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;current_issue&#39;</span><span class=\"p\">:</span> <span class=\"n\">current_issue</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;latest_issue&#39;</span><span class=\"p\">:</span> <span class=\"n\">latest_issue</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;prev_issue&#39;</span><span class=\"p\">:</span> <span class=\"n\">prev_issue</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/journal_landing_page.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">issues</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n    <span class=\"n\">issues</span> <span class=\"o\">=</span> <span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">(</span><span class=\"n\">in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-until_date&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;issues&#39;</span><span class=\"p\">:</span> <span class=\"n\">issues</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/journal_issues.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"recent\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.recent\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">recent</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Display page for the most recent 20 publications in SciPost Physics.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">recent_papers</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">(</span>\n        <span class=\"n\">in_issue__in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-publication_date&#39;</span><span class=\"p\">,</span>\n                                                          <span class=\"s1\">&#39;-paper_nr&#39;</span><span class=\"p\">)[:</span><span class=\"mi\">20</span><span class=\"p\">]</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;recent_papers&#39;</span><span class=\"p\">:</span> <span class=\"n\">recent_papers</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/journal_recent.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"accepted\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.accepted\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">accepted</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Display page for submissions to SciPost Physics which</span>\n<span class=\"sd\">    have been accepted but are not yet published.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">accepted_SP_submissions</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">()</span>\n                               <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">submitted_to_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                               <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-latest_activity&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;accepted_SP_submissions&#39;</span><span class=\"p\">:</span> <span class=\"n\">accepted_SP_submissions</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/journal_accepted.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">info_for_authors</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/</span><span class=\"si\">%s</span><span class=\"s1\">_info_for_authors.html&#39;</span> <span class=\"o\">%</span> <span class=\"n\">doi_label</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">about</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/</span><span class=\"si\">%s</span><span class=\"s1\">_about.html&#39;</span> <span class=\"o\">%</span> <span class=\"n\">doi_label</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">issue_detail</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">issue</span> <span class=\"o\">=</span> <span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get_published</span><span class=\"p\">(</span><span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span>\n\n    <span class=\"n\">papers</span> <span class=\"o\">=</span> <span class=\"n\">issue</span><span class=\"o\">.</span><span class=\"n\">publication_set</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;paper_nr&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">next_issue</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">(</span><span class=\"n\">in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">,</span>\n                                          <span class=\"n\">start_date__gt</span><span class=\"o\">=</span><span class=\"n\">issue</span><span class=\"o\">.</span><span class=\"n\">start_date</span><span class=\"p\">)</span>\n                               <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;start_date&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">())</span>\n    <span class=\"n\">prev_issue</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">(</span><span class=\"n\">in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">,</span>\n                                          <span class=\"n\">start_date__lt</span><span class=\"o\">=</span><span class=\"n\">issue</span><span class=\"o\">.</span><span class=\"n\">start_date</span><span class=\"p\">)</span>\n                               <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;start_date&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">last</span><span class=\"p\">())</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;issue&#39;</span><span class=\"p\">:</span> <span class=\"n\">issue</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;prev_issue&#39;</span><span class=\"p\">:</span> <span class=\"n\">prev_issue</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;next_issue&#39;</span><span class=\"p\">:</span> <span class=\"n\">next_issue</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;papers&#39;</span><span class=\"p\">:</span> <span class=\"n\">papers</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/journal_issue_detail.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"c1\">#######################</span>\n<span class=\"c1\"># Publication process #</span>\n<span class=\"c1\">#######################</span>\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"initiate_publication\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.initiate_publication\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">initiate_publication</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Called by an Editorial Administrator.</span>\n<span class=\"sd\">    Publish the manuscript after proofs have been accepted.</span>\n<span class=\"sd\">    This method prefills a ValidatePublicationForm for further</span>\n<span class=\"sd\">    processing (verification in validate_publication method).</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">initiate_publication_form</span> <span class=\"o\">=</span> <span class=\"n\">InitiatePublicationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">initiate_publication_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">initiate_publication_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;accepted_submission&#39;</span><span class=\"p\">]</span>\n        <span class=\"n\">current_issue</span> <span class=\"o\">=</span> <span class=\"n\">initiate_publication_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;to_be_issued_in&#39;</span><span class=\"p\">]</span>\n\n        <span class=\"c1\"># Determine next available paper number:</span>\n        <span class=\"n\">paper_nr</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">in_issue__in_volume</span><span class=\"o\">=</span><span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">paper_nr</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n        <span class=\"k\">if</span> <span class=\"n\">paper_nr</span> <span class=\"o\">&gt;</span> <span class=\"mi\">999</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">PaperNumberingError</span><span class=\"p\">(</span><span class=\"n\">paper_nr</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Build form data</span>\n        <span class=\"n\">doi_label</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span><span class=\"o\">.</span><span class=\"n\">name</span>\n            <span class=\"o\">+</span> <span class=\"s1\">&#39;.&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">number</span><span class=\"p\">)</span>\n            <span class=\"o\">+</span> <span class=\"s1\">&#39;.&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">number</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;.&#39;</span> <span class=\"o\">+</span> <span class=\"n\">paper_nr_string</span><span class=\"p\">(</span><span class=\"n\">paper_nr</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">doi_string</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;10.21468/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">doi_label</span>\n        <span class=\"n\">BiBTeX_entry</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"s1\">&#39;@Article{&#39;</span> <span class=\"o\">+</span> <span class=\"n\">doi_label</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;,</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">title={{&#39;</span> <span class=\"o\">+</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">title</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;}},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">author={&#39;</span> <span class=\"o\">+</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">author_list</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;,&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39; and&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">journal={&#39;</span>\n            <span class=\"o\">+</span> <span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span><span class=\"o\">.</span><span class=\"n\">get_abbreviation_citation</span><span class=\"p\">()</span>\n            <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">volume={&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">number</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">issue={&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">number</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">pages={&#39;</span> <span class=\"o\">+</span> <span class=\"n\">paper_nr_string</span><span class=\"p\">(</span><span class=\"n\">paper_nr</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">year={&#39;</span> <span class=\"o\">+</span> <span class=\"n\">current_issue</span><span class=\"o\">.</span><span class=\"n\">until_date</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%Y&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">publisher=</span><span class=\"si\">{SciPost}</span><span class=\"s1\">,</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">doi={&#39;</span> <span class=\"o\">+</span> <span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">url={https://scipost.org/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;},</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">initial</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s1\">&#39;accepted_submission&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;in_issue&#39;</span><span class=\"p\">:</span> <span class=\"n\">current_issue</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;paper_nr&#39;</span><span class=\"p\">:</span> <span class=\"n\">paper_nr</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;discipline&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">discipline</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;domain&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">domain</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;subject_area&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">subject_area</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;secondary_areas&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">secondary_areas</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;title&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">title</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;author_list&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">author_list</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;abstract&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">abstract</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;BiBTeX_entry&#39;</span><span class=\"p\">:</span> <span class=\"n\">BiBTeX_entry</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">doi_label</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;acceptance_date&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">acceptance_date</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;submission_date&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">submission_date</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;publication_date&#39;</span><span class=\"p\">:</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n        <span class=\"p\">}</span>\n        <span class=\"n\">validate_publication_form</span> <span class=\"o\">=</span> <span class=\"n\">ValidatePublicationForm</span><span class=\"p\">(</span><span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">initial</span><span class=\"p\">)</span>\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;validate_publication_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">validate_publication_form</span><span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/validate_publication.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;initiate_publication_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">initiate_publication_form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/initiate_publication.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"validate_publication\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.validate_publication\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">validate_publication</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This creates a Publication instance from the ValidatePublicationForm,</span>\n<span class=\"sd\">    pre-filled by the initiate_publication method above.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># TODO: move from uploads to Journal folder</span>\n    <span class=\"c1\"># TODO: create metadata</span>\n    <span class=\"c1\"># TODO: set DOI, register with Crossref</span>\n    <span class=\"c1\"># TODO: add funding info</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"n\">validate_publication_form</span> <span class=\"o\">=</span> <span class=\"n\">ValidatePublicationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n                                                        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">validate_publication_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">validate_publication_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Fill remaining data</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">accepted_submission</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">submission_author</span> <span class=\"ow\">in</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n            <span class=\"n\">PublicationAuthorsTable</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>\n                <span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span> <span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">submission_author</span><span class=\"p\">)</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">())</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">())</span>\n\n        <span class=\"c1\"># Add Institutions to the publication</span>\n        <span class=\"k\">for</span> <span class=\"n\">author</span> <span class=\"ow\">in</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors_registered</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n            <span class=\"k\">for</span> <span class=\"n\">current_affiliation</span> <span class=\"ow\">in</span> <span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">affiliations</span><span class=\"o\">.</span><span class=\"n\">active</span><span class=\"p\">():</span>\n                <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">institutions</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">current_affiliation</span><span class=\"o\">.</span><span class=\"n\">institution</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Save the beast</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Move file to final location</span>\n        <span class=\"n\">initial_path</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">pdf_file</span><span class=\"o\">.</span><span class=\"n\">path</span>\n        <span class=\"n\">new_dir</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">path</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/&#39;</span>\n                   <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_paper_nr</span><span class=\"p\">())</span>\n        <span class=\"n\">new_path</span> <span class=\"o\">=</span> <span class=\"n\">new_dir</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;.pdf&#39;</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span><span class=\"p\">(</span><span class=\"n\">new_dir</span><span class=\"p\">)</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rename</span><span class=\"p\">(</span><span class=\"n\">initial_path</span><span class=\"p\">,</span> <span class=\"n\">new_path</span><span class=\"p\">)</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">pdf_file</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">new_path</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Mark the submission as having been published:</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">published_as</span> <span class=\"o\">=</span> <span class=\"n\">publication</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;published&#39;</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Update ProductionStream</span>\n        <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">submission</span><span class=\"p\">,</span> <span class=\"s1\">&#39;production_stream&#39;</span><span class=\"p\">):</span>\n            <span class=\"n\">stream</span> <span class=\"o\">=</span> <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">production_stream</span>\n            <span class=\"n\">stream</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"n\">PROOFS_PUBLISHED</span>\n            <span class=\"n\">stream</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">production_user</span><span class=\"p\">:</span>\n                <span class=\"n\">prodevent</span> <span class=\"o\">=</span> <span class=\"n\">ProductionEvent</span><span class=\"p\">(</span>\n                    <span class=\"n\">stream</span><span class=\"o\">=</span><span class=\"n\">stream</span><span class=\"p\">,</span>\n                    <span class=\"n\">event</span><span class=\"o\">=</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">,</span>\n                    <span class=\"n\">comments</span><span class=\"o\">=</span><span class=\"s1\">&#39; published the manuscript.&#39;</span><span class=\"p\">,</span>\n                    <span class=\"n\">noted_by</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">production_user</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">prodevent</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"n\">notify_stream_status_change</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"n\">stream</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># TODO: Create a Commentary Page</span>\n        <span class=\"c1\"># Email authors</span>\n        <span class=\"n\">JournalUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">})</span>\n        <span class=\"n\">JournalUtils</span><span class=\"o\">.</span><span class=\"n\">send_authors_paper_published_email</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Add SubmissionEvents</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">add_general_event</span><span class=\"p\">(</span><span class=\"s1\">&#39;The Submission has been published as </span><span class=\"si\">%s</span><span class=\"s1\">.&#39;</span>\n                                     <span class=\"o\">%</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;The publication has been validated.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;errormessage&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;The form was invalid.&#39;</span>\n\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;validate_publication_form&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">validate_publication_form</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/validate_publication.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">manage_metadata</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">issue_doi_label</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"n\">issues</span> <span class=\"o\">=</span> <span class=\"n\">Issue</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-until_date&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">publications</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"n\">doi_label</span><span class=\"p\">:</span>\n        <span class=\"n\">issue_doi_label</span> <span class=\"o\">=</span> <span class=\"n\">issue_doi_label_from_doi_label</span><span class=\"p\">(</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">issue_doi_label</span><span class=\"p\">:</span>\n        <span class=\"n\">publications</span> <span class=\"o\">=</span> <span class=\"n\">publications</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">in_issue__doi_label</span><span class=\"o\">=</span><span class=\"n\">issue_doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">publications</span> <span class=\"o\">=</span> <span class=\"n\">publications</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-publication_date&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-paper_nr&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">associate_grant_form</span> <span class=\"o\">=</span> <span class=\"n\">GrantSelectForm</span><span class=\"p\">()</span>\n    <span class=\"n\">associate_generic_funder_form</span> <span class=\"o\">=</span> <span class=\"n\">FunderSelectForm</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;issues&#39;</span><span class=\"p\">:</span> <span class=\"n\">issues</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;issue_doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">issue_doi_label</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;publications&#39;</span><span class=\"p\">:</span> <span class=\"n\">publications</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;associate_grant_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">associate_grant_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;associate_generic_funder_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">associate_generic_funder_form</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/manage_metadata.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">mark_first_author</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">publication_id</span><span class=\"p\">,</span> <span class=\"n\">author_object_id</span><span class=\"p\">):</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">publication_id</span><span class=\"p\">)</span>\n    <span class=\"n\">author_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">author_object_id</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Redo ordering</span>\n    <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">order</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n    <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"n\">author_objects</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span>\n    <span class=\"n\">count</span> <span class=\"o\">=</span> <span class=\"mi\">2</span>\n    <span class=\"k\">for</span> <span class=\"n\">author</span> <span class=\"ow\">in</span> <span class=\"n\">author_objects</span><span class=\"p\">:</span>\n        <span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">order</span> <span class=\"o\">=</span> <span class=\"n\">count</span>\n        <span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">count</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Marked </span><span class=\"si\">{}</span><span class=\"s1\"> first author&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">author_object</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"add_author\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.add_author\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">add_author</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">unregistered_author_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    If not all authors are registered Contributors or if they have not</span>\n<span class=\"sd\">    all claimed authorship, this method allows editorial administrators</span>\n<span class=\"sd\">    to associated them to the publication.</span>\n<span class=\"sd\">    This is important for the Crossref metadata, in which all authors must appear.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">contributor_id</span><span class=\"p\">:</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">)</span>\n        <span class=\"n\">PublicationAuthorsTable</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">)</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Added </span><span class=\"si\">{}</span><span class=\"s1\"> as an author.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n\n    <span class=\"n\">contributors_found</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">UnregisteredAuthorForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">and</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">unregistered_author</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">PublicationAuthorsTable</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>\n            <span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span>\n            <span class=\"n\">unregistered_author</span><span class=\"o\">=</span><span class=\"n\">unregistered_author</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Added </span><span class=\"si\">{}</span><span class=\"s1\"> as an unregistered author.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">unregistered_author</span>\n        <span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n    <span class=\"k\">elif</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">contributors_found</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">user__last_name__icontains</span><span class=\"o\">=</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;last_name&#39;</span><span class=\"p\">])</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;contributors_found&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributors_found</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/add_author.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"create_citation_list_metadata\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.create_citation_list_metadata\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">create_citation_list_metadata</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Called by an Editorial Administrator.</span>\n<span class=\"sd\">    This populates the citation_list dictionary entry</span>\n<span class=\"sd\">    in the metadata field in a Publication instance.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">bibitems_form</span> <span class=\"o\">=</span> <span class=\"n\">CitationListBibitemsForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">FILES</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">bibitems_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata</span><span class=\"p\">[</span><span class=\"s1\">&#39;citation_list&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">bibitems_form</span><span class=\"o\">.</span><span class=\"n\">extract_dois</span><span class=\"p\">()</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Updated citation list&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:create_citation_list_metadata&#39;</span><span class=\"p\">,</span>\n                        <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;bibitems_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">bibitems_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;citation_list&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;citation_list&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/create_citation_list_metadata.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"update_references\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.update_references\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">update_references</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Update the References for a certain Publication.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">references</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">references</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n\n    <span class=\"n\">formset</span> <span class=\"o\">=</span> <span class=\"n\">ReferenceFormSet</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">queryset</span><span class=\"o\">=</span><span class=\"n\">references</span><span class=\"p\">,</span> <span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span>\n                               <span class=\"n\">extra</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;extra&#39;</span><span class=\"p\">))</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;prefill&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">prefill</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;References saved&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;formset&#39;</span><span class=\"p\">:</span> <span class=\"n\">formset</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/update_references.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"create_funding_info_metadata\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.create_funding_info_metadata\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">create_funding_info_metadata</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Called by an Editorial Administrator.</span>\n<span class=\"sd\">    This populates the funding_info dictionary entry</span>\n<span class=\"sd\">    in the metadata field in a Publication instance.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n    <span class=\"n\">funding_statement</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;funding_statement&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">initial</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;funding_statement&#39;</span><span class=\"p\">:</span> <span class=\"n\">funding_statement</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">FundingInfoForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">initial</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Updated funding info&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:create_funding_info_metadata&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;funding_info_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;funding_statement&#39;</span><span class=\"p\">:</span> <span class=\"n\">funding_statement</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/create_funding_info_metadata.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"add_associated_grant\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.add_associated_grant\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">add_associated_grant</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Called by an Editorial Administrator.</span>\n<span class=\"sd\">    This associates a grant from the database to this publication.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">grant_select_form</span> <span class=\"o\">=</span> <span class=\"n\">GrantSelectForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">grant_select_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">grants</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">grant_select_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;grant&#39;</span><span class=\"p\">])</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Grant added to publication </span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"add_generic_funder\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.add_generic_funder\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">add_generic_funder</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Called by an Editorial Administrator.</span>\n<span class=\"sd\">    This associates a funder (generic, not via grant) from the database to this publication.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">funder_select_form</span> <span class=\"o\">=</span> <span class=\"n\">FunderSelectForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">funder_select_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">funders_generic</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">funder_select_form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;funder&#39;</span><span class=\"p\">])</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Generic funder added to publication </span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">doi_label</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"create_metadata_xml\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.create_metadata_xml\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">create_metadata_xml</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    To be called by an EdAdmin after the citation_list,</span>\n<span class=\"sd\">    funding_info entries have been filled.</span>\n<span class=\"sd\">    Populates the metadata_xml field of a Publication instance.</span>\n<span class=\"sd\">    The contents can then be sent to Crossref for registration.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># create a doi_batch_id</span>\n    <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n    <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">):</span>\n        <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"n\">salt</span> <span class=\"o\">+</span> <span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">choice</span><span class=\"p\">(</span><span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">ascii_letters</span><span class=\"p\">)</span>\n    <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"n\">salt</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf8&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">idsalt</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">title</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span>\n    <span class=\"n\">idsalt</span> <span class=\"o\">=</span> <span class=\"n\">idsalt</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf8&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">doi_batch_id</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span><span class=\"p\">(</span><span class=\"n\">salt</span><span class=\"o\">+</span><span class=\"n\">idsalt</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span><span class=\"p\">()</span>\n\n    <span class=\"n\">initial</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">}</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi_batch version=&quot;4.4.0&quot; xmlns=&quot;http://www.crossref.org/schema/4.4.0&quot; &#39;</span>\n        <span class=\"s1\">&#39;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &#39;</span>\n        <span class=\"s1\">&#39;xmlns:fr=&quot;http://www.crossref.org/fundref.xsd&quot; &#39;</span>\n        <span class=\"s1\">&#39;xsi:schemaLocation=&quot;http://www.crossref.org/schema/4.4.0 &#39;</span>\n        <span class=\"s1\">&#39;http://www.crossref.org/shema/deposit/crossref4.4.0.xsd&quot; &#39;</span>\n        <span class=\"s1\">&#39;xmlns:ai=&quot;http://www.crossref.org/AccessIndicators.xsd&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;head&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi_batch_id&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">doi_batch_id</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi_batch_id&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;timestamp&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%Y%m</span><span class=\"si\">%d</span><span class=\"s1\">%H%M%S&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/timestamp&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;depositor&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;depositor_name&gt;scipost&lt;/depositor_name&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;email_address&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_DEPOSIT_EMAIL</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/email_address&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/depositor&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;registrant&gt;scipost&lt;/registrant&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/head&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;body&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;journal&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;journal_metadata&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;full_title&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span><span class=\"o\">.</span><span class=\"n\">get_name_display</span><span class=\"p\">()</span>\n        <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/full_title&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;abbrev_title&gt;&#39;</span>\n        <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span><span class=\"o\">.</span><span class=\"n\">get_abbreviation_citation</span><span class=\"p\">()</span> <span class=\"o\">+</span>\n        <span class=\"s1\">&#39;&lt;/abbrev_title&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;issn media_type=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">electronic</span><span class=\"se\">\\&#39;</span><span class=\"s1\">&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span><span class=\"o\">.</span><span class=\"n\">issn</span>\n        <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/issn&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi_data&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;resource&gt;https://scipost.org/&#39;</span>\n        <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/resource&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/doi_data&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/journal_metadata&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;journal_issue&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;publication_date media_type=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">online</span><span class=\"se\">\\&#39;</span><span class=\"s1\">&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;year&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">publication_date</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%Y&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/year&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/publication_date&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;journal_volume&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;volume&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">number</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/volume&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/journal_volume&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;issue&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">number</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/issue&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/journal_issue&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;journal_article publication_type=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">full_text</span><span class=\"se\">\\&#39;</span><span class=\"s1\">&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;titles&gt;&lt;title&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">title</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/title&gt;&lt;/titles&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"c1\"># Precondition: all authors MUST be listed in authors field of publication instance,</span>\n    <span class=\"c1\"># this to be checked by EdAdmin before publishing.</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;contributors&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"k\">for</span> <span class=\"n\">author_object</span> <span class=\"ow\">in</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">order</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;&lt;person_name sequence=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">first</span><span class=\"se\">\\&#39;</span><span class=\"s1\"> contributor_role=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">author</span><span class=\"se\">\\&#39;</span><span class=\"s1\">&gt; &#39;</span>\n                <span class=\"s1\">&#39;&lt;given_name&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/given_name&gt; &#39;</span>\n                <span class=\"s1\">&#39;&lt;surname&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">last_name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/surname&gt; &#39;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;&lt;person_name sequence=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">additional</span><span class=\"se\">\\&#39;</span><span class=\"s1\"> contributor_role=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">author</span><span class=\"se\">\\&#39;</span><span class=\"s1\">&gt; &#39;</span>\n                <span class=\"s1\">&#39;&lt;given_name&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/given_name&gt; &#39;</span>\n                <span class=\"s1\">&#39;&lt;surname&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">last_name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/surname&gt; &#39;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">contributor</span> <span class=\"ow\">and</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">orcid_id</span><span class=\"p\">:</span>\n            <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;&lt;ORCID&gt;http://orcid.org/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">author_object</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">orcid_id</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/ORCID&gt;&#39;</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/person_name&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/contributors&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;publication_date media_type=</span><span class=\"se\">\\&#39;</span><span class=\"s1\">online</span><span class=\"se\">\\&#39;</span><span class=\"s1\">&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;month&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">publication_date</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%m&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/month&gt;&#39;</span>\n        <span class=\"s1\">&#39;&lt;day&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">publication_date</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"si\">%d</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/day&gt;&#39;</span>\n        <span class=\"s1\">&#39;&lt;year&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">publication_date</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%Y&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/year&gt;&#39;</span>\n        <span class=\"s1\">&#39;&lt;/publication_date&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;publisher_item&gt;&lt;item_number item_number_type=&quot;article_number&quot;&gt;&#39;</span>\n        <span class=\"o\">+</span> <span class=\"n\">paper_nr_string</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">paper_nr</span><span class=\"p\">)</span> <span class=\"o\">+</span>\n        <span class=\"s1\">&#39;&lt;/item_number&gt;&lt;/publisher_item&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;crossmark&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;crossmark_policy&gt;10.21468/SciPost.CrossmarkPolicy&lt;/crossmark_policy&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;crossmark_domains&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;crossmark_domain&gt;&lt;domain&gt;scipost.org&lt;/domain&gt;&lt;/crossmark_domain&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/crossmark_domains&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;crossmark_domain_exclusive&gt;false&lt;/crossmark_domain_exclusive&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"p\">)</span>\n    <span class=\"n\">funders</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Funder</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">grant__in</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">grants</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">())</span>\n               <span class=\"o\">|</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">funders_generic</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">())</span><span class=\"o\">.</span><span class=\"n\">distinct</span><span class=\"p\">()</span>\n    <span class=\"n\">nr_funders</span> <span class=\"o\">=</span> <span class=\"n\">funders</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;custom_metadata&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"k\">if</span> <span class=\"n\">nr_funders</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n        <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;fr:program name=&quot;fundref&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"k\">for</span> <span class=\"n\">funder</span> <span class=\"ow\">in</span> <span class=\"n\">funders</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">nr_funders</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n                <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;fr:assertion name=&quot;fundgroup&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;&lt;fr:assertion name=&quot;funder_name&quot;&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">funder</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n                <span class=\"s1\">&#39;&lt;fr:assertion name=&quot;funder_identifier&quot;&gt;&#39;</span>\n                <span class=\"o\">+</span> <span class=\"n\">funder</span><span class=\"o\">.</span><span class=\"n\">identifier</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/fr:assertion&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n                <span class=\"s1\">&#39;&lt;/fr:assertion&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">grant</span> <span class=\"ow\">in</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">grants</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n                <span class=\"k\">if</span> <span class=\"n\">grant</span><span class=\"o\">.</span><span class=\"n\">funder</span> <span class=\"o\">==</span> <span class=\"n\">funder</span><span class=\"p\">:</span>\n                    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                        <span class=\"s1\">&#39;&lt;fr:assertion name=&quot;award_number&quot;&gt;&#39;</span>\n                        <span class=\"o\">+</span> <span class=\"n\">grant</span><span class=\"o\">.</span><span class=\"n\">number</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/fr:assertion&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">nr_funders</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n                <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/fr:assertion&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/fr:program&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;ai:program name=&quot;AccessIndicators&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;ai:license_ref&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_cc_license_URI</span><span class=\"p\">()</span> <span class=\"o\">+</span>\n        <span class=\"s1\">&#39;&lt;/ai:license_ref&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/ai:program&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/custom_metadata&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;/crossmark&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;archive_locations&gt;&lt;archive name=&quot;CLOCKSS&quot;&gt;&lt;/archive&gt;&lt;/archive_locations&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi_data&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;resource&gt;https://scipost.org/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/resource&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;collection property=&quot;crawler-based&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;item crawler=&quot;iParadigms&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;resource&gt;https://scipost.org/&#39;</span>\n        <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/pdf&lt;/resource&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/item&gt;&lt;/collection&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;collection property=&quot;text-mining&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;item&gt;&lt;resource mime_type=&quot;application/pdf&quot;&gt;&#39;</span>\n        <span class=\"s1\">&#39;https://scipost.org/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/pdf&lt;/resource&gt;&lt;/item&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/collection&gt;&#39;</span>\n        <span class=\"s1\">&#39;&lt;/doi_data&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata</span><span class=\"p\">[</span><span class=\"s1\">&#39;citation_list&#39;</span><span class=\"p\">]:</span>\n            <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;citation_list&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata</span><span class=\"p\">[</span><span class=\"s1\">&#39;citation_list&#39;</span><span class=\"p\">]:</span>\n                <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                    <span class=\"s1\">&#39;&lt;citation key=&quot;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">ref</span><span class=\"p\">[</span><span class=\"s1\">&#39;key&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&quot;&gt;&#39;</span>\n                    <span class=\"s1\">&#39;&lt;doi&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">ref</span><span class=\"p\">[</span><span class=\"s1\">&#39;doi&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi&gt;&#39;</span>\n                    <span class=\"s1\">&#39;&lt;/citation&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n                <span class=\"p\">)</span>\n        <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/citation_list&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"k\">except</span> <span class=\"ne\">KeyError</span><span class=\"p\">:</span>\n        <span class=\"k\">pass</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;/journal_article&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/journal&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">initial</span><span class=\"p\">[</span><span class=\"s1\">&#39;metadata_xml&#39;</span><span class=\"p\">]</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;/body&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&lt;/doi_batch&gt;&#39;</span>\n\n    <span class=\"n\">create_metadata_xml_form</span> <span class=\"o\">=</span> <span class=\"n\">CreateMetadataXMLForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">initial</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">create_metadata_xml_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">create_metadata_xml_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Metadata XML saved&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n\n    <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">latest_metadata_update</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n    <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;create_metadata_xml_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">create_metadata_xml_form</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/create_metadata_xml.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"metadata_xml_deposit\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.metadata_xml_deposit\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">metadata_xml_deposit</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">,</span> <span class=\"n\">option</span><span class=\"o\">=</span><span class=\"s1\">&#39;test&#39;</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Crossref metadata deposit.</span>\n<span class=\"sd\">    If test==True, test the metadata_xml using the Crossref test server.</span>\n<span class=\"sd\">    Makes use of the python requests module.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_xml</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span>\n            <span class=\"n\">request</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;This publication has no metadata. Produce it first before saving it.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:create_metadata_xml&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n\n    <span class=\"n\">timestamp</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_xml</span><span class=\"o\">.</span><span class=\"n\">partition</span><span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;timestamp&gt;&#39;</span><span class=\"p\">))[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">partition</span><span class=\"p\">(</span><span class=\"s1\">&#39;&lt;/timestamp&gt;&#39;</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"n\">doi_batch_id</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_xml</span><span class=\"o\">.</span><span class=\"n\">partition</span><span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;doi_batch_id&gt;&#39;</span><span class=\"p\">))[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">partition</span><span class=\"p\">(</span><span class=\"s1\">&#39;&lt;/doi_batch_id&gt;&#39;</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">path</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/&#39;</span>\n            <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_paper_nr</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">)</span>\n            <span class=\"o\">+</span> <span class=\"s1\">&#39;_Crossref_&#39;</span> <span class=\"o\">+</span> <span class=\"n\">timestamp</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;.xml&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">valid</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">response_headers</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">response_text</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Deposit already done before.</span>\n        <span class=\"n\">valid</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"c1\"># New deposit, go for it.</span>\n        <span class=\"k\">if</span> <span class=\"n\">option</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;deposit&#39;</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">DEBUG</span><span class=\"p\">:</span>\n            <span class=\"c1\"># CAUTION: Real deposit only on production (non-debug-mode)</span>\n            <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;http://doi.crossref.org/servlet/deposit&#39;</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;http://test.crossref.org/servlet/deposit&#39;</span>\n\n        <span class=\"c1\"># First perform the actual deposit to Crossref</span>\n        <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s1\">&#39;operation&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;doMDUpload&#39;</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;login_id&#39;</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_LOGIN_ID</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;login_passwd&#39;</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_LOGIN_PASSWORD</span><span class=\"p\">,</span>\n            <span class=\"p\">}</span>\n        <span class=\"n\">files</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s1\">&#39;fname&#39;</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"s1\">&#39;metadata.xml&#39;</span><span class=\"p\">,</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_xml</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf-8&#39;</span><span class=\"p\">),</span> <span class=\"s1\">&#39;multipart/form-data&#39;</span><span class=\"p\">)</span>\n        <span class=\"p\">}</span>\n        <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">files</span><span class=\"o\">=</span><span class=\"n\">files</span><span class=\"p\">)</span>\n        <span class=\"n\">response_headers</span> <span class=\"o\">=</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">headers</span>\n        <span class=\"n\">response_text</span> <span class=\"o\">=</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span>\n\n        <span class=\"c1\"># Then create the associated Deposit object (saving the metadata to a file)</span>\n        <span class=\"k\">if</span> <span class=\"n\">option</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;deposit&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">deposit</span> <span class=\"o\">=</span> <span class=\"n\">Deposit</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span>\n                              <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">timestamp</span><span class=\"p\">,</span>\n                              <span class=\"n\">doi_batch_id</span><span class=\"o\">=</span><span class=\"n\">doi_batch_id</span><span class=\"p\">,</span>\n                              <span class=\"n\">metadata_xml</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_xml</span><span class=\"p\">,</span>\n                              <span class=\"n\">deposition_date</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">())</span>\n            <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">response_text</span> <span class=\"o\">=</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span>\n\n            <span class=\"c1\"># Save the filename with timestamp</span>\n            <span class=\"n\">path_with_timestamp</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"si\">{issue}</span><span class=\"s1\">/</span><span class=\"si\">{paper}</span><span class=\"s1\">/</span><span class=\"si\">{doi}</span><span class=\"s1\">_Crossref_</span><span class=\"si\">{timestamp}</span><span class=\"s1\">.xml&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">issue</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">,</span>\n                <span class=\"n\">paper</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_paper_nr</span><span class=\"p\">(),</span>\n                <span class=\"n\">doi</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">),</span>\n                <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">timestamp</span><span class=\"p\">)</span>\n            <span class=\"n\">f</span> <span class=\"o\">=</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">path_with_timestamp</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">,</span> <span class=\"n\">encoding</span><span class=\"o\">=</span><span class=\"s1\">&#39;utf-8&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_xml</span><span class=\"p\">)</span>\n            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n            <span class=\"c1\"># Copy file</span>\n            <span class=\"n\">path_without_timestamp</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"si\">{issue}</span><span class=\"s1\">/</span><span class=\"si\">{paper}</span><span class=\"s1\">/</span><span class=\"si\">{doi}</span><span class=\"s1\">_Crossref.xml&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">issue</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">,</span>\n                <span class=\"n\">paper</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_paper_nr</span><span class=\"p\">(),</span>\n                <span class=\"n\">doi</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">))</span>\n            <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copyfile</span><span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">path_with_timestamp</span><span class=\"p\">,</span>\n                            <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">path_without_timestamp</span><span class=\"p\">)</span>\n\n            <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">metadata_xml_file</span> <span class=\"o\">=</span> <span class=\"n\">path_with_timestamp</span>\n            <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">latest_crossref_deposit</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n            <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;option&#39;</span><span class=\"p\">:</span> <span class=\"n\">option</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;response_headers&#39;</span><span class=\"p\">:</span> <span class=\"n\">response_headers</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;response_text&#39;</span><span class=\"p\">:</span> <span class=\"n\">response_text</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;valid&#39;</span><span class=\"p\">:</span> <span class=\"n\">valid</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/metadata_xml_deposit.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">mark_deposit_success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">deposit_id</span><span class=\"p\">,</span> <span class=\"n\">success</span><span class=\"p\">):</span>\n    <span class=\"n\">deposit</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Deposit</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">deposit_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">success</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">deposit_successful</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"k\">elif</span> <span class=\"n\">success</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">deposit_successful</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n    <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">produce_metadata_DOAJ</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">CreateMetadataDOAJForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&lt;h3&gt;</span><span class=\"si\">%s</span><span class=\"s1\">&lt;/h3&gt;Successfully produced metadata DOAJ.&#39;</span>\n                                  <span class=\"o\">%</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/metadata_doaj_create.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"metadata_DOAJ_deposit\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.metadata_DOAJ_deposit\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">metadata_DOAJ_deposit</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    DOAJ metadata deposit.</span>\n<span class=\"sd\">    Makes use of the python requests module.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_DOAJ</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&lt;h3&gt;</span><span class=\"si\">%s</span><span class=\"s1\">&lt;/h3&gt;Failed: please first produce &#39;</span>\n                                  <span class=\"s1\">&#39;DOAJ metadata before depositing.&#39;</span> <span class=\"o\">%</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">))</span>\n\n    <span class=\"n\">timestamp</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_xml</span><span class=\"o\">.</span><span class=\"n\">partition</span><span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;timestamp&gt;&#39;</span><span class=\"p\">))[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">partition</span><span class=\"p\">(</span><span class=\"s1\">&#39;&lt;/timestamp&gt;&#39;</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">path</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/&#39;</span>\n            <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_paper_nr</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">)</span>\n            <span class=\"o\">+</span> <span class=\"s1\">&#39;_DOAJ_&#39;</span> <span class=\"o\">+</span> <span class=\"n\">timestamp</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;.json&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;The metadata file for this metadata timestamp already exists&#39;</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/error.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;errormessage&#39;</span><span class=\"p\">:</span> <span class=\"n\">errormessage</span><span class=\"p\">})</span>\n\n    <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;https://doaj.org/api/v1/articles&#39;</span>\n    <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;api_key&#39;</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">DOAJ_API_KEY</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">json</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_DOAJ</span><span class=\"p\">)</span>\n        <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">raise_for_status</span><span class=\"p\">()</span>\n    <span class=\"k\">except</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">HTTPError</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&lt;h3&gt;</span><span class=\"si\">%s</span><span class=\"s1\">&lt;/h3&gt;Failed: Post went wrong, response text: </span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n            <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">,</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">))</span>\n\n    <span class=\"c1\"># Then create the associated Deposit object (saving the metadata to a file)</span>\n    <span class=\"n\">deposit</span> <span class=\"o\">=</span> <span class=\"n\">DOAJDeposit</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">,</span> <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">timestamp</span><span class=\"p\">,</span>\n                          <span class=\"n\">metadata_DOAJ</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_DOAJ</span><span class=\"p\">,</span> <span class=\"n\">deposition_date</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">())</span>\n    <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">response_text</span> <span class=\"o\">=</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span>\n\n    <span class=\"c1\"># Save a copy to the filename with and without timestamp</span>\n    <span class=\"n\">path_with_timestamp</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"si\">{issue}</span><span class=\"s1\">/</span><span class=\"si\">{paper}</span><span class=\"s1\">/</span><span class=\"si\">{doi}</span><span class=\"s1\">_DOAJ_</span><span class=\"si\">{timestamp}</span><span class=\"s1\">.json&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n        <span class=\"n\">issue</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">,</span>\n        <span class=\"n\">paper</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_paper_nr</span><span class=\"p\">(),</span>\n        <span class=\"n\">doi</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">),</span>\n        <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">timestamp</span><span class=\"p\">)</span>\n    <span class=\"n\">f</span> <span class=\"o\">=</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">path_with_timestamp</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">metadata_DOAJ</span><span class=\"p\">))</span>\n    <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># Copy file</span>\n    <span class=\"n\">path_without_timestamp</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"si\">{issue}</span><span class=\"s1\">/</span><span class=\"si\">{paper}</span><span class=\"s1\">/</span><span class=\"si\">{doi}</span><span class=\"s1\">_DOAJ.json&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n        <span class=\"n\">issue</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">,</span>\n        <span class=\"n\">paper</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">get_paper_nr</span><span class=\"p\">(),</span>\n        <span class=\"n\">doi</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copyfile</span><span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">path_with_timestamp</span><span class=\"p\">,</span>\n                    <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span> <span class=\"o\">+</span> <span class=\"n\">path_without_timestamp</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Save the database entry</span>\n    <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">metadata_DOAJ_file</span> <span class=\"o\">=</span> <span class=\"n\">path_with_timestamp</span>\n    <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;&lt;h3&gt;</span><span class=\"si\">%s</span><span class=\"s1\">&lt;/h3&gt;Successfull deposit of metadata DOAJ.&#39;</span>\n                              <span class=\"o\">%</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                            <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">mark_doaj_deposit_success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">deposit_id</span><span class=\"p\">,</span> <span class=\"n\">success</span><span class=\"p\">):</span>\n    <span class=\"n\">deposit</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">DOAJDeposit</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">deposit_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">success</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">deposit_successful</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"k\">elif</span> <span class=\"n\">success</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">deposit_successful</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n    <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                    <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">harvest_citedby_list</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">publications</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-publication_date&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publications&#39;</span><span class=\"p\">:</span> <span class=\"n\">publications</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/harvest_citedby_list.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<span class=\"k\">def</span> <span class=\"nf\">harvest_citedby_links</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"c1\"># create a doi_batch_id</span>\n    <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n    <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">):</span>\n        <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"n\">salt</span> <span class=\"o\">+</span> <span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">choice</span><span class=\"p\">(</span><span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">ascii_letters</span><span class=\"p\">)</span>\n    <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"n\">salt</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf8&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">idsalt</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">title</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span>\n    <span class=\"n\">idsalt</span> <span class=\"o\">=</span> <span class=\"n\">idsalt</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf8&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">doi_batch_id</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span><span class=\"p\">(</span><span class=\"n\">salt</span><span class=\"o\">+</span><span class=\"n\">idsalt</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span><span class=\"p\">()</span>\n    <span class=\"n\">query_xml</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;?xml version = &quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;query_batch version=&quot;2.0&quot; xmlns = &quot;http://www.crossref.org/qschema/2.0&quot;&#39;</span>\n                 <span class=\"s1\">&#39;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&#39;</span>\n                 <span class=\"s1\">&#39;xsi:schemaLocation=&quot;http://www.crossref.org/qschema/2.0 &#39;</span>\n                 <span class=\"s1\">&#39;http://www.crossref.org/qschema/crossref_query_input2.0.xsd&quot;&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;head&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;email_address&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_DEPOSIT_EMAIL</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/email_address&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;doi_batch_id&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">doi_batch_id</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi_batch_id&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;/head&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;body&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;fl_query alert=&quot;false&quot;&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;doi&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;/fl_query&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;/body&gt;&#39;</span>\n                 <span class=\"s1\">&#39;&lt;/query_batch&gt;&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;http://doi.crossref.org/servlet/getForwardLinks&#39;</span>\n    <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;usr&#39;</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_LOGIN_ID</span><span class=\"p\">,</span>\n              <span class=\"s1\">&#39;pwd&#39;</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_LOGIN_PASSWORD</span><span class=\"p\">,</span>\n              <span class=\"s1\">&#39;qdata&#39;</span><span class=\"p\">:</span> <span class=\"n\">query_xml</span><span class=\"p\">,</span>\n              <span class=\"s1\">&#39;doi&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span><span class=\"p\">,</span> <span class=\"p\">}</span>\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"n\">params</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status_code</span> <span class=\"o\">==</span> <span class=\"mi\">401</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;Crossref credentials are invalid.&lt;/h3&gt;&#39;</span>\n                                   <span class=\"s1\">&#39;Please contact the SciPost Admin.&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_metadata&#39;</span><span class=\"p\">,</span>\n                                <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;doi_label&#39;</span><span class=\"p\">:</span> <span class=\"n\">doi_label</span><span class=\"p\">}))</span>\n    <span class=\"n\">response_headers</span> <span class=\"o\">=</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">headers</span>\n    <span class=\"n\">response_text</span> <span class=\"o\">=</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span>\n    <span class=\"n\">response_deserialized</span> <span class=\"o\">=</span> <span class=\"n\">ET</span><span class=\"o\">.</span><span class=\"n\">fromstring</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">)</span>\n    <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;{http://www.crossref.org/qrschema/2.0}&#39;</span>\n    <span class=\"n\">citations</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"k\">for</span> <span class=\"n\">link</span> <span class=\"ow\">in</span> <span class=\"n\">response_deserialized</span><span class=\"o\">.</span><span class=\"n\">iter</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;forward_link&#39;</span><span class=\"p\">):</span>\n        <span class=\"n\">doi</span> <span class=\"o\">=</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;doi&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n        <span class=\"n\">article_title</span> <span class=\"o\">=</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;article_title&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">journal_abbreviation</span> <span class=\"o\">=</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span>\n                <span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_abbreviation&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"n\">journal_abbreviation</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">volume</span> <span class=\"o\">=</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;volume&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n        <span class=\"k\">except</span> <span class=\"ne\">AttributeError</span><span class=\"p\">:</span>\n            <span class=\"n\">volume</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">first_page</span> <span class=\"o\">=</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;first_page&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"n\">first_page</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">item_number</span> <span class=\"o\">=</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;item_number&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"n\">item_number</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"n\">multiauthors</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"k\">for</span> <span class=\"n\">author</span> <span class=\"ow\">in</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span>\n                <span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;contributors&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">iter</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;sequence&#39;</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;first&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">first_author_given_name</span> <span class=\"o\">=</span> <span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;given_name&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n                <span class=\"n\">first_author_surname</span> <span class=\"o\">=</span> <span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;surname&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">multiauthors</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">year</span> <span class=\"o\">=</span> <span class=\"n\">link</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;journal_cite&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;year&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">text</span>\n        <span class=\"n\">citations</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">({</span><span class=\"s1\">&#39;doi&#39;</span><span class=\"p\">:</span> <span class=\"n\">doi</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;article_title&#39;</span><span class=\"p\">:</span> <span class=\"n\">article_title</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;journal_abbreviation&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal_abbreviation</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;first_author_given_name&#39;</span><span class=\"p\">:</span> <span class=\"n\">first_author_given_name</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;first_author_surname&#39;</span><span class=\"p\">:</span> <span class=\"n\">first_author_surname</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;multiauthors&#39;</span><span class=\"p\">:</span> <span class=\"n\">multiauthors</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;volume&#39;</span><span class=\"p\">:</span> <span class=\"n\">volume</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;first_page&#39;</span><span class=\"p\">:</span> <span class=\"n\">first_page</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;item_number&#39;</span><span class=\"p\">:</span> <span class=\"n\">item_number</span><span class=\"p\">,</span>\n                          <span class=\"s1\">&#39;year&#39;</span><span class=\"p\">:</span> <span class=\"n\">year</span><span class=\"p\">,</span> <span class=\"p\">})</span>\n    <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">citedby</span> <span class=\"o\">=</span> <span class=\"n\">citations</span>\n    <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">latest_citedby_update</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n    <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;response_headers&#39;</span><span class=\"p\">:</span> <span class=\"n\">response_headers</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;response_text&#39;</span><span class=\"p\">:</span> <span class=\"n\">response_text</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;response_deserialized&#39;</span><span class=\"p\">:</span> <span class=\"n\">response_deserialized</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;citations&#39;</span><span class=\"p\">:</span> <span class=\"n\">citations</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/harvest_citedby_links.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<div class=\"viewcode-block\" id=\"sign_existing_report\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.sign_existing_report\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">sign_existing_report</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">report_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Allows the author of a Report, originally submitted anonymously,</span>\n<span class=\"sd\">    to sign the Report.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">report_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">author</span> <span class=\"o\">!=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Only the author of this Report can change its anonymity status&#39;</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/error.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;errormessage&#39;</span><span class=\"p\">:</span> <span class=\"n\">errormessage</span><span class=\"p\">})</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">ConfirmationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;confirm&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;True&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">anonymous</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n            <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">doideposit_needs_updating</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Your Report is now publicly signed.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Report signing operation cancelled.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span> <span class=\"n\">report</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/sign_existing_report.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"manage_report_metadata\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.manage_report_metadata\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">manage_report_metadata</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This page offers Editorial Administrators tools for managing</span>\n<span class=\"sd\">    the metadata of Reports.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">reports</span> <span class=\"o\">=</span> <span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n    <span class=\"n\">paginator</span> <span class=\"o\">=</span> <span class=\"n\">Paginator</span><span class=\"p\">(</span><span class=\"n\">reports</span><span class=\"p\">,</span> <span class=\"mi\">25</span><span class=\"p\">)</span>\n\n    <span class=\"n\">page</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;page&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">reports</span> <span class=\"o\">=</span> <span class=\"n\">paginator</span><span class=\"o\">.</span><span class=\"n\">page</span><span class=\"p\">(</span><span class=\"n\">page</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">PageNotAnInteger</span><span class=\"p\">:</span>\n        <span class=\"n\">reports</span> <span class=\"o\">=</span> <span class=\"n\">paginator</span><span class=\"o\">.</span><span class=\"n\">page</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">EmptyPage</span><span class=\"p\">:</span>\n        <span class=\"n\">reports</span> <span class=\"o\">=</span> <span class=\"n\">paginator</span><span class=\"o\">.</span><span class=\"n\">page</span><span class=\"p\">(</span><span class=\"n\">paginator</span><span class=\"o\">.</span><span class=\"n\">num_pages</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;reports&#39;</span><span class=\"p\">:</span> <span class=\"n\">reports</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/manage_report_metadata.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"manage_comment_metadata\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.manage_comment_metadata\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">manage_comment_metadata</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This page offers Editorial Administrators tools for managing</span>\n<span class=\"sd\">    the metadata of Comments.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">comments</span> <span class=\"o\">=</span> <span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;comments&#39;</span><span class=\"p\">:</span> <span class=\"n\">comments</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/manage_comment_metadata.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">mark_report_doi_needed</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">report_id</span><span class=\"p\">,</span> <span class=\"n\">needed</span><span class=\"p\">):</span>\n    <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">report_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">needed</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">needs_doi</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"k\">elif</span> <span class=\"n\">needed</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">needs_doi</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n    <span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_report_metadata&#39;</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">mark_comment_doi_needed</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">comment_id</span><span class=\"p\">,</span> <span class=\"n\">needed</span><span class=\"p\">):</span>\n    <span class=\"n\">comment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">comment_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">needed</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">needs_doi</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"k\">elif</span> <span class=\"n\">needed</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">needs_doi</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n    <span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_comment_metadata&#39;</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span>\n<div class=\"viewcode-block\" id=\"generic_metadata_xml_deposit\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.generic_metadata_xml_deposit\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">generic_metadata_xml_deposit</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This method creates the metadata for non-Publication objects</span>\n<span class=\"sd\">    such as Reports and Comments, and deposits the metadata to</span>\n<span class=\"sd\">    Crossref.</span>\n<span class=\"sd\">    If there exists a relation to a SciPost-published object,</span>\n<span class=\"sd\">    the deposit uses Crossref&#39;s peer review content type.</span>\n<span class=\"sd\">    Otherwise the deposit is done as a dataset.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">type_of_object</span> <span class=\"o\">=</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;type_of_object&#39;</span><span class=\"p\">]</span>\n    <span class=\"n\">object_id</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;object_id&#39;</span><span class=\"p\">])</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;comment&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">)</span>\n\n    <span class=\"n\">relation_to_published</span> <span class=\"o\">=</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">relation_to_published</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">:</span>\n        <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">create_doi_label</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># create a doi_batch_id</span>\n    <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n    <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">):</span>\n        <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"n\">salt</span> <span class=\"o\">+</span> <span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">choice</span><span class=\"p\">(</span><span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">ascii_letters</span><span class=\"p\">)</span>\n    <span class=\"n\">salt</span> <span class=\"o\">=</span> <span class=\"n\">salt</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf8&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">idsalt</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">_object</span><span class=\"p\">)[:</span><span class=\"mi\">10</span><span class=\"p\">]</span>\n    <span class=\"n\">idsalt</span> <span class=\"o\">=</span> <span class=\"n\">idsalt</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf8&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">timestamp</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%Y%m</span><span class=\"si\">%d</span><span class=\"s1\">%H%M%S&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">doi_batch_id</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span><span class=\"p\">(</span><span class=\"n\">salt</span><span class=\"o\">+</span><span class=\"n\">idsalt</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span><span class=\"p\">()</span>\n    <span class=\"n\">metadata_xml</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s1\">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi_batch version=&quot;4.4.1&quot; xmlns=&quot;http://www.crossref.org/schema/4.4.1&quot; &#39;</span>\n        <span class=\"s1\">&#39;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &#39;</span>\n        <span class=\"s1\">&#39;xsi:schemaLocation=&quot;http://www.crossref.org/schema/4.4.1 &#39;</span>\n        <span class=\"s1\">&#39;http://www.crossref.org/shema/deposit/crossref4.4.1.xsd&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;head&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;doi_batch_id&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">doi_batch_id</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi_batch_id&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;timestamp&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">timestamp</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/timestamp&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;depositor&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;depositor_name&gt;scipost&lt;/depositor_name&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;email_address&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_DEPOSIT_EMAIL</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/email_address&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/depositor&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;registrant&gt;scipost&lt;/registrant&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"s1\">&#39;&lt;/head&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">relation_to_published</span><span class=\"p\">:</span>\n        <span class=\"n\">metadata_xml</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n            <span class=\"s1\">&#39;&lt;body&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;peer_review stage=&quot;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">relation_to_published</span><span class=\"p\">[</span><span class=\"s1\">&#39;stage&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;contributors&gt;&#39;</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">anonymous</span><span class=\"p\">:</span>\n            <span class=\"n\">metadata_xml</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;&lt;anonymous sequence=&quot;first&quot; contributor_role=&quot;&#39;</span>\n                <span class=\"o\">+</span> <span class=\"n\">relation_to_published</span><span class=\"p\">[</span><span class=\"s1\">&#39;contributor_role&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&quot;/&gt;&#39;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">metadata_xml</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;&lt;person_name sequence=&quot;first&quot; contributor_role=&quot;&#39;</span>\n                <span class=\"o\">+</span> <span class=\"n\">relation_to_published</span><span class=\"p\">[</span><span class=\"s1\">&#39;contributor_role&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&quot;&gt;&#39;</span>\n                <span class=\"s1\">&#39;&lt;given_name&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/given_name&gt;&#39;</span>\n                <span class=\"s1\">&#39;&lt;surname&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">author</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/surname&gt;&#39;</span>\n                <span class=\"s1\">&#39;&lt;/person_name&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">_object</span><span class=\"p\">,</span> <span class=\"n\">Publication</span><span class=\"p\">):</span>\n            <span class=\"n\">url_to_declare</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;https://scipost.org</span><span class=\"si\">{}</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">url_to_declare</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;https://scipost.org/</span><span class=\"si\">{}</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n\n        <span class=\"n\">metadata_xml</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n            <span class=\"s1\">&#39;&lt;/contributors&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;titles&gt;&lt;title&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">relation_to_published</span><span class=\"p\">[</span><span class=\"s1\">&#39;title&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/title&gt;&lt;/titles&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;review_date&gt;&#39;</span>\n            <span class=\"s1\">&#39;&lt;month&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">date_submitted</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%m&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/month&gt;&#39;</span>\n            <span class=\"s1\">&#39;&lt;day&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">date_submitted</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"si\">%d</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/day&gt;&#39;</span>\n            <span class=\"s1\">&#39;&lt;year&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">date_submitted</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%Y&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/year&gt;&#39;</span>\n            <span class=\"s1\">&#39;&lt;/review_date&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;program xmlns=&quot;http://www.crossref.org/relations.xsd&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;related_item&gt;&#39;</span>\n            <span class=\"s1\">&#39;&lt;description&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">relation_to_published</span><span class=\"p\">[</span><span class=\"s1\">&#39;title&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/description&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;inter_work_relation relationship-type=&quot;isReviewOf&quot; identifier-type=&quot;doi&quot;&gt;&#39;</span>\n            <span class=\"o\">+</span> <span class=\"n\">relation_to_published</span><span class=\"p\">[</span><span class=\"s1\">&#39;isReviewOfDOI&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/inter_work_relation&gt;&lt;/related_item&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;/program&gt;&#39;</span>\n            <span class=\"s1\">&#39;&lt;doi_data&gt;&lt;doi&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;resource&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">url_to_declare</span> <span class=\"o\">+</span>\n            <span class=\"s1\">&#39;&lt;/resource&gt;&lt;/doi_data&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;/peer_review&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;/body&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;/doi_batch&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n        <span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">metadata_xml</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n            <span class=\"s1\">&#39;&lt;body&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;database&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;database_metadata language=&quot;en&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;titles&gt;&lt;title&gt;SciPost Reports and Comments&lt;/title&gt;&lt;/titles&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;/database_metadata&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;dataset dataset_type=&quot;collection&quot;&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;doi_data&gt;&lt;doi&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">doi_string</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/doi&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;resource&gt;https://scipost.org&#39;</span> <span class=\"o\">+</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">()</span> <span class=\"o\">+</span>\n            <span class=\"s1\">&#39;&lt;/resource&gt;&lt;/doi_data&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;/dataset&gt;&lt;/database&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n            <span class=\"s1\">&#39;&lt;/body&gt;&lt;/doi_batch&gt;&#39;</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_DEBUG</span><span class=\"p\">:</span>\n        <span class=\"c1\"># CAUTION: Debug is False, production goes for real deposit!!!</span>\n        <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;http://doi.crossref.org/servlet/deposit&#39;</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;http://test.crossref.org/servlet/deposit&#39;</span>\n    <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;operation&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;doMDUpload&#39;</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;login_id&#39;</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_LOGIN_ID</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;login_passwd&#39;</span><span class=\"p\">:</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">CROSSREF_LOGIN_PASSWORD</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n    <span class=\"n\">files</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;fname&#39;</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"s1\">&#39;metadata.xml&#39;</span><span class=\"p\">,</span> <span class=\"n\">metadata_xml</span><span class=\"p\">,</span> <span class=\"s1\">&#39;multipart/form-data&#39;</span><span class=\"p\">)}</span>\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">files</span><span class=\"o\">=</span><span class=\"n\">files</span><span class=\"p\">)</span>\n    <span class=\"n\">deposit</span> <span class=\"o\">=</span> <span class=\"n\">GenericDOIDeposit</span><span class=\"p\">(</span><span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"n\">ContentType</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get_for_model</span><span class=\"p\">(</span><span class=\"n\">_object</span><span class=\"p\">),</span>\n                                <span class=\"n\">object_id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">,</span>\n                                <span class=\"n\">content_object</span><span class=\"o\">=</span><span class=\"n\">_object</span><span class=\"p\">,</span>\n                                <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">timestamp</span><span class=\"p\">,</span>\n                                <span class=\"n\">doi_batch_id</span><span class=\"o\">=</span><span class=\"n\">doi_batch_id</span><span class=\"p\">,</span>\n                                <span class=\"n\">metadata_xml</span><span class=\"o\">=</span><span class=\"n\">metadata_xml</span><span class=\"p\">,</span>\n                                <span class=\"n\">deposition_date</span><span class=\"o\">=</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n                                <span class=\"n\">response</span><span class=\"o\">=</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">)</span>\n    <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;response_headers&#39;</span><span class=\"p\">:</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">headers</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;response_text&#39;</span><span class=\"p\">:</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/generic_metadata_xml_deposit.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">mark_generic_deposit_success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">deposit_id</span><span class=\"p\">,</span> <span class=\"n\">success</span><span class=\"p\">):</span>\n    <span class=\"n\">deposit</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">GenericDOIDeposit</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">deposit_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">success</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">deposit_successful</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">doideposit_needs_updating</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">content_object</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">elif</span> <span class=\"n\">success</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">deposit_successful</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n    <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"n\">deposit</span><span class=\"o\">.</span><span class=\"n\">content_type</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_report_metadata&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_comment_metadata&#39;</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_publish_accepted_submission&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"email_object_made_citable\"><a class=\"viewcode-back\" href=\"../../../apps/journals/#journals.views.email_object_made_citable\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">email_object_made_citable</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This method sends an email to the author of a Report or a Comment,</span>\n<span class=\"sd\">    to notify that the object has been made citable (doi registered).</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">type_of_object</span> <span class=\"o\">=</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;type_of_object&#39;</span><span class=\"p\">]</span>\n    <span class=\"n\">object_id</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;object_id&#39;</span><span class=\"p\">])</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">)</span>\n        <span class=\"n\">redirect_to</span> <span class=\"o\">=</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_report_metadata&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">publication_citation</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"n\">publication_doi</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n                <span class=\"n\">accepted_submission__arxiv_identifier_wo_vn_nr</span><span class=\"o\">=</span><span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_wo_vn_nr</span><span class=\"p\">)</span>\n            <span class=\"n\">publication_citation</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">citation</span><span class=\"p\">()</span>\n            <span class=\"n\">publication_doi</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span>\n        <span class=\"k\">except</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"k\">pass</span>\n    <span class=\"k\">elif</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;comment&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">_object</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">object_id</span><span class=\"p\">)</span>\n        <span class=\"n\">redirect_to</span> <span class=\"o\">=</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;journals:manage_comment_metadata&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">_object</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"p\">:</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;This object does not have a DOI yet.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">redirect_to</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">type_of_object</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">JournalUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;report&#39;</span><span class=\"p\">:</span> <span class=\"n\">_object</span><span class=\"p\">,</span>\n                           <span class=\"s1\">&#39;publication_citation&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication_citation</span><span class=\"p\">,</span>\n                           <span class=\"s1\">&#39;publication_doi&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication_doi</span><span class=\"p\">})</span>\n        <span class=\"n\">JournalUtils</span><span class=\"o\">.</span><span class=\"n\">email_report_made_citable</span><span class=\"p\">()</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">JournalUtils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;comment&#39;</span><span class=\"p\">:</span> <span class=\"n\">_object</span><span class=\"p\">,</span> <span class=\"p\">})</span>\n        <span class=\"n\">JournalUtils</span><span class=\"o\">.</span><span class=\"n\">email_comment_made_citable</span><span class=\"p\">()</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Email sent&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">redirect_to</span><span class=\"p\">)</span></div>\n\n\n<span class=\"c1\">###########</span>\n<span class=\"c1\"># Viewing #</span>\n<span class=\"c1\">###########</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">report_detail</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">report</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">(),</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">report</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">comment_detail</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">comment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">vetted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">regular_comments</span><span class=\"p\">(),</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">author_reply_detail</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">comment</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">vetted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">author_replies</span><span class=\"p\">(),</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">.</span><span class=\"n\">get_absolute_url</span><span class=\"p\">())</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">publication_detail</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get_published</span><span class=\"p\">(</span><span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">in_issue</span><span class=\"o\">.</span><span class=\"n\">in_volume</span><span class=\"o\">.</span><span class=\"n\">in_journal</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;journal&#39;</span><span class=\"p\">:</span> <span class=\"n\">journal</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;journals/publication_detail.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">publication_detail_pdf</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get_published</span><span class=\"p\">(</span><span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">HttpResponse</span><span class=\"p\">(</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">pdf_file</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(),</span> <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"s1\">&#39;application/pdf&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span><span class=\"p\">[</span><span class=\"s1\">&#39;Content-Disposition&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;filename=&#39;</span>\n                                       <span class=\"o\">+</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_label</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_&#39;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;.pdf&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">response</span>\n\n\n<span class=\"c1\">######################</span>\n<span class=\"c1\"># Feed DOIs to arXiv #</span>\n<span class=\"c1\">######################</span>\n\n<span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">This method provides arXiv with the doi and journal ref of the 100 most recent</span>\n<span class=\"sd\">publications in the journal specified by doi_label.</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"k\">def</span> <span class=\"nf\">arxiv_doi_feed</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"p\">):</span>\n    <span class=\"n\">journal</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">doi_label</span><span class=\"o\">=</span><span class=\"n\">doi_label</span><span class=\"p\">)</span>\n    <span class=\"n\">feedxml</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;preprint xmlns=&quot;http://arxiv.org/doi_feed&quot; &#39;</span>\n               <span class=\"s1\">&#39;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &#39;</span>\n               <span class=\"s1\">&#39;identifier=&quot;SciPost.org &#39;</span> <span class=\"o\">+</span> <span class=\"n\">doi_label</span> <span class=\"o\">+</span> <span class=\"s1\">&#39; arXiv.org DOI feed&quot; &#39;</span>\n               <span class=\"s1\">&#39;version=&quot;DOI SnappyFeed v1.0&quot; &#39;</span>\n               <span class=\"s1\">&#39;xsi:schemaLocation=&quot;http://arxiv.org/doi_feed &#39;</span>\n               <span class=\"s1\">&#39;http://arxiv.org/schemas/doi_feed.xsd&quot;&gt;&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">now</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n    <span class=\"n\">feedxml</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;date year=&quot;</span><span class=\"si\">%s</span><span class=\"s1\">&quot; month=&quot;</span><span class=\"si\">%s</span><span class=\"s1\">&quot; day=&quot;</span><span class=\"si\">%s</span><span class=\"s1\">&quot; /&gt;&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">now</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%Y&#39;</span><span class=\"p\">),</span>\n                                                           <span class=\"n\">now</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;%m&#39;</span><span class=\"p\">),</span> <span class=\"n\">now</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"si\">%d</span><span class=\"s1\">&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">publications</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">in_issue__in_volume__in_journal</span><span class=\"o\">=</span><span class=\"n\">journal</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-publication_date&#39;</span><span class=\"p\">)[:</span><span class=\"mi\">100</span><span class=\"p\">]</span>\n    <span class=\"k\">for</span> <span class=\"n\">publication</span> <span class=\"ow\">in</span> <span class=\"n\">publications</span><span class=\"p\">:</span>\n        <span class=\"n\">feedxml</span> <span class=\"o\">+=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&lt;article preprint_id=&quot;</span><span class=\"si\">%s</span><span class=\"s1\">&quot; doi=&quot;</span><span class=\"si\">%s</span><span class=\"s1\">&quot; journal_ref=&quot;</span><span class=\"si\">%s</span><span class=\"s1\">&quot; /&gt;&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n            <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">accepted_submission</span><span class=\"o\">.</span><span class=\"n\">arxiv_identifier_wo_vn_nr</span><span class=\"p\">,</span> <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">doi_string</span><span class=\"p\">,</span>\n            <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">citation</span><span class=\"p\">()))</span>\n    <span class=\"n\">feedxml</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&lt;/preprint&gt;&#39;</span>\n    <span class=\"k\">return</span> <span class=\"n\">HttpResponse</span><span class=\"p\">(</span><span class=\"n\">feedxml</span><span class=\"p\">,</span> <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"s1\">&#39;text/xml&#39;</span><span class=\"p\">)</span>\n</pre></div>", "parents": [{"link": "../../", "title": "Module code"}], "current_page_name": "_modules/journals/views", "title": "journals.views", "alabaster_version": "0.7.10", "sidebars": null}