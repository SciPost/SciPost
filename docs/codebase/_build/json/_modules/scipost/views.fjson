{"current_page_name": "_modules/scipost/views", "customsidebar": null, "parents": [{"link": "../../", "title": "Module code"}], "alabaster_version": "0.7.10", "body": "<h1>Source code for scipost.views</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">json</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"k\">import</span> <span class=\"n\">timezone</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.shortcuts</span> <span class=\"k\">import</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">,</span> <span class=\"n\">render</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"k\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib</span> <span class=\"k\">import</span> <span class=\"n\">messages</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.auth</span> <span class=\"k\">import</span> <span class=\"n\">login</span><span class=\"p\">,</span> <span class=\"n\">logout</span><span class=\"p\">,</span> <span class=\"n\">update_session_auth_hash</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.auth.decorators</span> <span class=\"k\">import</span> <span class=\"n\">login_required</span><span class=\"p\">,</span> <span class=\"n\">user_passes_test</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.auth.models</span> <span class=\"k\">import</span> <span class=\"n\">Group</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.auth.views</span> <span class=\"k\">import</span> <span class=\"n\">password_reset</span><span class=\"p\">,</span> <span class=\"n\">password_reset_confirm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core</span> <span class=\"k\">import</span> <span class=\"n\">mail</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.exceptions</span> <span class=\"k\">import</span> <span class=\"n\">PermissionDenied</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.mail</span> <span class=\"k\">import</span> <span class=\"n\">EmailMessage</span><span class=\"p\">,</span> <span class=\"n\">EmailMultiAlternatives</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.paginator</span> <span class=\"k\">import</span> <span class=\"n\">Paginator</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.urlresolvers</span> <span class=\"k\">import</span> <span class=\"n\">reverse</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"k\">import</span> <span class=\"n\">Prefetch</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.http</span> <span class=\"k\">import</span> <span class=\"n\">Http404</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.shortcuts</span> <span class=\"k\">import</span> <span class=\"n\">redirect</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.template</span> <span class=\"k\">import</span> <span class=\"n\">Context</span><span class=\"p\">,</span> <span class=\"n\">Template</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.decorators.http</span> <span class=\"k\">import</span> <span class=\"n\">require_POST</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.generic.list</span> <span class=\"k\">import</span> <span class=\"n\">ListView</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.debug</span> <span class=\"k\">import</span> <span class=\"n\">cleanse_setting</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.static</span> <span class=\"k\">import</span> <span class=\"n\">serve</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">guardian.decorators</span> <span class=\"k\">import</span> <span class=\"n\">permission_required</span>\n<span class=\"kn\">from</span> <span class=\"nn\">haystack.generic_views</span> <span class=\"k\">import</span> <span class=\"n\">SearchView</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.constants</span> <span class=\"k\">import</span> <span class=\"n\">SCIPOST_SUBJECT_AREAS</span><span class=\"p\">,</span> <span class=\"n\">subject_areas_raw_dict</span><span class=\"p\">,</span> <span class=\"n\">SciPost_from_addresses_dict</span><span class=\"p\">,</span>\\\n                       <span class=\"n\">CONTRIBUTOR_NORMAL</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.decorators</span> <span class=\"k\">import</span> <span class=\"n\">has_contributor</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.models</span> <span class=\"k\">import</span> <span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"n\">UnavailabilityPeriod</span><span class=\"p\">,</span>\\\n                    <span class=\"n\">AuthorshipClaim</span><span class=\"p\">,</span> <span class=\"n\">EditorialCollege</span><span class=\"p\">,</span> <span class=\"n\">EditorialCollegeFellowship</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.forms</span> <span class=\"k\">import</span> <span class=\"n\">AuthenticationForm</span><span class=\"p\">,</span> <span class=\"n\">UnavailabilityPeriodForm</span><span class=\"p\">,</span>\\\n                   <span class=\"n\">RegistrationForm</span><span class=\"p\">,</span> <span class=\"n\">AuthorshipClaimForm</span><span class=\"p\">,</span>\\\n                   <span class=\"n\">SearchForm</span><span class=\"p\">,</span> <span class=\"n\">VetRegistrationForm</span><span class=\"p\">,</span> <span class=\"n\">reg_ref_dict</span><span class=\"p\">,</span>\\\n                   <span class=\"n\">UpdatePersonalDataForm</span><span class=\"p\">,</span> <span class=\"n\">UpdateUserDataForm</span><span class=\"p\">,</span> <span class=\"n\">PasswordChangeForm</span><span class=\"p\">,</span>\\\n                   <span class=\"n\">EmailGroupMembersForm</span><span class=\"p\">,</span> <span class=\"n\">EmailParticularForm</span><span class=\"p\">,</span> <span class=\"n\">SendPrecookedEmailForm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.utils</span> <span class=\"k\">import</span> <span class=\"n\">Utils</span><span class=\"p\">,</span> <span class=\"n\">EMAIL_FOOTER</span><span class=\"p\">,</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER</span><span class=\"p\">,</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER_HTML</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">affiliations.forms</span> <span class=\"k\">import</span> <span class=\"n\">AffiliationsFormset</span>\n<span class=\"kn\">from</span> <span class=\"nn\">colleges.permissions</span> <span class=\"k\">import</span> <span class=\"n\">fellowship_or_admin_required</span>\n<span class=\"kn\">from</span> <span class=\"nn\">commentaries.models</span> <span class=\"k\">import</span> <span class=\"n\">Commentary</span>\n<span class=\"kn\">from</span> <span class=\"nn\">comments.models</span> <span class=\"k\">import</span> <span class=\"n\">Comment</span>\n<span class=\"kn\">from</span> <span class=\"nn\">invitations.constants</span> <span class=\"k\">import</span> <span class=\"n\">STATUS_REGISTERED</span>\n<span class=\"kn\">from</span> <span class=\"nn\">invitations.models</span> <span class=\"k\">import</span> <span class=\"n\">RegistrationInvitation</span>\n<span class=\"kn\">from</span> <span class=\"nn\">journals.models</span> <span class=\"k\">import</span> <span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">Journal</span><span class=\"p\">,</span> <span class=\"n\">PublicationAuthorsTable</span>\n<span class=\"kn\">from</span> <span class=\"nn\">news.models</span> <span class=\"k\">import</span> <span class=\"n\">NewsItem</span>\n<span class=\"kn\">from</span> <span class=\"nn\">submissions.models</span> <span class=\"k\">import</span> <span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">RefereeInvitation</span><span class=\"p\">,</span>\\\n                               <span class=\"n\">Report</span><span class=\"p\">,</span> <span class=\"n\">EICRecommendation</span>\n<span class=\"kn\">from</span> <span class=\"nn\">partners.models</span> <span class=\"k\">import</span> <span class=\"n\">MembershipAgreement</span>\n<span class=\"kn\">from</span> <span class=\"nn\">theses.models</span> <span class=\"k\">import</span> <span class=\"n\">ThesisLink</span>\n\n\n<span class=\"c1\">##############</span>\n<span class=\"c1\"># Utilitites #</span>\n<span class=\"c1\">##############</span>\n\n<div class=\"viewcode-block\" id=\"is_registered\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.is_registered\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">is_registered</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This method checks if user is activated assuming an validated user</span>\n<span class=\"sd\">    has at least one permission group (`Registered Contributor` or `Partner Accounts`).</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">groups</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">SearchView</span><span class=\"p\">(</span><span class=\"n\">SearchView</span><span class=\"p\">):</span>\n    <span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;search/search.html&#39;</span>\n    <span class=\"n\">form_class</span> <span class=\"o\">=</span> <span class=\"n\">SearchForm</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_context_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"n\">ctx</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_context_data</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"n\">ctx</span><span class=\"p\">[</span><span class=\"s1\">&#39;search_query&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;q&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">ctx</span><span class=\"p\">[</span><span class=\"s1\">&#39;results_count&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;object_list&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Methods not supported by Whoosh engine</span>\n        <span class=\"c1\"># ctx[&#39;stats_results&#39;] = kwargs[&#39;object_list&#39;].stats_results()</span>\n        <span class=\"c1\"># ctx[&#39;facet_counts&#39;] = kwargs[&#39;object_list&#39;].facet(&#39;text&#39;).facet_counts()</span>\n        <span class=\"k\">return</span> <span class=\"n\">ctx</span>\n\n\n<span class=\"c1\">#############</span>\n<span class=\"c1\"># Main view</span>\n<span class=\"c1\">#############</span>\n\n<div class=\"viewcode-block\" id=\"index\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.index\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">index</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&#39;&#39;&#39;Main page.&#39;&#39;&#39;</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;latest_newsitem&#39;</span><span class=\"p\">:</span> <span class=\"n\">NewsItem</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">on_homepage</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">(),</span>\n        <span class=\"s1\">&#39;submissions&#39;</span><span class=\"p\">:</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">public</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-submission_date&#39;</span><span class=\"p\">)[:</span><span class=\"mi\">3</span><span class=\"p\">],</span>\n        <span class=\"s1\">&#39;journals&#39;</span><span class=\"p\">:</span> <span class=\"n\">Journal</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">),</span>\n        <span class=\"s1\">&#39;publications&#39;</span><span class=\"p\">:</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-publication_date&#39;</span><span class=\"p\">,</span>\n                                                                 <span class=\"s1\">&#39;-paper_nr&#39;</span><span class=\"p\">)[:</span><span class=\"mi\">3</span><span class=\"p\">],</span>\n        <span class=\"s1\">&#39;current_agreements&#39;</span><span class=\"p\">:</span> <span class=\"n\">MembershipAgreement</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">now_active</span><span class=\"p\">(),</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/index.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"protected_serve\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.protected_serve\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">protected_serve</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">show_indexes</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Serve files that are saved outside the default MEDIA_ROOT folder for superusers only!</span>\n<span class=\"sd\">    This will be usefull eg. in the admin pages.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_authenticated</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_superuser</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Only superusers may get to see secure files without an explicit serve method!</span>\n        <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n    <span class=\"n\">document_root</span> <span class=\"o\">=</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT_SECURE</span>\n    <span class=\"k\">return</span> <span class=\"n\">serve</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">document_root</span><span class=\"p\">,</span> <span class=\"n\">show_indexes</span><span class=\"p\">)</span></div>\n\n\n<span class=\"c1\">###############</span>\n<span class=\"c1\"># Information</span>\n<span class=\"c1\">###############</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">feeds</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;subject_areas_physics&#39;</span><span class=\"p\">:</span> <span class=\"n\">SCIPOST_SUBJECT_AREAS</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">1</span><span class=\"p\">]}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/feeds.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"c1\">################</span>\n<span class=\"c1\"># Contributors:</span>\n<span class=\"c1\">################</span>\n\n<div class=\"viewcode-block\" id=\"register\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.register\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">register</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This public registration view shows and processes the form</span>\n<span class=\"sd\">    that will create new user account requests. After registration</span>\n<span class=\"sd\">    the Contributor will need to activate its account via the mail</span>\n<span class=\"sd\">    sent. After activation the user needs to be vetted by the SciPost</span>\n<span class=\"sd\">    admin.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_authenticated</span><span class=\"p\">():</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">))</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">RegistrationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">create_and_save_contributor</span><span class=\"p\">()</span>\n        <span class=\"n\">Utils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">},</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"n\">Utils</span><span class=\"o\">.</span><span class=\"n\">send_registration_email</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Disable invitations related to the new Contributor</span>\n        <span class=\"n\">RegistrationInvitation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">declined_or_without_response</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">email</span><span class=\"o\">=</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email&#39;</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">STATUS_REGISTERED</span><span class=\"p\">)</span>\n\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s1\">&#39;ack_header&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;Thanks for registering to SciPost.&#39;</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;ack_message&#39;</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"s1\">&#39;You will receive an email with a link to verify &#39;</span>\n                            <span class=\"s1\">&#39;your email address. &#39;</span>\n                            <span class=\"s1\">&#39;Please visit this link within 48 hours. &#39;</span>\n                            <span class=\"s1\">&#39;Your credentials will thereafter be verified. &#39;</span>\n                            <span class=\"s1\">&#39;If your registration is vetted through by the &#39;</span>\n                            <span class=\"s1\">&#39;administrators, you will be enabled to contribute.&#39;</span><span class=\"p\">),</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/acknowledgement.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/register.html&#39;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"s1\">&#39;invited&#39;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">})</span></div>\n\n\n<div class=\"viewcode-block\" id=\"invitation\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.invitation\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">invitation</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    If a scientist has recieved an invitation (RegistrationInvitation)</span>\n<span class=\"sd\">    he/she will finish it&#39;s invitation via still view which will prefill</span>\n<span class=\"sd\">    the default registration form.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">invitation</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">RegistrationInvitation</span><span class=\"p\">,</span> <span class=\"n\">invitation_key</span><span class=\"o\">=</span><span class=\"n\">key</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">has_responded</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;This invitation token has already been used, &#39;</span>\n                        <span class=\"s1\">&#39;or this email address is already associated to a registration.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span> <span class=\"o\">&gt;</span> <span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"n\">key_expires</span><span class=\"p\">:</span>\n        <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;The invitation key has expired.&#39;</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s1\">&#39;invitation&#39;</span><span class=\"p\">:</span> <span class=\"n\">invitation</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">RegistrationForm</span><span class=\"p\">(</span><span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">invitation</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"p\">)</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/register.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/accept_invitation_error.html&#39;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"s1\">&#39;errormessage&#39;</span><span class=\"p\">:</span> <span class=\"n\">errormessage</span><span class=\"p\">})</span></div>\n\n\n<div class=\"viewcode-block\" id=\"activation\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.activation\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">activation</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    After registration, an email verification link is sent.</span>\n<span class=\"sd\">    Once clicked, the account is activated.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">,</span> <span class=\"n\">activation_key</span><span class=\"o\">=</span><span class=\"n\">key</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_active</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span> <span class=\"o\">&gt;</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">key_expires</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:request_new_activation_link&#39;</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"p\">{</span>\n                <span class=\"s1\">&#39;contributor_id&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor_id</span><span class=\"p\">,</span>\n                <span class=\"s1\">&#39;key&#39;</span><span class=\"p\">:</span> <span class=\"n\">key</span>\n            <span class=\"p\">}))</span>\n        <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_active</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;ack_header&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;Many thanks for confirming your email address.&#39;</span><span class=\"p\">,</span>\n                   <span class=\"s1\">&#39;ack_message&#39;</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Your SciPost account will soon be vetted by &#39;</span>\n                                   <span class=\"s1\">&#39;an administrator, after which you will be able to log in. &#39;</span>\n                                   <span class=\"s1\">&#39;You will soon receive an email confirmation from us!&#39;</span><span class=\"p\">),</span>\n                   <span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/acknowledgement.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;Your email has already been confirmed.&lt;/h3&gt;&#39;</span>\n                               <span class=\"s1\">&#39;Please wait for vetting of your registration.&#39;</span>\n                               <span class=\"s1\">&#39; We shall strive to send you an update by email within 24 hours.&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:index&#39;</span><span class=\"p\">))</span></div>\n\n\n<div class=\"viewcode-block\" id=\"request_new_activation_link\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.request_new_activation_link\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">request_new_activation_link</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Once a user tries to activate its account using the email verification link sent</span>\n<span class=\"sd\">    and the key has expired, the user redirected to possibly request a new token.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">,</span> <span class=\"n\">activation_key</span><span class=\"o\">=</span><span class=\"n\">key</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;confirm&#39;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Generate a new email activation key and link</span>\n        <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">generate_key</span><span class=\"p\">()</span>\n        <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">Utils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">},</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"n\">Utils</span><span class=\"o\">.</span><span class=\"n\">send_new_activation_link_email</span><span class=\"p\">()</span>\n\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s1\">&#39;ack_header&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;We have emailed you a new activation link.&#39;</span><span class=\"p\">,</span>\n            <span class=\"s1\">&#39;ack_message&#39;</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Please acknowledge it within its 48 hours validity &#39;</span>\n                            <span class=\"s1\">&#39;window if you want us to proceed with vetting your registration.&#39;</span><span class=\"p\">),</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/acknowledgement.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/request_new_activation_link.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"unsubscribe\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.unsubscribe\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">unsubscribe</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The link to this method is included in all email communications</span>\n<span class=\"sd\">    with a Contributor. The key used is the original activation key.</span>\n<span class=\"sd\">    At this link, the Contributor can confirm that he/she does not</span>\n<span class=\"sd\">    want to receive any non-essential email notifications from SciPost.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">,</span> <span class=\"n\">activation_key</span><span class=\"o\">=</span><span class=\"n\">key</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;confirm&#39;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">accepts_SciPost_emails</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">text</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;We have recorded your preference&lt;/h3&gt;&#39;</span>\n                <span class=\"s1\">&#39;You will no longer receive non-essential email from SciPost.&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:index&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/unsubscribe.html&#39;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">})</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_vet_registration_requests&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">vet_registration_requests</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">contributors_to_vet</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span>\n                           <span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span>\n                           <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;key_expires&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">VetRegistrationForm</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;contributors_to_vet&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributors_to_vet</span><span class=\"p\">,</span> <span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/vet_registration_requests.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_vet_registration_requests&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">vet_registration_request_ack</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"p\">):</span>\n    <span class=\"c1\"># process the form</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">VetRegistrationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">promote_to_registered_contributor</span><span class=\"p\">():</span>\n            <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n            <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">vetted_by</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n            <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"n\">group</span> <span class=\"o\">=</span> <span class=\"n\">Group</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s1\">&#39;Registered Contributors&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">groups</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">group</span><span class=\"p\">)</span>\n            <span class=\"c1\"># Verify if there is a pending refereeing invitation</span>\n            <span class=\"n\">pending_ref_inv_exists</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">pending_ref_inv</span> <span class=\"o\">=</span> <span class=\"n\">RefereeInvitation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n                    <span class=\"n\">invitation_key</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">invitation_key</span><span class=\"p\">,</span> <span class=\"n\">cancelled</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n                <span class=\"n\">pending_ref_inv</span><span class=\"o\">.</span><span class=\"n\">referee</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span>\n                <span class=\"n\">pending_ref_inv</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"k\">except</span> <span class=\"n\">RefereeInvitation</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n                <span class=\"n\">pending_ref_inv_exists</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n            <span class=\"n\">email_text</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Dear &#39;</span> <span class=\"o\">+</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">get_title_display</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"s1\">&#39; &#39;</span>\n                          <span class=\"o\">+</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span> <span class=\"o\">+</span>\n                          <span class=\"s1\">&#39;, </span><span class=\"se\">\\n\\n</span><span class=\"s1\">Your registration to the SciPost publication portal &#39;</span>\n                          <span class=\"s1\">&#39;has been accepted. &#39;</span>\n                          <span class=\"s1\">&#39;You can now login at https://scipost.org and contribute. </span><span class=\"se\">\\n\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">pending_ref_inv_exists</span><span class=\"p\">:</span>\n                <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                    <span class=\"s1\">&#39;Note that you have pending refereeing invitations; please navigate to &#39;</span>\n                    <span class=\"s1\">&#39;https://scipost.org/submissions/accept_or_decline_ref_invitations &#39;</span>\n                    <span class=\"s1\">&#39;(login required) to accept or decline them.</span><span class=\"se\">\\n\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;Thank you very much in advance, </span><span class=\"se\">\\n</span><span class=\"s1\">The SciPost Team.&#39;</span>\n            <span class=\"n\">emailmessage</span> <span class=\"o\">=</span> <span class=\"n\">EmailMessage</span><span class=\"p\">(</span><span class=\"s1\">&#39;SciPost registration accepted&#39;</span><span class=\"p\">,</span> <span class=\"n\">email_text</span><span class=\"p\">,</span>\n                                        <span class=\"s1\">&#39;SciPost registration &lt;registration@scipost.org&gt;&#39;</span><span class=\"p\">,</span>\n                                        <span class=\"p\">[</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">email</span><span class=\"p\">],</span>\n                                        <span class=\"n\">bcc</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;registration@scipost.org&#39;</span><span class=\"p\">],</span>\n                                        <span class=\"n\">reply_to</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;registration@scipost.org&#39;</span><span class=\"p\">])</span>\n            <span class=\"n\">emailmessage</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">fail_silently</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">ref_reason</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;refusal_reason&#39;</span><span class=\"p\">])</span>\n            <span class=\"n\">email_text</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Dear &#39;</span> <span class=\"o\">+</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">get_title_display</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"s1\">&#39; &#39;</span>\n                          <span class=\"o\">+</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span> <span class=\"o\">+</span>\n                          <span class=\"s1\">&#39;, </span><span class=\"se\">\\n\\n</span><span class=\"s1\">Your registration to the SciPost publication portal &#39;</span>\n                          <span class=\"s1\">&#39;has been turned down, the reason being: &#39;</span>\n                          <span class=\"o\">+</span> <span class=\"n\">reg_ref_dict</span><span class=\"p\">[</span><span class=\"n\">ref_reason</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;. You can however still view &#39;</span>\n                          <span class=\"s1\">&#39;all SciPost contents, just not submit papers, &#39;</span>\n                          <span class=\"s1\">&#39;comments or votes. We nonetheless thank you for your interest.&#39;</span>\n                          <span class=\"s1\">&#39;</span><span class=\"se\">\\n\\n</span><span class=\"s1\">The SciPost Team.&#39;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_response_field&#39;</span><span class=\"p\">]:</span>\n                <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n\\n</span><span class=\"s1\">Further explanations: &#39;</span>\n                               <span class=\"o\">+</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_response_field&#39;</span><span class=\"p\">])</span>\n            <span class=\"n\">emailmessage</span> <span class=\"o\">=</span> <span class=\"n\">EmailMessage</span><span class=\"p\">(</span><span class=\"s1\">&#39;SciPost registration: unsuccessful&#39;</span><span class=\"p\">,</span>\n                                        <span class=\"n\">email_text</span><span class=\"p\">,</span>\n                                        <span class=\"s1\">&#39;SciPost registration &lt;registration@scipost.org&gt;&#39;</span><span class=\"p\">,</span>\n                                        <span class=\"p\">[</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">email</span><span class=\"p\">],</span>\n                                        <span class=\"n\">bcc</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;registration@scipost.org&#39;</span><span class=\"p\">],</span>\n                                        <span class=\"n\">reply_to</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;registration@scipost.org&#39;</span><span class=\"p\">])</span>\n            <span class=\"n\">emailmessage</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">fail_silently</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n            <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;refusal_reason&#39;</span><span class=\"p\">]</span>\n            <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;SciPost Registration request vetted.&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:vet_registration_requests&#39;</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_resend_registration_requests&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"registration_requests\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.registration_requests\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">registration_requests</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&#39;&#39;&#39;</span>\n<span class=\"sd\">    List all inactive users. These are users that have filled the registration form,</span>\n<span class=\"sd\">    but did not yet activate their account using the validation email.</span>\n<span class=\"sd\">    &#39;&#39;&#39;</span>\n    <span class=\"n\">inactive_contributors</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_validation</span><span class=\"p\">()</span>\n                             <span class=\"o\">.</span><span class=\"n\">prefetch_related</span><span class=\"p\">(</span><span class=\"s1\">&#39;user&#39;</span><span class=\"p\">)</span>\n                             <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-key_expires&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;inactive_contributors&#39;</span><span class=\"p\">:</span> <span class=\"n\">inactive_contributors</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;now&#39;</span><span class=\"p\">:</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/registration_requests.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@require_POST</span>\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_resend_registration_requests&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"registration_requests_reset\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.registration_requests_reset\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">registration_requests_reset</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&#39;&#39;&#39;</span>\n<span class=\"sd\">    Reset specific activation_key for Contributor and resend activation mail.</span>\n<span class=\"sd\">    &#39;&#39;&#39;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_validation</span><span class=\"p\">(),</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">generate_key</span><span class=\"p\">()</span>\n    <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"n\">Utils</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">({</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">},</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"n\">Utils</span><span class=\"o\">.</span><span class=\"n\">send_new_activation_link_email</span><span class=\"p\">()</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;New key successfully generated and sent to &lt;i&gt;</span><span class=\"si\">%s</span><span class=\"s1\">&lt;/i&gt;&#39;</span>\n                               <span class=\"o\">%</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">email</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:registration_requests&#39;</span><span class=\"p\">))</span></div>\n\n\n<div class=\"viewcode-block\" id=\"login_view\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.login_view\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">login_view</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This view shows and processes a user&#39;s login session.</span>\n\n<span class=\"sd\">    The function based method login() is deprecated from</span>\n<span class=\"sd\">    Django 1.11 and replaced by Class Based Views.</span>\n\n<span class=\"sd\">    See:</span>\n<span class=\"sd\">    https://docs.djangoproject.com/en/1.11/releases/1.11/#django-contrib-auth</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">AuthenticationForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">user</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">authenticate</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">user</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">is_registered</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">):</span>\n                <span class=\"n\">login</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"p\">)</span>\n                <span class=\"n\">redirect_to</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">get_redirect_url</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n                <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">redirect_to</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">add_error</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Your account has not yet been vetted. &#39;</span>\n                                      <span class=\"s1\">&#39;(our admins will verify your credentials very soon)&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">elif</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">user_is_inactive</span><span class=\"p\">():</span>\n            <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">add_error</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Your account is not yet activated. &#39;</span>\n                                  <span class=\"s1\">&#39;Please first activate your account.&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">add_error</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Invalid username/password.&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/login.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"logout_view\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.logout_view\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">logout_view</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The function based method logout() is deprecated from</span>\n<span class=\"sd\">    Django 1.11 and replaced by Class Based Views.</span>\n\n<span class=\"sd\">    See:</span>\n<span class=\"sd\">    https://docs.djangoproject.com/en/1.11/releases/1.11/#django-contrib-auth</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">logout</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&lt;h3&gt;Keep contributing!&lt;/h3&gt;&#39;</span>\n                               <span class=\"s1\">&#39;You are now logged out of SciPost.&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:index&#39;</span><span class=\"p\">))</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"mark_unavailable_period\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.mark_unavailable_period\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">mark_unavailable_period</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&#39;&#39;&#39;</span>\n<span class=\"sd\">    Mark period unavailable for Contributor using this view.</span>\n<span class=\"sd\">    &#39;&#39;&#39;</span>\n    <span class=\"n\">unav_form</span> <span class=\"o\">=</span> <span class=\"n\">UnavailabilityPeriodForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">unav_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">unav</span> <span class=\"o\">=</span> <span class=\"n\">unav_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">unav</span><span class=\"o\">.</span><span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n        <span class=\"n\">unav</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Unavailability period registered&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Template acts as a backup in case the form is invalid.</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">unav_form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/unavailability_period_form.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@require_POST</span>\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"delete_unavailable_period\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.delete_unavailable_period\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">delete_unavailable_period</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">period_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&#39;&#39;&#39;</span>\n<span class=\"sd\">    Delete period unavailable registered.</span>\n<span class=\"sd\">    &#39;&#39;&#39;</span>\n    <span class=\"n\">unav</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">UnavailabilityPeriod</span><span class=\"p\">,</span>\n                             <span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">period_id</span><span class=\"p\">))</span>\n    <span class=\"n\">unav</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span>\n    <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Unavailability period deleted&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_editorial_account</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Account</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;unavailability_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">UnavailabilityPeriodForm</span><span class=\"p\">(),</span>\n        <span class=\"s1\">&#39;unavailabilities&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">unavailability_periods</span><span class=\"o\">.</span><span class=\"n\">future</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;start&#39;</span><span class=\"p\">)</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/account.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_editorial_actions</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Editorial Actions</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">permission</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">groups</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">name__in</span><span class=\"o\">=</span><span class=\"p\">[</span>\n        <span class=\"s1\">&#39;Ambassadors&#39;</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;Advisory Board&#39;</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;Editorial Administrators&#39;</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;Editorial College&#39;</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;Vetting Editors&#39;</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;Junior Ambassadors&#39;</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span> <span class=\"ow\">or</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">is_superuser</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">permission</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">PermissionDenied</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">is_SP_Admin</span><span class=\"p\">():</span>\n        <span class=\"c1\"># count the number of pending registration requests</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_reg_to_vet&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_reg_awaiting_validation&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_validation</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_submissions_to_assign&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">prescreening</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_recommendations_to_prepare_for_voting&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">EICRecommendation</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">submission__status</span><span class=\"o\">=</span><span class=\"s1\">&#39;voting_in_preparation&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">is_VE</span><span class=\"p\">():</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_commentary_page_requests_to_vet&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Commentary</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span>\n                                                         <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">requested_by</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">())</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_comments_to_vet&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_thesislink_requests_to_vet&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">ThesisLink</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_authorship_claims_to_vet&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaim</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">is_MEC</span><span class=\"p\">():</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_assignments_to_consider&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">editorial_assignments</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;active_assignments&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">editorial_assignments</span><span class=\"o\">.</span><span class=\"n\">ongoing</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_reports_to_vet&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">awaiting_vetting</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">submission__editor_in_charge</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">is_EdCol_Admin</span><span class=\"p\">():</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_reports_without_pdf&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Report</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">accepted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pdf_report</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_treated_submissions_without_pdf&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">treated</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n            <span class=\"n\">pdf_refereeing_pack</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/editorial_actions.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_referee&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_refereeing</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Refereeing</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/refereeing.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_publications</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Publications</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;own_publications&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">publications</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-publication_date&#39;</span><span class=\"p\">)</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_publication_authorships_to_claim&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">author_list__contains</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors_registered</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/publications.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_submissions</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Submissions</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">}</span>\n\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_submission_authorships_to_claim&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">author_list__contains</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;own_submissions&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">submissions</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">is_current</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-submission_date&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/submissions.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_commentaries</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Commentaries</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">}</span>\n\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_commentary_authorships_to_claim&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">Commentary</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">author_list__contains</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">authors_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;own_submissions&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">commentaries</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-latest_activity&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/commentaries.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_theses</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Theses</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">}</span>\n\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;nr_thesis_authorships_to_claim&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">ThesisLink</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n        <span class=\"n\">author__contains</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">author_as_cont</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">author_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span>\n        <span class=\"n\">author_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;own_thesislinks&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">theses</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/theses.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_comments</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Comments</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;own_comments&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">comments</span><span class=\"o\">.</span><span class=\"n\">regular_comments</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date_submitted&#39;</span><span class=\"p\">)</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/comments.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">_personal_page_author_replies</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page tab: Author Replies</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;own_authorreplies&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">comments</span><span class=\"o\">.</span><span class=\"n\">author_replies</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date_submitted&#39;</span><span class=\"p\">),</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;partials/scipost/personal_page/author_replies.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<div class=\"viewcode-block\" id=\"personal_page\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.personal_page\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">personal_page</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">tab</span><span class=\"o\">=</span><span class=\"s1\">&#39;account&#39;</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The Personal Page is the main view for accessing user functions.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">is_ajax</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;account&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_editorial_account</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;editorial_actions&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_editorial_actions</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;refereeing&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_refereeing</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;publications&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_publications</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;submissions&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_submissions</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;commentaries&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_commentaries</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;theses&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_theses</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;comments&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_comments</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">tab</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;author_replies&#39;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">_personal_page_author_replies</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">raise</span> <span class=\"n\">Http404</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;appellation&#39;</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n        <span class=\"s1\">&#39;needs_validation&#39;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;tab&#39;</span><span class=\"p\">:</span> <span class=\"n\">tab</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">select_related</span><span class=\"p\">(</span><span class=\"s1\">&#39;user&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;needs_validation&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">!=</span> <span class=\"n\">CONTRIBUTOR_NORMAL</span>\n    <span class=\"k\">except</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">contributor</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Refereeing</span>\n        <span class=\"n\">refereeing_tab_total_count</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">referee_invitations</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">refereeing_tab_total_count</span> <span class=\"o\">+=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">referee_invitations</span><span class=\"o\">.</span><span class=\"n\">in_process</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n        <span class=\"n\">refereeing_tab_total_count</span> <span class=\"o\">+=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">reports</span><span class=\"o\">.</span><span class=\"n\">in_draft</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;refereeing_tab_total_count&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">refereeing_tab_total_count</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;appellation&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">get_title_display</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"s1\">&#39; &#39;</span> <span class=\"o\">+</span> <span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">contributor</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/personal_page.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"k\">def</span> <span class=\"nf\">change_password</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">PasswordChangeForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">current_user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save_new_password</span><span class=\"p\">()</span>\n        <span class=\"c1\"># Update user&#39;s session hash to stay logged in.</span>\n        <span class=\"n\">update_session_auth_hash</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Your SciPost password has been successfully changed&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">contributor</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">))</span>\n        <span class=\"k\">except</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;partners:dashboard&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/change_password.html&#39;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">})</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">reset_password_confirm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">uidb64</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">password_reset_confirm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">template_name</span><span class=\"o\">=</span><span class=\"s1\">&#39;scipost/reset_password_confirm.html&#39;</span><span class=\"p\">,</span>\n                                  <span class=\"n\">uidb64</span><span class=\"o\">=</span><span class=\"n\">uidb64</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"o\">=</span><span class=\"n\">token</span><span class=\"p\">,</span>\n                                  <span class=\"n\">post_reset_redirect</span><span class=\"o\">=</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:login&#39;</span><span class=\"p\">))</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">reset_password</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">password_reset</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">template_name</span><span class=\"o\">=</span><span class=\"s1\">&#39;scipost/reset_password.html&#39;</span><span class=\"p\">,</span>\n                          <span class=\"n\">email_template_name</span><span class=\"o\">=</span><span class=\"s1\">&#39;scipost/reset_password_email.html&#39;</span><span class=\"p\">,</span>\n                          <span class=\"n\">subject_template_name</span><span class=\"o\">=</span><span class=\"s1\">&#39;scipost/reset_password_subject.txt&#39;</span><span class=\"p\">,</span>\n                          <span class=\"n\">post_reset_redirect</span><span class=\"o\">=</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:login&#39;</span><span class=\"p\">))</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_update_personal_data_user_only</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">user_form</span> <span class=\"o\">=</span> <span class=\"n\">UpdateUserDataForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">user_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">user_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Your personal data has been updated.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:update_personal_data&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;user_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">user_form</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/update_personal_data.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_update_personal_data_contributor</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">user_form</span> <span class=\"o\">=</span> <span class=\"n\">UpdateUserDataForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n    <span class=\"n\">cont_form</span> <span class=\"o\">=</span> <span class=\"n\">UpdatePersonalDataForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n    <span class=\"n\">institution_formset</span> <span class=\"o\">=</span> <span class=\"n\">AffiliationsFormset</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">user_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">()</span> <span class=\"ow\">and</span> <span class=\"n\">cont_form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">()</span> <span class=\"ow\">and</span> <span class=\"n\">institution_formset</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">user_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">cont_form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">cont_form</span><span class=\"o\">.</span><span class=\"n\">sync_lists</span><span class=\"p\">()</span>\n        <span class=\"n\">institution_formset</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"s1\">&#39;orcid_id&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">cont_form</span><span class=\"o\">.</span><span class=\"n\">changed_data</span><span class=\"p\">:</span>\n            <span class=\"n\">cont_form</span><span class=\"o\">.</span><span class=\"n\">propagate_orcid</span><span class=\"p\">()</span>\n        <span class=\"n\">messages</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Your personal data has been updated.&#39;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:update_personal_data&#39;</span><span class=\"p\">))</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">user_form</span> <span class=\"o\">=</span> <span class=\"n\">UpdateUserDataForm</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">cont_form</span> <span class=\"o\">=</span> <span class=\"n\">UpdatePersonalDataForm</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;user_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">user_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;cont_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">cont_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;institution_formset&#39;</span><span class=\"p\">:</span> <span class=\"n\">institution_formset</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/update_personal_data.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"k\">def</span> <span class=\"nf\">update_personal_data</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">has_contributor</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">_update_personal_data_contributor</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">_update_personal_data_user_only</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"claim_authorships\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.claim_authorships\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">claim_authorships</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    The system auto-detects potential authorships (of submissions,</span>\n<span class=\"sd\">    papers subject to commentaries, theses, ...).</span>\n<span class=\"sd\">    The contributor must confirm/deny authorship from the</span>\n<span class=\"sd\">    Personal Page.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n\n    <span class=\"n\">publication_authorships_to_claim</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span>\n                                        <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author_list__contains</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n                                        <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors_registered</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                        <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                        <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">))</span>\n    <span class=\"n\">pub_auth_claim_form</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaimForm</span><span class=\"p\">()</span>\n    <span class=\"n\">submission_authorships_to_claim</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span>\n                                       <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author_list__contains</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n                                       <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                       <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                       <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">))</span>\n    <span class=\"n\">sub_auth_claim_form</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaimForm</span><span class=\"p\">()</span>\n    <span class=\"n\">commentary_authorships_to_claim</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Commentary</span><span class=\"o\">.</span><span class=\"n\">objects</span>\n                                       <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author_list__contains</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n                                       <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                       <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                       <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">authors_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">))</span>\n    <span class=\"n\">com_auth_claim_form</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaimForm</span><span class=\"p\">()</span>\n    <span class=\"n\">thesis_authorships_to_claim</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">ThesisLink</span><span class=\"o\">.</span><span class=\"n\">objects</span>\n                                   <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author__contains</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">)</span>\n                                   <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">author_as_cont</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                   <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">author_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n                                   <span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">(</span><span class=\"n\">author_false_claims</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">))</span>\n    <span class=\"n\">thesis_auth_claim_form</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaimForm</span><span class=\"p\">()</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;publication_authorships_to_claim&#39;</span><span class=\"p\">:</span> <span class=\"n\">publication_authorships_to_claim</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;pub_auth_claim_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">pub_auth_claim_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;submission_authorships_to_claim&#39;</span><span class=\"p\">:</span> <span class=\"n\">submission_authorships_to_claim</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;sub_auth_claim_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">sub_auth_claim_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;commentary_authorships_to_claim&#39;</span><span class=\"p\">:</span> <span class=\"n\">commentary_authorships_to_claim</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;com_auth_claim_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">com_auth_claim_form</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;thesis_authorships_to_claim&#39;</span><span class=\"p\">:</span> <span class=\"n\">thesis_authorships_to_claim</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;thesis_auth_claim_form&#39;</span><span class=\"p\">:</span> <span class=\"n\">thesis_auth_claim_form</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/claim_authorships.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">claim_pub_authorship</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">publication_id</span><span class=\"p\">,</span> <span class=\"n\">claim</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">method</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;POST&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">publication</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Publication</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">publication_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaim</span><span class=\"p\">(</span><span class=\"n\">claimant</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">publication</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n        <span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:claim_authorships&#39;</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">claim_sub_authorship</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">submission_id</span><span class=\"p\">,</span> <span class=\"n\">claim</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">method</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;POST&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">submission</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Submission</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">submission_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaim</span><span class=\"p\">(</span><span class=\"n\">claimant</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">submission</span><span class=\"o\">=</span><span class=\"n\">submission</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n        <span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:claim_authorships&#39;</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">claim_com_authorship</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">commentary_id</span><span class=\"p\">,</span> <span class=\"n\">claim</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">method</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;POST&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">commentary</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Commentary</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">commentary_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">commentary</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaim</span><span class=\"p\">(</span><span class=\"n\">claimant</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">commentary</span><span class=\"o\">=</span><span class=\"n\">commentary</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">commentary</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n        <span class=\"n\">commentary</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:claim_authorships&#39;</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@user_passes_test</span><span class=\"p\">(</span><span class=\"n\">has_contributor</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">claim_thesis_authorship</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">thesis_id</span><span class=\"p\">,</span> <span class=\"n\">claim</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">method</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;POST&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">thesislink</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">ThesisLink</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">thesis_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">thesislink</span><span class=\"o\">.</span><span class=\"n\">author_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaim</span><span class=\"p\">(</span><span class=\"n\">claimant</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">thesislink</span><span class=\"o\">=</span><span class=\"n\">thesislink</span><span class=\"p\">)</span>\n            <span class=\"n\">newclaim</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">thesislink</span><span class=\"o\">.</span><span class=\"n\">author_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n        <span class=\"n\">thesislink</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:claim_authorships&#39;</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_vet_authorship_claims&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">vet_authorship_claims</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">claims_to_vet</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaim</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"o\">=</span><span class=\"s1\">&#39;0&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;claims_to_vet&#39;</span><span class=\"p\">:</span> <span class=\"n\">claims_to_vet</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/vet_authorship_claims.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_vet_authorship_claims&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">vet_authorship_claim</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">claim_id</span><span class=\"p\">,</span> <span class=\"n\">claim</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">method</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;POST&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">vetting_contributor</span> <span class=\"o\">=</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">)</span>\n        <span class=\"n\">claim_to_vet</span> <span class=\"o\">=</span> <span class=\"n\">AuthorshipClaim</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">claim_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">publication</span><span class=\"p\">:</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">PublicationAuthorsTable</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>\n                    <span class=\"n\">publication</span><span class=\"o\">=</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">publication</span><span class=\"p\">,</span> <span class=\"n\">contributor</span><span class=\"o\">=</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;1&#39;</span>\n            <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;-1&#39;</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">publication</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"p\">:</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;1&#39;</span>\n            <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;-1&#39;</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">submission</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">commentary</span><span class=\"p\">:</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">commentary</span><span class=\"o\">.</span><span class=\"n\">authors_claims</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">commentary</span><span class=\"o\">.</span><span class=\"n\">authors</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;1&#39;</span>\n            <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">commentary</span><span class=\"o\">.</span><span class=\"n\">authors_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;-1&#39;</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">commentary</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">thesislink</span><span class=\"p\">:</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">thesislink</span><span class=\"o\">.</span><span class=\"n\">author_claims</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;1&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">thesislink</span><span class=\"o\">.</span><span class=\"n\">author_as_cont</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;1&#39;</span>\n            <span class=\"k\">elif</span> <span class=\"n\">claim</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;0&#39;</span><span class=\"p\">:</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">thesislink</span><span class=\"o\">.</span><span class=\"n\">author_false_claims</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">claimant</span><span class=\"p\">)</span>\n                <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;-1&#39;</span>\n            <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">thesislink</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n        <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">vetted_by</span> <span class=\"o\">=</span> <span class=\"n\">vetting_contributor</span>\n        <span class=\"n\">claim_to_vet</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">redirect</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:vet_authorship_claims&#39;</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"contributor_info\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.contributor_info\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">contributor_info</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">contributor_id</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    All visitors can see a digest of a</span>\n<span class=\"sd\">    Contributor&#39;s activities/contributions by clicking</span>\n<span class=\"sd\">    on the relevant name (in listing headers of Submissions, ...).</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">contributor</span> <span class=\"o\">=</span> <span class=\"n\">get_object_or_404</span><span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">contributor_id</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor_publications</span> <span class=\"o\">=</span> <span class=\"n\">Publication</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">published</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">authors_registered</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor_submissions</span> <span class=\"o\">=</span> <span class=\"n\">Submission</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">public_unlisted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">authors</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor_commentaries</span> <span class=\"o\">=</span> <span class=\"n\">Commentary</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">authors</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor_theses</span> <span class=\"o\">=</span> <span class=\"n\">ThesisLink</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">vetted</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author_as_cont</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">)</span>\n    <span class=\"n\">contributor_comments</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">vetted</span><span class=\"p\">()</span>\n                            <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">is_author_reply</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n                            <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date_submitted&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">contributor_authorreplies</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Comment</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">vetted</span><span class=\"p\">()</span>\n                                 <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">author</span><span class=\"o\">=</span><span class=\"n\">contributor</span><span class=\"p\">,</span> <span class=\"n\">is_author_reply</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n                                 <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;-date_submitted&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;contributor&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor</span><span class=\"p\">,</span>\n               <span class=\"s1\">&#39;contributor_publications&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor_publications</span><span class=\"p\">,</span>\n               <span class=\"s1\">&#39;contributor_submissions&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor_submissions</span><span class=\"p\">,</span>\n               <span class=\"s1\">&#39;contributor_commentaries&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor_commentaries</span><span class=\"p\">,</span>\n               <span class=\"s1\">&#39;contributor_theses&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor_theses</span><span class=\"p\">,</span>\n               <span class=\"s1\">&#39;contributor_comments&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor_comments</span><span class=\"p\">,</span>\n               <span class=\"s1\">&#39;contributor_authorreplies&#39;</span><span class=\"p\">:</span> <span class=\"n\">contributor_authorreplies</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/contributor_info.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"c1\">####################</span>\n<span class=\"c1\"># Email facilities #</span>\n<span class=\"c1\">####################</span>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_email_group_members&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"email_group_members\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.email_group_members\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">email_group_members</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Method to send bulk emails to (members of) selected groups</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">EmailGroupMembersForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">group_members</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;group&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">user_set</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">contributor__isnull</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Paginator</span><span class=\"p\">(</span><span class=\"n\">group_members</span><span class=\"p\">,</span> <span class=\"mi\">32</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">pagenr</span> <span class=\"ow\">in</span> <span class=\"n\">p</span><span class=\"o\">.</span><span class=\"n\">page_range</span><span class=\"p\">:</span>\n            <span class=\"n\">page</span> <span class=\"o\">=</span> <span class=\"n\">p</span><span class=\"o\">.</span><span class=\"n\">page</span><span class=\"p\">(</span><span class=\"n\">pagenr</span><span class=\"p\">)</span>\n            <span class=\"k\">with</span> <span class=\"n\">mail</span><span class=\"o\">.</span><span class=\"n\">get_connection</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">connection</span><span class=\"p\">:</span>\n                <span class=\"k\">for</span> <span class=\"n\">member</span> <span class=\"ow\">in</span> <span class=\"n\">page</span><span class=\"o\">.</span><span class=\"n\">object_list</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">accepts_SciPost_emails</span><span class=\"p\">:</span>\n                        <span class=\"n\">email_text</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span>\n                        <span class=\"n\">email_text_html</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span>\n                        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;personalize&#39;</span><span class=\"p\">]:</span>\n                            <span class=\"n\">email_text</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Dear &#39;</span> <span class=\"o\">+</span> <span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">get_title_display</span><span class=\"p\">()</span>\n                                          <span class=\"o\">+</span> <span class=\"s1\">&#39; &#39;</span> <span class=\"o\">+</span> <span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">last_name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;, </span><span class=\"se\">\\n\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n                            <span class=\"n\">email_text_html</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Dear {{ title }} {{ last_name }},&lt;br/&gt;&#39;</span>\n                        <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_text&#39;</span><span class=\"p\">]</span>\n                        <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;{{ email_text|linebreaks }}&#39;</span>\n                        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;include_scipost_summary&#39;</span><span class=\"p\">]:</span>\n                            <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER</span>\n                            <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER_HTML</span>\n                        <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"n\">EMAIL_FOOTER</span>\n                        <span class=\"n\">url_unsubscribe</span> <span class=\"o\">=</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:unsubscribe&#39;</span><span class=\"p\">,</span>\n                                                  <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span>\n                                                        <span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">activation_key</span><span class=\"p\">])</span>\n                        <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n\\n</span><span class=\"s1\">Don</span><span class=\"se\">\\&#39;</span><span class=\"s1\">t want to receive such emails? &#39;</span>\n                                       <span class=\"s1\">&#39;Unsubscribe by visiting </span><span class=\"si\">%s</span><span class=\"s1\">.&#39;</span> <span class=\"o\">%</span> <span class=\"n\">url_unsubscribe</span><span class=\"p\">)</span>\n                        <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"p\">(</span>\n                            <span class=\"s1\">&#39;&lt;br/&gt;</span><span class=\"se\">\\n</span><span class=\"s1\">&lt;p style=&quot;font-size: 10px;&quot;&gt;Don</span><span class=\"se\">\\&#39;</span><span class=\"s1\">t want to receive such &#39;</span>\n                            <span class=\"s1\">&#39;emails? &lt;a href=&quot;</span><span class=\"si\">%s</span><span class=\"s1\">&quot;&gt;Unsubscribe&lt;/a&gt;.&lt;/p&gt;&#39;</span> <span class=\"o\">%</span> <span class=\"n\">url_unsubscribe</span><span class=\"p\">)</span>\n                        <span class=\"n\">email_context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n                            <span class=\"s1\">&#39;title&#39;</span><span class=\"p\">:</span> <span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">get_title_display</span><span class=\"p\">(),</span>\n                            <span class=\"s1\">&#39;last_name&#39;</span><span class=\"p\">:</span> <span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">last_name</span><span class=\"p\">,</span>\n                            <span class=\"s1\">&#39;email_text&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_text&#39;</span><span class=\"p\">],</span>\n                            <span class=\"s1\">&#39;key&#39;</span><span class=\"p\">:</span> <span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">contributor</span><span class=\"o\">.</span><span class=\"n\">activation_key</span><span class=\"p\">,</span>\n                        <span class=\"p\">}</span>\n                        <span class=\"n\">html_template</span> <span class=\"o\">=</span> <span class=\"n\">Template</span><span class=\"p\">(</span><span class=\"n\">email_text_html</span><span class=\"p\">)</span>\n                        <span class=\"n\">html_version</span> <span class=\"o\">=</span> <span class=\"n\">html_template</span><span class=\"o\">.</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">Context</span><span class=\"p\">(</span><span class=\"n\">email_context</span><span class=\"p\">))</span>\n                        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"n\">EmailMultiAlternatives</span><span class=\"p\">(</span>\n                            <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_subject&#39;</span><span class=\"p\">],</span>\n                            <span class=\"n\">email_text</span><span class=\"p\">,</span> <span class=\"s1\">&#39;SciPost Admin &lt;admin@scipost.org&gt;&#39;</span><span class=\"p\">,</span>\n                            <span class=\"p\">[</span><span class=\"n\">member</span><span class=\"o\">.</span><span class=\"n\">email</span><span class=\"p\">],</span> <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n                        <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">attach_alternative</span><span class=\"p\">(</span><span class=\"n\">html_version</span><span class=\"p\">,</span> <span class=\"s1\">&#39;text/html&#39;</span><span class=\"p\">)</span>\n                        <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;ack_header&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;The email has been sent.&#39;</span><span class=\"p\">,</span>\n                   <span class=\"s1\">&#39;followup_message&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;Return to your &#39;</span><span class=\"p\">,</span>\n                   <span class=\"s1\">&#39;followup_link&#39;</span><span class=\"p\">:</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">),</span>\n                   <span class=\"s1\">&#39;followup_link_label&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;personal page&#39;</span><span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/acknowledgement.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/email_group_members.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_email_particulars&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"email_particular\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.email_particular\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">email_particular</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Method to send emails to individuals (registered or not)</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">method</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;POST&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">EmailParticularForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n            <span class=\"n\">email_text</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_text&#39;</span><span class=\"p\">]</span>\n            <span class=\"n\">email_text_html</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;{{ email_text|linebreaks }}&#39;</span>\n            <span class=\"n\">email_context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;email_text&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_text&#39;</span><span class=\"p\">]}</span>\n            <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;include_scipost_summary&#39;</span><span class=\"p\">]:</span>\n                <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER</span>\n                <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER_HTML</span>\n\n            <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;br/&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">EMAIL_FOOTER</span>\n            <span class=\"n\">html_template</span> <span class=\"o\">=</span> <span class=\"n\">Template</span><span class=\"p\">(</span><span class=\"n\">email_text_html</span><span class=\"p\">)</span>\n            <span class=\"n\">html_version</span> <span class=\"o\">=</span> <span class=\"n\">html_template</span><span class=\"o\">.</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">Context</span><span class=\"p\">(</span><span class=\"n\">email_context</span><span class=\"p\">))</span>\n            <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"n\">EmailMultiAlternatives</span><span class=\"p\">(</span>\n                <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_subject&#39;</span><span class=\"p\">],</span>\n                <span class=\"n\">email_text</span><span class=\"p\">,</span> <span class=\"s1\">&#39;SciPost Admin &lt;admin@scipost.org&gt;&#39;</span><span class=\"p\">,</span>\n                <span class=\"p\">[</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_address&#39;</span><span class=\"p\">]],</span>\n                <span class=\"n\">bcc</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;admin@scipost.org&#39;</span><span class=\"p\">])</span>\n            <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">attach_alternative</span><span class=\"p\">(</span><span class=\"n\">html_version</span><span class=\"p\">,</span> <span class=\"s1\">&#39;text/html&#39;</span><span class=\"p\">)</span>\n            <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n            <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;ack_header&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;The email has been sent.&#39;</span><span class=\"p\">,</span>\n                       <span class=\"s1\">&#39;followup_message&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;Return to your &#39;</span><span class=\"p\">,</span>\n                       <span class=\"s1\">&#39;followup_link&#39;</span><span class=\"p\">:</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">),</span>\n                       <span class=\"s1\">&#39;followup_link_label&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;personal page&#39;</span><span class=\"p\">}</span>\n            <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/acknowledgement.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">EmailParticularForm</span><span class=\"p\">()</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/email_particular.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@permission_required</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost.can_email_particulars&#39;</span><span class=\"p\">,</span> <span class=\"n\">return_403</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<div class=\"viewcode-block\" id=\"send_precooked_email\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.send_precooked_email\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">send_precooked_email</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Method to send precooked emails to individuals (registered or not)</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">SendPrecookedEmailForm</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">():</span>\n        <span class=\"n\">precookedEmail</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_option&#39;</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_address&#39;</span><span class=\"p\">]</span> <span class=\"ow\">in</span> <span class=\"n\">precookedEmail</span><span class=\"o\">.</span><span class=\"n\">emailed_to</span><span class=\"p\">:</span>\n            <span class=\"n\">errormessage</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;This message has already been sent to this address&#39;</span>\n            <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/error.html&#39;</span><span class=\"p\">,</span>\n                          <span class=\"n\">context</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;errormessage&#39;</span><span class=\"p\">:</span> <span class=\"n\">errormessage</span><span class=\"p\">})</span>\n        <span class=\"n\">precookedEmail</span><span class=\"o\">.</span><span class=\"n\">emailed_to</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_address&#39;</span><span class=\"p\">])</span>\n        <span class=\"n\">precookedEmail</span><span class=\"o\">.</span><span class=\"n\">date_last_used</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">date</span><span class=\"p\">()</span>\n        <span class=\"n\">precookedEmail</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n        <span class=\"n\">email_text</span> <span class=\"o\">=</span> <span class=\"n\">precookedEmail</span><span class=\"o\">.</span><span class=\"n\">email_text</span>\n        <span class=\"n\">email_text_html</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;{{ email_text|linebreaks }}&#39;</span>\n        <span class=\"n\">email_context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;email_text&#39;</span><span class=\"p\">:</span> <span class=\"n\">precookedEmail</span><span class=\"o\">.</span><span class=\"n\">email_text_html</span><span class=\"p\">}</span>\n        <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;include_scipost_summary&#39;</span><span class=\"p\">]:</span>\n            <span class=\"n\">email_text</span> <span class=\"o\">+=</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER</span>\n            <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"n\">SCIPOST_SUMMARY_FOOTER_HTML</span>\n\n        <span class=\"n\">email_text_html</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;&lt;br/&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"n\">EMAIL_FOOTER</span>\n        <span class=\"n\">html_template</span> <span class=\"o\">=</span> <span class=\"n\">Template</span><span class=\"p\">(</span><span class=\"n\">email_text_html</span><span class=\"p\">)</span>\n        <span class=\"n\">html_version</span> <span class=\"o\">=</span> <span class=\"n\">html_template</span><span class=\"o\">.</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">Context</span><span class=\"p\">(</span><span class=\"n\">email_context</span><span class=\"p\">))</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"n\">EmailMultiAlternatives</span><span class=\"p\">(</span>\n            <span class=\"n\">precookedEmail</span><span class=\"o\">.</span><span class=\"n\">email_subject</span><span class=\"p\">,</span>\n            <span class=\"n\">email_text</span><span class=\"p\">,</span>\n            <span class=\"n\">SciPost_from_addresses_dict</span><span class=\"p\">[</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;from_address&#39;</span><span class=\"p\">]],</span>\n            <span class=\"p\">[</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"s1\">&#39;email_address&#39;</span><span class=\"p\">]],</span>\n            <span class=\"n\">bcc</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;admin@scipost.org&#39;</span><span class=\"p\">])</span>\n        <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">attach_alternative</span><span class=\"p\">(</span><span class=\"n\">html_version</span><span class=\"p\">,</span> <span class=\"s1\">&#39;text/html&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">()</span>\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;ack_header&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;The email has been sent.&#39;</span><span class=\"p\">,</span>\n                   <span class=\"s1\">&#39;followup_message&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;Return to your &#39;</span><span class=\"p\">,</span>\n                   <span class=\"s1\">&#39;followup_link&#39;</span><span class=\"p\">:</span> <span class=\"n\">reverse</span><span class=\"p\">(</span><span class=\"s1\">&#39;scipost:personal_page&#39;</span><span class=\"p\">),</span>\n                   <span class=\"s1\">&#39;followup_link_label&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;personal page&#39;</span><span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/acknowledgement.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;form&#39;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/send_precooked_email.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"c1\">#####################</span>\n<span class=\"c1\"># Editorial College #</span>\n<span class=\"c1\">#####################</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">EdCol_bylaws</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/EdCol_by-laws.html&#39;</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@login_required</span>\n<span class=\"nd\">@fellowship_or_admin_required</span><span class=\"p\">()</span>\n<span class=\"k\">def</span> <span class=\"nf\">Fellow_activity_overview</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">fellows</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">fellows</span><span class=\"p\">()</span>\n               <span class=\"o\">.</span><span class=\"n\">prefetch_related</span><span class=\"p\">(</span><span class=\"s1\">&#39;editorial_assignments&#39;</span><span class=\"p\">)</span>\n               <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;user__last_name&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;fellows&#39;</span><span class=\"p\">:</span> <span class=\"n\">fellows</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;fellow&#39;</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">fellow</span> <span class=\"o\">=</span> <span class=\"n\">fellows</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;fellow&#39;</span><span class=\"p\">])</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;fellow&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">fellow</span>\n\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;assignments_ongoing&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">fellow</span><span class=\"o\">.</span><span class=\"n\">editorial_assignments</span>\n                                              <span class=\"o\">.</span><span class=\"n\">ongoing</span><span class=\"p\">()</span>\n                                              <span class=\"o\">.</span><span class=\"n\">get_for_user_in_pool</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">))</span>\n            <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;assignments_completed&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">fellow</span><span class=\"o\">.</span><span class=\"n\">editorial_assignments</span>\n                                                <span class=\"o\">.</span><span class=\"n\">completed</span><span class=\"p\">()</span>\n                                                <span class=\"o\">.</span><span class=\"n\">get_for_user_in_pool</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">))</span>\n        <span class=\"k\">except</span> <span class=\"n\">Contributor</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"k\">pass</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;scipost/Fellow_activity_overview.html&#39;</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">AboutView</span><span class=\"p\">(</span><span class=\"n\">ListView</span><span class=\"p\">):</span>\n    <span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"n\">EditorialCollege</span>\n    <span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;scipost/about.html&#39;</span>\n    <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">EditorialCollege</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">prefetch_related</span><span class=\"p\">(</span>\n                <span class=\"n\">Prefetch</span><span class=\"p\">(</span><span class=\"s1\">&#39;fellowships&#39;</span><span class=\"p\">,</span>\n                         <span class=\"n\">queryset</span><span class=\"o\">=</span><span class=\"n\">EditorialCollegeFellowship</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">active</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">select_related</span><span class=\"p\">(</span>\n                            <span class=\"s1\">&#39;contributor__user&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s1\">&#39;contributor__user__last_name&#39;</span><span class=\"p\">),</span>\n                         <span class=\"n\">to_attr</span><span class=\"o\">=</span><span class=\"s1\">&#39;current_fellows&#39;</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_context_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_context_data</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"n\">object_list</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">college</span> <span class=\"ow\">in</span> <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;object_list&#39;</span><span class=\"p\">]:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">spec_list</span> <span class=\"o\">=</span> <span class=\"n\">subject_areas_raw_dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">college</span><span class=\"p\">)]</span>\n            <span class=\"k\">except</span> <span class=\"ne\">KeyError</span><span class=\"p\">:</span>\n                <span class=\"n\">spec_list</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"n\">object_list</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">((</span>\n                <span class=\"n\">college</span><span class=\"p\">,</span>\n                <span class=\"n\">spec_list</span><span class=\"p\">,</span>\n            <span class=\"p\">))</span>\n        <span class=\"n\">context</span><span class=\"p\">[</span><span class=\"s1\">&#39;object_list&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">object_list</span>\n        <span class=\"k\">return</span> <span class=\"n\">context</span>\n\n\n<div class=\"viewcode-block\" id=\"csrf_failure\"><a class=\"viewcode-back\" href=\"../../../apps/scipost/#scipost.views.csrf_failure\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">csrf_failure</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">reason</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Custom CSRF Failure. Informing admins via email as well.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># Filter out privacy data</span>\n    <span class=\"n\">post_data</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"k\">for</span> <span class=\"n\">key</span> <span class=\"ow\">in</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">key</span><span class=\"p\">:</span>\n            <span class=\"n\">post_data</span><span class=\"p\">[</span><span class=\"n\">key</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">cleanse_setting</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">POST</span><span class=\"p\">[</span><span class=\"n\">key</span><span class=\"p\">])</span>\n\n    <span class=\"c1\"># Email content</span>\n    <span class=\"n\">body</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s1\">&#39;ERROR&#39;</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">reason</span><span class=\"p\">),</span>\n        <span class=\"s1\">&#39;USER&#39;</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">user</span><span class=\"p\">),</span>\n        <span class=\"s1\">&#39;GET&#39;</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">GET</span><span class=\"p\">),</span>\n        <span class=\"s1\">&#39;POST&#39;</span><span class=\"p\">:</span> <span class=\"n\">post_data</span><span class=\"p\">,</span>\n        <span class=\"s1\">&#39;META&#39;</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">META</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()},</span>\n        <span class=\"s1\">&#39;COOKIES&#39;</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">COOKIES</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()},</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"n\">body</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">(</span><span class=\"n\">body</span><span class=\"p\">,</span> <span class=\"n\">indent</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">)</span>\n\n    <span class=\"n\">mail</span><span class=\"o\">.</span><span class=\"n\">mail_admins</span><span class=\"p\">(</span><span class=\"s1\">&#39;CSRF Failure&#39;</span><span class=\"p\">,</span> <span class=\"n\">body</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">render</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"s1\">&#39;csrf-failure.html&#39;</span><span class=\"p\">)</span></div>\n</pre></div>", "sidebars": null, "title": "scipost.views"}