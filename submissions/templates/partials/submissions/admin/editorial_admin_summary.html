{% load guardian_tags %}
{% load scipost_extras %}
{% load submissions_extras %}
{% load render_bundle from webpack_loader %}


<h5 class="pb-0">{{submission.get_subject_area_display}}</h5>
<h3 class="card-title">
    <a href="{{submission.get_absolute_url}}">{{submission.title}}</a>
</h3>

<p class="card-text mb-3">by {{submission.author_list}}</p>
<h3>Info</h3>
<table class="text-muted w-100 mb-1">
    <tr>
        <td style="min-width: 40%;">Version</td>
        <td>{{submission.arxiv_vn_nr}} ({% if submission.is_current %}current version{% else %}deprecated version {{submission.arxiv_vn_nr}}{% endif %})</td>
    </tr>
    <tr>
        <td>Submitted</td>
        <td>{{submission.submission_date}} to {{submission.get_submitted_to_journal_display}}</td>
    </tr>

    {% if submission.acceptance_date %}
        <tr>
            <td>Accepted</td>
            <td>{{submission.acceptance_date}}</td>
        </tr>
    {% endif %}

    <tr>
        <td>Latest activity</td>
        <td>{{submission.latest_activity}}</td>
    </tr>
    <tr>
        <td>Editor-in-charge</td>
        <td>
            {% if submission.editor_in_charge %}
                {{ submission.editor_in_charge }}
            {% elif perms.scipost.can_assign_submissions %}
                <a href="{% url 'submissions:assign_submission' submission.arxiv_identifier_w_vn_nr %}">Send a new assignment request</a>
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    <tr>
        <td>Status</td>
        <td>{{ submission.get_status_display }}</td>
    </tr>
    <tr>
        <td>Refereeing cycle</td>
        <td>{{ submission.get_refereeing_cycle_display }}</td>
    </tr>

    {% include 'partials/submissions/refereeing_status_as_tr.html' with submission=submission %}

    <tr>
        <td>Comments</td>
        <td>
            {{submission.comments.vetted.count}}
            <span class="circle-clickable" data-toggle="tooltip" data-html="true" title="{{submission.comments.regular_comments.vetted.count}} comments<br>{{submission.comments.author_replies.vetted.count}} author replies<hr>{{submission.comments.awaiting_vetting.count}} awaiting vetting">?</span>
        </td>
    </tr>

    <tr>
        <td>Reporting deadline</td>
        <td>
            {% if submission.reporting_deadline > now %}
                in {{submission.reporting_deadline|timeuntil}}
            {% else %}
                {{submission.reporting_deadline|timesince}} ago
            {% endif %}
        </td>
    </tr>

    <tr>
        <td>Plagiarism score</td>
        <td>
            {% if submission.plagiarism_report %}
                {{ submission.plagiarism_report.score }}
            {% else %}
                <a href="{% url 'submissions:plagiarism' submission.arxiv_identifier_w_vn_nr %}">Run plagiarism check</a>
            {% endif %}
        </td>
    </tr>

</table>
<a href="{% url 'submissions:editorial_page' submission.arxiv_identifier_w_vn_nr %}" class="d-inline-block mb-3">Go to Editorial Page</a>

<h3>Actions</h3>

<ul class="pl-4 mb-3">
    {# EIC Assignments #}
    {% if perms.scipost.can_assign_submissions %}
        {% if not submission.editor_in_charge %}
            <li>EIC Assignment requests:</li>
            <ul>
                {% for assignment in submission.editorialassignment_set.all %}
                    {% include 'submissions/_assignment_info.html' with assignment=assignment %}
                {% empty %}
                    <li>None found. <a href="{% url 'submissions:assign_submission' submission.arxiv_identifier_w_vn_nr %}">Send a first assignment request</a></li>
                {% endfor %}
            </ul>
            <li><a href="{% url 'submissions:assign_submission' submission.arxiv_identifier_w_vn_nr %}">Send a new assignment request</a></li>
            <li><a href="{% url 'submissions:assignment_failed' submission.arxiv_identifier_w_vn_nr %}">Close pre-screening: failure to find EIC</a></li>
        {% endif %}
    {% endif %}

    {# Plagiarism #}
    <li><a href="{% url 'submissions:plagiarism' submission.arxiv_identifier_w_vn_nr %}">Run plagiarism check</a></li>

    {# Compile pdfs #}
    {% if submission.reports.accepted.exists %}
        <li><a href="{% url 'submissions:reports_accepted_list' %}?submission={{submission.arxiv_identifier_w_vn_nr}}">Compile accepted reports</a></li>
    {% endif %}

    {# Communication #}
    {% if submission.editor_in_charge %}
        <li><a href="{% url 'submissions:communication' arxiv_identifier_w_vn_nr=submission.arxiv_identifier_w_vn_nr comtype='StoE' %}">Send a communication to the Editor-in-charge</a></li>
    {% endif %}

    {# EIC Recommendations #}
    {% if submission.eicrecommendations.exists %}
        <li>See Editorial Recommendations:</li>
        <ul>
            {% for rec in submission.eicrecommendations.all %}
                <li><a href="{% url 'submissions:eic_recommendation_detail' arxiv_identifier_w_vn_nr=submission.arxiv_identifier_w_vn_nr rec_id=rec.id %}">{{rec.get_recommendation_display}}</a></li>
            {% endfor %}
        </ul>
    {% endif %}

    {# Accepted submission actions #}
    {% if submission.status == 'accepted' %}
        <li><a href="{% url 'submissions:treated_submission_pdf_compile' submission.arxiv_identifier_w_vn_nr %}">Update the Refereeing Package pdf</a></li>
        <li>After proofs have been accepted, you can <a href="{% url 'journals:initiate_publication' %}">initiate the publication process</a> (leads to the validation page)</li>
    {% endif %}
</ul>


<h3>Events</h3>
<a href="javascript:;" data-toggle="toggle" data-target="#eventslist">Show/hide events</a>
<div id="eventslist">
    {% include 'submissions/submission_event_list.html' with events=submission.events.for_eic %}
</div>

{% block footer_script %}
    {% render_bundle 'tooltip' 'js' %}
{% endblock %}
