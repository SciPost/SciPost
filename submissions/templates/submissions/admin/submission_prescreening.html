{% extends 'submissions/admin/base.html' %}

{% load bootstrap %}
{% load scipost_extras %}
{% load conflict_tags %}

{% block pagetitle %}: pre-screening ({{ submission.arxiv_identifier_w_vn_nr }}){% endblock pagetitle %}

{% block breadcrumb_items %}
    {{block.super}}
    <span class="breadcrumb-item">Pre-screening {{ submission.arxiv_identifier_w_vn_nr }}</span>
{% endblock %}

{% block content %}
    <h1 class="highlight">Pre-screening of Submission</h1>
    <h3>Submission summary</h3>
    {% include 'partials/submissions/submission_summary.html' with submission=submission hide_title=1 show_abstract=1 %}

    <h3>Fellows ({{ submission.fellows.ordered|length }})</h3>
    <a href="{% url 'colleges:submission' submission.arxiv_identifier_w_vn_nr %}">Manage Pool composition</a><br>
    <a href="javascript:;" data-toggle="toggle" data-target="#fellows">Show/hide all Fellows</a>
    <table style="display: none;" class="table table-hover my-2" id="fellows">
        <thead>
            <tr>
                <th>Fellow name</th>
                <th>Expertises</th>
            </tr>
        </thead>
        <tbody>
            {% for fellow in submission.fellows.ordered %}
                <tr>
                    <td>{{ fellow }}</td>
                    <td>
                        {% for expertise in fellow.contributor.expertises %}
                            <div class="single d-inline" data-specialization="{{expertise|lower}}" data-toggle="tooltip" data-placement="bottom" title="{{expertise|get_specialization_display}}">{{expertise|get_specialization_code}}</div>
                        {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 class="mt-2">Plagiarism report</h3>
    {% if submission.plagiarism_report %}
        <a href="{% url 'submissions:plagiarism' submission.arxiv_identifier_w_vn_nr %}">Update plagiarism report</a>
        <br>
        <table>
            <tr>
                <td style="min-width: 150px;">iThenticate document</td>
                <td>{{submission.plagiarism_report.doc_id}}</td>
            </tr>
            <tr>
                <td>Percent match</td>
                <td>{{ submission.plagiarism_report.percent_match|default:'?' }}%</td>
            </tr>
            <tr>
                <td>Processed</td>
                <td>{{submission.plagiarism_report.processed_time}}</td>
            </tr>
            <tr>
                <td>Uploaded</td>
                <td>{{submission.plagiarism_report.uploaded_time}}</td>
            </tr>
            <tr>
                <td>Latest update</td>
                <td>{{submission.plagiarism_report.latest_activity}}</td>
            </tr>
        </table>
        <br>
    {% else %}
        <p>No Plagiarism Report found. <a href="{% url 'submissions:plagiarism' submission.arxiv_identifier_w_vn_nr %}">Run plagiarism check</a>.</p>
    {% endif %}

    <h3>Editorial Pre-assignments</h3>
    <div>

        {% if submission.needs_conflicts_update %}
            <p>
                <i class="fa fa-clock-o text-danger" aria-hidden="true"></i>
                <span class="text-muted">Conflict of interest awaiting update. <a href="mailto:techsupport@scipost.org">Contact techsupport</a> if this is not automatically resolved soon.</span>
            </p>
        {% else %}
            <p>
                <i class="fa fa-check-circle text-success" aria-hidden="true"></i>
                <span class="text-muted">Conflict of interest updated.</span>
                <br><br>

                Select Fellows that are eligable to become editor-in-charge and sort them in prefered order of invitation. Every [time], the next selected Fellow in line will be invited until an editor is assigned.
            </p>

            <table class="table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Fellow</th>
                        <th>Possible conflicts</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fellow in submission.fellows.all %}
                        <tr>
                            <td>
                                <a href="javascript:;"><i class="fa fa-bars" aria-hidden="true"></i></a>
                                <input type="checkbox" class="ml-2">
                            </td>
                            <td>{{ fellow.contributor }}</td>
                            <td>
                                {% for conflict in submission.conflicts.all|filter_for_contributor:fellow.contributor %}
                                    <div class="my-1">
                                        <a href="{{ conflict.conflict_url }}" target="_blank">{{ conflict.conflict_title }}</a>
                                        <br>
                                        In conflict with: {{ conflict.to_name }}
                                        <br>
                                        {% if conflict.status == 'unverified' %}
                                            <i class="fa fa-question-circle text-warning" aria-hidden="true"></i>
                                        {% elif conflict.status == 'verified' %}
                                            <i class="fa fa-check-circle text-success" aria-hidden="true"></i>
                                        {% endif %}
                                        {{ conflict.get_status_display }}: {{ conflict.get_type_display }}.


                                        <br>
                                    </div>
                                {% empty %}
                                    <em><i class="fa fa-check text-success" aria-hidden="true"></i> No conflicts found</em>
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    <h3>Take decision on pre-screening</h3>
    <form method="post">
        {% csrf_token %}
        {{ form|bootstrap }}
        <input type="submit" class="btn btn-primary" value="Submit">
    </form>

{% endblock content %}
