{% extends 'submissions/admin/base.html' %}

{% load bootstrap %}
{% load scipost_extras %}
{% load conflict_tags %}

{% block pagetitle %}: Submission Editors{% endblock pagetitle %}

{% block breadcrumb_items %}
    {{block.super}}
    {% if submission.status == 'incoming' %}
        <a href="{% url 'submissions:do_prescreening' submission.preprint.identifier_w_vn_nr %}" class="breadcrumb-item">Pre-screening {{ submission.preprint.identifier_w_vn_nr }}</a>
    {% else %}
        <a href="{% url 'submissions:editorial_page' submission.preprint.identifier_w_vn_nr %}" class="breadcrumb-item">Editorial page {{ submission.preprint.identifier_w_vn_nr }}</a>
    {% endif %}
    <span class="breadcrumb-item">Editor invitations</span>
{% endblock %}

{% block content %}


<h1 class="highlight">Submission editor invitations</h1>
<h3 class="mb-0"><a href="{{ submission.get_absolute_url }}">{{submission.title}}</a></h3>
<h4>by {{submission.author_list}}</h4>
<br>

<h3>Submission summary</h3>
{% include 'partials/submissions/submission_summary.html' with submission=submission hide_title=1 show_abstract=0 %}

<br>

{% if submission.status == 'incoming' %}
    <li><a href="{% url 'submissions:do_prescreening' submission.preprint.identifier_w_vn_nr %}">Go to pre-screening page</a></li>
{% endif %}
    <li><a href="{% url 'submissions:editorial_page' submission.preprint.identifier_w_vn_nr %}">Go to editorial page</a></li>

<br><br>

<h3 class="highlight">Current invitations</h3>
<table class="submission" id="current-status">
    <tbody>
        {% if active_assignment %}
            <tr>
                <td>Assigned editor-in-charge</td>
                <td>{{ active_assignment.to }}</td>
            </tr>
            <tr>
                <td>Assignment status</td>
                <td>{{ active_assignment.get_status_display }}</td>
            </tr>
        {% else %}
            <tr>
                <td style="min-width: 200px;">Conflict of interests:</td>
                <td>
                    {% if submission.needs_conflicts_update %}
                        Conflict of interest awaiting update. <a href="mailto:techsupport@scipost.org">Contact techsupport</a> if this is not automatically resolved soon.
                    {% else %}
                        Conflict of interest updated
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Submission status:</td>
                <td>{{ submission.get_status_display }}</td>
            </tr>
        {% endif %}
    </tbody>
</table>

<br>

<table class="table table-hover" id="current-assignments">
    <thead>
        <tr>
            <th style="width: 10px;">#</th>
            <th style="width: 20%;">Fellow</th>
            <th>Status</th>
            <th>Invited on</th>
        </tr>
    </thead>
    <tbody>
        {% for assignment in assignments %}
            <tr>
                <td>{{ assignment.invitation_order }}</td>
                <td>
                    <strong>{{ assignment.to }}</strong>
                    <br>
                    {% for expertise in assignment.to.expertises %}
                        <div class="single d-inline specialization" data-specialization="{{expertise|lower}}" data-toggle="tooltip" data-placement="bottom" title="{{expertise|get_specialization_display}}">{{expertise|get_specialization_code}}</div>
                    {% endfor %}
                </td>
                <td>{{ assignment.get_status_display }}</td>
                <td>
                    {{ assignment.date_invited|default:'<i>Not invited (yet)</i>' }}
                    {% if assignment.status == 'preassigned' %}
                        <br>
                        <a href="#">Send invitation now</a>
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="4">No invitations yet. Please use the form below.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

{% if formset %}
    <hr class="divider">
    <h2 class="highlight">Update invitations</h2>
    <p>Use the form below to select and order the fellows you want to invite to become an editor for <em>'{{ submission.title }}'</em>.</p>

    <form method="post" action="{% url 'submissions:editor_invitations' submission.preprint.identifier_w_vn_nr %}">
        {% csrf_token %}
        {{ formset.management_form }}
        <table class="table sortable-rows table-selectable table-hover" id="preassignments">
            <thead>
                <tr>
                    <th style="width: 60px;"></th>
                    <th style="width: 20%;">Fellow</th>
                    <th>Possible conflicts</th>
                </tr>
            </thead>
            <tbody>
                {% for form in formset %}
                    <tr>
                        <td class="actions">
                            <a href="javascript:;" class="handle"><i class="fa fa-bars" aria-hidden="true"></i></a>
                            {% for field in form %}
                                {{ field }}
                            {% endfor %}
                        </td>
                        <td>
                            <strong>
                                {{ form.get_fellow }}
                                {% if form.instance.status != 'preassigned' %}
                                    <span data-toggle="tooltip" data-title="This fellow has already been invited. Therefore, this invitation will not be removed."><i class="fa fa-exclamation-circle text-danger" aria-hidden="true"></i></span>
                                {% endif %}
                            </strong>
                            <br>
                            {% for expertise in form.get_fellow.expertises %}
                                <div class="single d-inline specialization" data-specialization="{{expertise|lower}}" data-toggle="tooltip" data-placement="bottom" title="{{expertise|get_specialization_display}}">{{expertise|get_specialization_code}}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% with submission.conflict_groups.all|filter_for_contributor:form.get_fellow as conflict_groups %}
                                {% if conflict_groups %}
                                    {{ conflict_groups|length }} conflict{{ conflict_groups|length|pluralize }} found
                                    <br>
                                    <a href="javascript:;" data-toggle="toggle" data-target="#fellow-conflicts-{{ form.id }}">Show/hide conflicts</a>
                                    <div id="fellow-conflicts-{{ form.id }}">
                                        {% for conflict_group in conflict_groups %}
                                            <div class="my-1">
                                                <h4><a href="{{ conflict_group.url }}" target="_blank">{{ conflict_group.title }}</a></h4>
                                                <p>Conflict details:</p>
                                                <table class="table table-sm border">
                                                    <tr>f
                                                        <th>Person</th>
                                                        <th>Status</th>
                                                        <th>Conflict type</th>
                                                    </tr>
                                                    {% for conflict in conflict_group.conflicts.non_deprecated %}
                                                        <tr id="conflict-{{ conflict.id }}">
                                                            <td>{{ conflict.to_name }}</td>
                                                            <td class="status">
                                                                {% if conflict.status == 'unverified' %}
                                                                    <i class="fa fa-question-circle text-warning" aria-hidden="true"></i>
                                                                {% elif conflict.status == 'verified' %}
                                                                    <i class="fa fa-check-circle text-success" aria-hidden="true"></i>
                                                                {% endif %}

                                                                {{ conflict.get_status_display }}

                                                                {% if conflict.status == 'unverified' %}
                                                                    <div class="d-inline-block ml-3 actions">
                                                                        <a href="javascript:;" onclick="update_conflict({{ conflict.id }}, 'verified')">Verify</a>
                                                                        &middot;
                                                                        <a href="javascript:;" class="text-danger" onclick="update_conflict({{ conflict.id }}, 'delete')">Delete</a>
                                                                    </div>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ conflict.get_type_display }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </table>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <em><i class="fa fa-check text-success" aria-hidden="true"></i> No conflicts found</em>
                                {% endif %}
                            {% endwith %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <button class="btn btn-primary" type="submit">Save pre-assignments</button>
    </form>
{% endif %}

{% endblock %}

{% block footer_script %}
    <script>
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        function update_conflict(conflict_id, status) {
            $.ajax({
                "method": "POST",
                "url": "{% url 'api:conflictofinterest-verify_conflict' 0 %}".replace("0", conflict_id),
                "data": {
                    'status': status,
                    'csrftoken': getCookie('csrftoken'),
                },
                "beforeSend": function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
            }).done(function( data ) {
                if ( data['status'] == 'verified' ) {
                    $("#conflict-" + data['id'] + " .status").html('<i class="fa fa-check-circle text-success" aria-hidden="true"></i> Verified by Admin');
                } else if ( data['status'] == 'deprecated' ) {
                    $("#conflict-" + data['id'] ).fadeTo("fast", 0.3).find('.status').html('<em>deleted</em>');
                }
            });
        }


        // $(function () {
        //     $('#preassignments tbody').sortable();
        // });
    </script>
{% endblock %}
