{% extends 'submissions/pool/base.html' %}

{% load bootstrap %}
{% load scipost_extras %}

{% block breadcrumb_items %}
  {{ block.super }}
  <span class="breadcrumb-item">Editorial Recommendation</span>
{% endblock %}

{% block pagetitle %}: Editorial Recommendation{% endblock pagetitle %}

{% block content %}


  {% if voting_form.errors %}
    <h1 class="text-danger">Warning: there was an error filling the voting form</h1>
    {% for field in voting_form %}
      {% for error in field.errors %}
        <div class="alert alert-danger">
          <strong>{{ error|escape }}</strong>
        </div>
      {% endfor %}
    {% endfor %}
    {% for error in voting_form.non_field_errors %}
      <div class="alert alert-danger">
        <strong>{{ error|escape }}</strong>
      </div>
    {% endfor %}
    <p class="text-danger">Please <a href="#votingForm">go back to the form</a> and try again!</p>
  {% endif %}


  <h1 class="highlight">Editorial Recommendation</h1>

  <h2>Concerning Submission:</h2>
  {% include 'partials/submissions/submission_li.html' with submission=recommendation.submission %}

  <a class="d-inline-block mb-3" href="{{ recommendation.submission.get_absolute_url }}" target="_blank">View Reports and Submission details</a>

  {% include 'partials/submissions/pool/submission_info_table.html' with submission=recommendation.submission %}
  <br>

  {% if recommendation.get_other_versions %}
    <div class="card text-white bg-dark">
      <div class="card-header">
	<a class="btn btn-secondary text-white bg-dark" data-toggle="collapse" href="#previousEdRecs" role="button" aria-expanded="false" aria-controls="previousEdRecs">Deprecated versions of Editorial Recommendations for this Submission (click to expand/collapse)</a>
      </div>
      <div class="collapse" id="previousEdRecs">
	<div class="card-body">
	  {% for old_rec in recommendation.get_other_versions %}
            {% include 'partials/submissions/recommendation_fellow_content.html' with recommendation=old_rec %}
            <h3 class="card-title">Fellows eligible to vote:</h3>
            <ul>
              {% for eligible in old_rec.eligible_to_vote.all|sort_by:'user__last_name' %}
		<li>{{ eligible.user.first_name }} {{ eligible.user.last_name }}</li>
              {% endfor %}
            </ul>
            <h3 class="card-title">Voting results:</h3>
            <ul>
              <li>
		Agreed ({{ old_rec.voted_for.all.count }}):
		{% for agreed in old_rec.voted_for.all|sort_by:'user__last_name' %}
		  {{ agreed.user.last_name }}{% if not forloop.last %},{% endif %}
		{% endfor %}
              </li>
              <li>
		Disagreed ({{ old_rec.voted_against.all.count }}):
		{% for disagreed in old_rec.voted_against.all|sort_by:'user__last_name' %}
		  {{ disagreed.user.last_name }}{% if not forloop.last %},{% endif %}
		{% endfor %}
              </li>
              <li>
		Abstained ({{ old_rec.voted_abstain.all.count }}):
		{% for abstained in old_rec.voted_abstain.all|sort_by:'user__last_name' %}
		  {{ abstained.user.last_name }}{% if not forloop.last %},{% endif %}
		{% endfor %}
              </li>
            </ul>
	    {% if old_rec.submission.tierings.all|length > 0 %}
	      <h3>Tierings specified by voting Fellows</h3>
	      <ul>
	      {% for tiering in old_rec.submission.tierings.all %}
		<li>{{ tiering.fellow }}: for Journal <em>{{ tiering.for_journal }}</em>: {{ tiering.get_tier_display }}</li>
	      {% endfor %}
	      </ul>
	    {% endif %}
	    {% if old_rec.alternativerecommendation_set.all|length > 0 %}
	      <h3>Alternative recommendations offered during voting by Fellows who disagreed:</h3>
	      <ul>
		{% for altrec in old_rec.alternativerecommendation_set.all %}
		  <li>{{ altrec.fellow }}: for Journal <em>{{ altrec.for_journal }}</em>: <strong>{{ altrec.get_recommendation_display }}</strong></li>
		{% endfor %}
	      </ul>
	    {% endif %}
            <h3 class="card-title">Remarks:</h3>
            <ul>
              {% for rem in old_rec.remarks.all %}
		<li>{% include 'partials/submissions/remark_small.html' with remark=rem %}</li>
              {% empty %}
		<li><em>No remarks</em></li>
              {% endfor %}
            </ul>
	  {% endfor %}
	</div>
      </div>
    </div>
  {% endif %}

  <h2 class="highlight">Editorial Recommendation (latest)</h2>
  {% include 'partials/submissions/recommendation_fellow_content.html' with recommendation=recommendation %}

  <div class="card">
    <div class="card-body">

      <h3 class="card-title">Fellows eligible to vote:</h3>
      <ul>
        {% for eligible in recommendation.eligible_to_vote.all|sort_by:'user__last_name' %}
          <li>{{ eligible.user.first_name }} {{ eligible.user.last_name }}</li>
        {% endfor %}
      </ul>

      <h3 class="card-title">Voting results up to now:</h3>
      <ul>
        <li>
          Agreed ({{ recommendation.voted_for.all.count }}):
          {% for agreed in recommendation.voted_for.all|sort_by:'user__last_name' %}
            {{ agreed.user.last_name }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        </li>
        <li>
          Disagreed ({{ recommendation.voted_against.all.count }}):
          {% for disagreed in recommendation.voted_against.all|sort_by:'user__last_name' %}
            {{ disagreed.user.last_name }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        </li>
        <li>
          Abstained ({{ recommendation.voted_abstain.all.count }}):
          {% for abstained in recommendation.voted_abstain.all|sort_by:'user__last_name' %}
            {{ abstained.user.last_name }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        </li>
      </ul>

      {% if recommendation.submission.tierings.all|length > 0 %}
	<h3>Tierings for this Submission, as indicated by voting Fellows who agreed with publication</h3>
	<table class="table table-bordered">
	  <thead>
	    <tr>
	      <th class="py-1">Fellow</th>
	      <th class="py-1">For Journal</th>
	      <th class="py-1">Tier</th>
	    </tr>
	  </thead>
	  <tbody>
	    {% for tiering in recommendation.submission.tierings.all %}
	      <tr>
		<td>{{ tiering.fellow }}</td>
		<td>{{ tiering.for_journal }}</td>
		<td>{{ tiering.get_tier_display }}</td>
	      </tr>
	    {% endfor %}
	  </tbody>
	</table>
      {% endif %}

      {% if recommendation.alternativerecommendation_set.all|length > 0 %}
	<h3>Alternative recommendations offered during voting by Fellows who disagreed:</h3>
	<table class="table table-bordered">
	  <thead>
	    <tr>
	      <th class="py-1">Fellow</th>
	      <th class="py-1">For Journal</th>
	      <th class="py-1">Alternative Recommendation</th>
	    </tr>
	  </thead>
	  <tbody>
	  {% for altrec in recommendation.alternativerecommendation_set.all %}
	    <tr>
	      <td>{{ altrec.fellow }}</td>
	      <td>{{ altrec.for_journal }}</td>
	      <td>{{ altrec.get_recommendation_display }}</td>
	    </tr>
	  {% endfor %}
	  </tbody>
	</table>
      {% endif %}

      <h3 class="card-title">Remarks:</h3>
      <ul>
        {% for rem in recommendation.remarks.all %}
          <li>{% include 'partials/submissions/remark_small.html' with remark=rem %}</li>
        {% empty %}
          <li><em>No remarks</em></li>
        {% endfor %}
      </ul>

    </div>

    {% if perms.scipost.can_fix_College_decision %}
      <div class="card-footer bg-light py-3">
        <h3 class="card-title mb-3">Administrative actions on recommendations undergoing voting:</h3>
        <ul class="mb-1">
          <li class="list-item my-2"><a class="btn btn-secondary" href="{% url 'submissions:remind_Fellows_to_vote' %}" role="button">Send an email reminder to each Fellow with at least one voting duty</a><br>(this is a one-click action, for all Submissions)</li>
	  <li class="list-item my-2"><a class="btn btn-warning" href="{% url 'submissions:communication' identifier_w_vn_nr=recommendation.submission.preprint.identifier_w_vn_nr comtype='StoE' %}" role="button">Send a communication to the Editor-in-charge</a><br>(for example to request a reformulation of the recommendation)</li>
          <li class="list-item my-2">
            <!-- The current Editorial Recommendation is for Journal {{ recommendation.for_journal }}: {{ recommendation.get_recommendation_display }}.
		 <br> -->
	    <a class="btn btn-primary" href="{% url 'submissions:editorial_decision_create' recommendation.submission.preprint.identifier_w_vn_nr %}" role="button">Initiate the process to fix the editorial decision</a>
	    <!-- <br>
		 <form method="post" action="{% url 'submissions:eic_recommendation_detail' recommendation.submission.preprint.identifier_w_vn_nr recommendation.id %}" class="d-inline-block my-2">
		 {% csrf_token %}
		 <button type="submit" name="action" value="fix" class="btn btn-primary btn-sm mr-2">Fix College decision</button>
		 <button type="submit" name="action" value="deprecate" class="btn btn-danger btn-sm text-white">Deprecate College decision</button>
		 </form> -->
          </li>
        </ul>
      </div>
    {% endif %}
  </div>

  {% if voting_form %}
    <h3 class="mt-4" id="votingForm">Your position on this recommendation</h3>
    {% if previous_vote %}
      <p>You had previously voted <span class="text-danger">{{ previous_vote }}</span>; you can use the form below to change your vote and/or add a remark:</p>
    {% endif %}
    <form action="{% url 'submissions:vote_on_rec' rec_id=recommendation.id %}" method="post">
      <p id="agree_instructions">
	{% if recommendation.recommendation == 1 %}
	  <strong class="text-success">If you agree with a recommendation to publish, you can provide your ballpark quality tiering below</strong><br>(this is not compulsory, but most welcome)
	{% endif %}
      </p>
      <p id="disagree_instructions" class="text-danger"><strong>If you vote disagree, please provide an alternative recommendation below</strong></p>
      {% csrf_token %}
      {{ voting_form|bootstrap }}
      <input type="submit" name="submit" value="Cast your vote" class="btn btn-primary" id="submit-id-submit">
    </form>
  {% endif %}

{% endblock %}

{% block footer_script %}
  <script nonce="{{ request.csp_nonce }}">
   $(document).ready(function(){
       $("#agree_instructions").hide()
       $("#disagree_instructions").hide()
       $("input[name=tier]").parents('.form-group').hide()
       $("#id_alternative_for_journal").parents('.form-group').hide()
       $("#id_alternative_recommendation").parents('.form-group').hide()
       $('input[name=vote]').on('change', function(){
	   var selection = $('input[name=vote]:checked').val();
	   switch(selection){
	       case "agree":
		   $("#agree_instructions").show()
		   $("#disagree_instructions").hide()
		   {% if recommendation.recommendation == 1 %}
		   $("input[name=tier]").parents('.form-group').show()
		   {% endif %}
		   $("#id_alternative_for_journal").parents('.form-group').hide()
		   $("#id_alternative_recommendation").parents('.form-group').hide()
		   break;
	       case "disagree":
		   $("#agree_instructions").hide()
		   $("#disagree_instructions").show()
		   $("input[name=tier]").parents('.form-group').hide()
		   $("#id_alternative_for_journal").parents('.form-group').show()
		   $("#id_alternative_recommendation").parents('.form-group').show()
		   break;
	       default:
		   $("#agree_instructions").hide()
		   $("#disagree_instructions").hide()
		   $("input[name=tier]").parents('.form-group').hide()
		   $("#id_alternative_for_journal").parents('.form-group').hide()
		   $("#id_alternative_recommendation").parents('.form-group').hide()
		   break;
	   }
       }).trigger('change');
   });
  </script>
{% endblock %}
