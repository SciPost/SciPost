{% extends 'forums/base.html' %}

{% load bootstrap %}
{% load guardian_tags %}
{% load restructuredtext %}

{% block breadcrumb_items %}
    {{ block.super }}
<span class="breadcrumb-item">{% if forum.meeting %}Meeting{% else %}Forum{% endif %} Details</span>
{% endblock %}

{% load scipost_extras %}

{% block pagetitle %}: {% if forum.meeting %}Meeting{% else %}Forum{% endif %} details{% endblock pagetitle %}

{% get_obj_perms request.user for forum as "user_perms" %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h3 class="highlight">
      {% if forum.meeting %}
      {% with context_colors=forum.meeting.context_colors %}
      <span class="badge badge-{{ context_colors.bg }} mx-0 mb-2 p-2 text-{{ context_colors.text }}">{{ context_colors.message }}</span>
      {% endwith %}
      <br/>
      {% endif %}

      <span class="d-flex justify-content-between">
	<a href="{{ forum.get_absolute_url }}">{{ forum }}</a>
	<span class="badge badge-primary badge-pill">{% with nr_posts=forum.nr_posts %}{{ nr_posts }} post{{ nr_posts|pluralize }}{% endwith %}</span>
      </span>
    </h3>

    {% if forum.parent %}
    <p>Parent: <a href="{{ forum.parent.get_absolute_url }}">{{ forum.parent }}</a></p>
    {% endif %}
    {% if forum.child_forums.all|length > 0 %}
    <p>Descendants: {% for child in forum.child_forums.all %}<a href="{{ child.get_absolute_url }}">{{ child }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</p>
    {% endif %}

    {% if perms.forums.add_forum or "can_change_forum" in user_perms %}
    <h4>Admin actions:</h4>
    <ul>
      <li><a href="{% url 'forums:forum_update' slug=forum.slug %}" class="text-warning">Update this {% if forum.meeting %}Meeting{% else %}Forum{% endif %}</a></li>
      <li>
	{% if not forum.child_forums.all|length > 0 %}
	<a href="{% url 'forums:forum_delete' slug=forum.slug %}" class="text-danger">Delete this {% if forum.meeting %}Meeting{% else %}Forum{% endif %} (and all Posts {% if forum.meeting %}and Motions {% endif %}it contains)</a>
	{% else %}
	<span class="text-danger" style="text-decoration: line-through;">Delete this Forum</span> Please delete descendant Forums first.
	{% endif %}
      </li>
      {% if not forum.meeting %}
      <li><a href="{% url 'forums:forum_create' parent_model='forum' parent_id=forum.id %}">Create a (sub)Forum within this one</a></li>
      {% endif %}
    </ul>

    <div class="card">
      <div class="card-header">
	Permissions on this {% if forum.meeting %}Meeting{% else %}Forum{% endif %} instance
	<button class="btn btn-link small" data-toggle="collapse" data-target="#permissionsCard">
	View/manage</button>
      </div>
      <div class="card-body collapse" id="permissionsCard">
	<p><a href="{% url 'forums:forum_permissions' slug=forum.slug %}">Grant permissions to a new group</a></p>
	<p>Groups with permissions [click on the Group's name to manage permissions]:</p>
	<ul>
	  {% for group in groups_with_perms %}
	  {% get_obj_perms group for forum as "group_perms" %}
	  <li><a href="{% url 'forums:forum_permissions' slug=forum.slug group_id=group.id %}">{{ group.name }}</a>: {{ group_perms }}</li>
	  {% empty %}
	  <li>No group has permissions on this Forum</li>
	  {% endfor %}
	</ul>

	<p>Users with permissions:</p>
	<ul>
	  {% for u in users_with_perms %}
	  {% get_obj_perms u for forum as "u_perms" %}
	  <li>{{ u.first_name }} {{ u.last_name }}: {{ u_perms }}</li>
	  {% endfor %}
	</ul>
      </div>
    </div>

    {% endif %}

    <h3 class="highlight">Description</h3>
    {{ forum.description|restructuredtext }}

    <h3 class="highlight">Posts</h3>

    {% for post in forum.posts.all %}
    {% include 'forums/post_card.html' with forum=forum post=post %}
    {% endfor %}

    <p>
      <a href="{% url 'forums:post_create' slug=forum.slug parent_model='forum' parent_id=forum.id %}">Add a Post</a>
    </p>

  </div>
</div>

{% endblock content %}
