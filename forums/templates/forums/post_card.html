{% load restructuredtext %}

<div class="card m-2 {% if post.motion %}text-white bg-dark{% else %}text-body{% endif %}" id="post{{ post.id }}">
  <div class="card-header">
    {{ post.subject }}
    <div class="postInfo">
      {{ post.posted_by.first_name }} {{ post.posted_by.last_name }} on {{ post.posted_on|date:"Y-m-d" }}
      - <a href="{{ post.get_absolute_url }}"><i class="fa fa-link" title="permalink to this Post"></i></a>
      {% if post.parent and not post.motion %}
      - regarding <a href="{{ post.parent.get_absolute_url }}">{{ post.parent }}</a>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    {{ post.text|restructuredtext }}
  </div>
  <div class="card-footer">
    <div class="d-flex flex-wrap justify-content-end align-items-center">
      <div class="flex-grow-1">
	{% if post.followup_posts.all|length > 0 %}
	<span class="badge badge-primary badge-pill">{% with nr_followups=post.nr_followups %}{{ nr_followups }} repl{{ nr_followups|pluralize:"y,ies" }}{% endwith %}</span>
	{% endif %}&nbsp;
	{% if post.post_ptr %}
	<a href="{% url 'forums:post_create' slug=forum.slug parent_model='post' parent_id=post.post_ptr.id %}">{% if post.motion %}Post a Comment on this Motion{% else %}Reply to the above post{% endif %}</a>
	{% else %}
	<a href="{% url 'forums:post_create' slug=forum.slug parent_model='post' parent_id=post.id %}">{% if post.motion %}Post a Comment on this Motion{% else %}Reply to the above post{% endif %}</a>
	{% endif %}
      </div>

      {% if post.motion %}
      <div class="align-self-center px-2">
	Voting results
	<span class="text-white-50">
	{% if request.user in post.motion.in_agreement.all %}
	<br/>You have voted <span class="text-success">Agree</span>
	{% elif request.user in post.motion.in_doubt.all %}
	<br/>You have voted <span class="text-warning">Doubt</span>
	{% elif request.user in post.motion.in_disagreement.all %}
	<br/>You have voted <span class="text-danger">Disagree</span>
	{% elif request.user in post.motion.in_abstain.all %}
	<br/>You have <span class="text-white-50">Abstained</span>
	{% elif request.user in post.motion.eligible_for_voting.all %}
	<br/>[click to vote]
	{% endif %}
	</span>
      </div>
      <div>
	<form action="{% url 'forums:motion_vote' slug=forum.slug motion_id=post.motion.id vote='Y' %}" method="post">{% csrf_token %}
	  <input type="submit" class="btn btn-success" data-toggle="tooltip" data-placement="top" title="Agree" value="{{ post.motion.in_agreement.all|length }}">
	</form>
      </div>
      <div>
	<form action="{% url 'forums:motion_vote' slug=forum.slug motion_id=post.motion.id vote='M' %}" method="post">{% csrf_token %}
	  <input type="submit" class="btn btn-warning" data-toggle="tooltip" data-placement="top" title="Doubt" value="{{ post.motion.in_doubt.all|length }}">
	</form>
      </div>
      <div>
	<form action="{% url 'forums:motion_vote' slug=forum.slug motion_id=post.motion.id vote='N' %}" method="post">{% csrf_token %}
	  <input type="submit" class="btn btn-danger" data-toggle="tooltip" data-placement="top" title="Disagree" value="{{ post.motion.in_disagreement.all|length }}">
	</form>
      </div>
      <div>
	<form action="{% url 'forums:motion_vote' slug=forum.slug motion_id=post.motion.id vote='A' %}" method="post">{% csrf_token %}
	  <input type="submit" class="btn btn-secondary" data-toggle="tooltip" data-placement="top" title="Abstain" value="{{ post.motion.in_abstain.all|length }}">
	</form>
      </div>
      <div class="align-self-center px-2">
	Voting deadline:<br/>{{ post.motion.voting_deadline|date:'Y-m-d' }}
      </div>
      {% endif %}
    </div>
  </div>
  {% if post.followup_posts.all|length > 0 %}
  <div class="followupPosts{% if post.motion %}AfterMotion{% endif %}">
    {% for followup in post.followup_posts.all %}
    {% include 'forums/post_card.html' with post=followup %}
    {% endfor %}
  </div>
  {% endif %}
</div>
