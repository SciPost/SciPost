{% load bootstrap %}
{% load process_markup %}
{% load scipost_extras %}

<div class="card">
  <div class="card-header">
    <div class="d-flex justify-content-between">
      <span>
	{{ ticket }}
	{% if ticket.concerning_object %}
	  <span>
	    <br/>Re: <a href="{{ ticket.concerning_object.get_absolute_url }}" target="_blank">{{ ticket.concerning_object }}</a>
	  </span>
	{% endif %}
      </span>
      {% with classes=ticket.status_classes %}
	<button class="btn btn-{{ classes.class }} text-{{ classes.text }}">{{ ticket.get_status_display }}</button>
      {% endwith %}
    </div>
  </div>
  <div class="card-content">
    <table class="table table-bordered">
      <tbody>
	<tr>
	  <th>Description</th>
	  <td>{{ ticket.description|process_markup }}</td>
	</tr>
	<tr>
	  <th>Defined on</th>
	  <td>{{ ticket.defined_on }}</td>
	</tr>
	<tr>
	  <th>Defined by</th>
	  <td>{{ ticket.defined_by.first_name }} {{ ticket.defined_by.last_name }} ({{ ticket.defined_by.username }})</td>
	</tr>
	<tr>
	  <th>Priority</th>
	  <td>{{ ticket.priority_icons|safe }} - {{ ticket.get_priority_display }}</td>
	</tr>
	<tr>
	  <th>Status</th>
	  <td>
	    {% with classes=ticket.status_classes %}
	      <span class="bg-{{ classes.class }} text-{{ classes.text }}">&emsp;</span>
	    {% endwith %}
	    {{ ticket.get_status_display }}
	  </td>
	</tr>
	{% if ticket.assigned_to %}
	  <tr>
	    <th>Assigned to</th>
	    <td>{{ ticket.assigned_to.get_full_name }} ({{ ticket.assigned_to.username }})</td>
	  </tr>
	{% endif %}
	<tr>
	  <th>Followups</th>
	  <td>
	    <ul class="list-unstyled">
	      {% for followup in ticket.followups.all %}
		<li>
		  <div class="card mb-1" id="{{ followup.id }}">
		    <div class="card-header">
		      {{ followup.by.get_full_name }} on {{ followup.timestamp }}
		    </div>
		    <div class="card-body">
		      {{ followup.text|process_markup }}
		    </div>
		  </div>
		</li>
	      {% empty %}
		<li>No followups have yet occurred</li>
	      {% endfor %}
	    </ul>
	    {% if ticket.is_open %}
	      {% if request.user|is_in_group:ticket.queue.managing_group.name %}
		<a class="btn btn-sm btn-danger" role="button" href="{% url 'helpdesk:ticket_delete' pk=ticket.id %}"><i class="fa fa-trash"></i> Delete</a>
		<a class="btn btn-sm btn-warning" role="button" href="{% url 'helpdesk:ticket_update' pk=ticket.id %}"><i class="fa fa-edit"></i> Update</a>
		{% if not ticket.assigned_to %}
		  <a class="btn btn-sm btn-info" role="button" href="{% url 'helpdesk:ticket_assign' pk=ticket.id %}"><i class="fa fa-arrow-circle-right"></i> Assign this ticket</a>
		{% else %}
		  <a class="btn btn-sm btn-info" role="button" href="{% url 'helpdesk:ticket_assign' pk=ticket.id %}"><i class="fa fa-arrow-circle-right"></i> Reassign this ticket <span class="text-small text-muted">[currently: {{ ticket.assigned_to.username }}]</span></a>
		{% endif %}
		<br/><br/>
	      {% endif %}
	      <a class="btn btn-sm btn-success" role="button" href="{% url 'helpdesk:ticket_followup' pk=ticket.id %}"><i class="fa fa-reply"></i> Reply/Followup</a>
	      <a class="btn btn-sm btn-primary" role="button" href="{% url 'helpdesk:ticket_mark_resolved' pk=ticket.id %}"><i class="fa fa-check-square"></i> Mark as resolved</a>
	      <a class="btn btn-sm btn-secondary" role="button" href="{% url 'helpdesk:ticket_mark_closed' pk=ticket.id %}"><i class="fa fa-times"></i> Close this Ticket</a>
	    {% endif %}
	  </td>
	</tr>
      </tbody>
    </table>

  </div>
</div>
