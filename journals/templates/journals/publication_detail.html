{% extends 'journals/_base.html' %}

{% load journals_extras %}
{% load staticfiles %}
{% load scipost_extras %}

{% block pagetitle %}: Publication detail{% endblock pagetitle %}

{% block breadcrumb_items %}
    {{block.super}}
    <a href="{{journal.get_absolute_url}}" class="breadcrumb-item">{{journal}}</a>
    <a href="{{publication.in_issue.get_absolute_url}}" class="breadcrumb-item">{{publication.in_issue.short_str}}</a>
    <span class="breadcrumb-item active">{{publication.title}}</span>
{% endblock %}

{% block headsup %}

    <meta name="citation_title" content="{{ publication.title }}"/>
    {% for author in publication.authors.all %}
    <meta name="citation_author" content="{{ author.user.last_name }}, {{ author.user.first_name }}"/>
    {% endfor %}
    {% for author in publication.authors_unregistered.all %}
    <meta name="citation_author" content="{{ author.last_name }}, {{ author.first_name }}"/>
    {% endfor %}
    <meta name="citation_doi" content="{{ publication.doi_string }}"/>
    <meta name="citation_publication_date" content="{{ publication.publication_date|date:'Y/m/d' }}"/>
    <meta name="citation_journal_title" content="{{ journal }}"/>
    <meta name="citation_issn" content="{{ journal.issn }}"/>
    <meta name="citation_volume" content="{{ publication.in_issue.in_volume.number }}"/>
    <meta name="citation_issue" content="{{ publication.in_issue.number }}"/>
    <meta name="citation_firstpage" content="{{ publication.paper_nr|paper_nr_string_filter }}"/>
    <meta name="citation_pdf_url" content="https://scipost.org/{{ publication.doi_string }}/pdf"/>

    <meta name="dc.identifier" content="doi:{{ publication.doi_string }}"/>

    <script>
      $(document).ready(function(){
        $("#citationslist").hide();

        $("#citationslistbutton").click(function(){
          $("#citationslist").toggle();
        });
      });
    </script>

{% endblock headsup %}

{% block content %}

    {% include 'journals/_publication_details.html' with publication=publication %}

    {% if publication.citedby|length >= 1 %}
        <hr>
        <div class="row">
            <div class="col-6 col-md-2">
                <h3 class="mb-2">Cited by {{ publication.citedby|length }}</h3>
                <button class="btn btn-sm btn-secondary" id="citationslistbutton">Toggle view</button>
            </div>
            <div class="col-6 col-md-2">
                <img src="{% static 'scipost/images/citedby.gif' %}" alt="Crossref Cited-by" width="64" />
            </div>
        </div>
        <div class="row" id="citationslist">
            <div class="col-12">
                {# {% include 'journals/_publication_citations.html' with publication=publication %}#}
                {{ publication.citations_as_ul }}
            </div>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <hr>
            <h3>View more material from these authors:</h3>
            <p>
            {% for author in publication.authors.all %}
              <a href="/contributor/{{ author.id }}">{{ author }}</a>&nbsp;&nbsp;
            {% endfor %}
            {% for author in publication.authors_unregistered.all %}
              {{ author }}&nbsp;&nbsp;
            {% endfor %}
            </p>
        </div>
    </div>

    {% if request.user|is_in_group:'Editorial Administrators' %}
    <div class="row">
        <div class="col-12">
            <hr>
    <h3>Editorial Administration tools: </h3>
        <ul>
          <li>Mark the first author (currently: {% if publication.first_author %}{{ publication.first_author }} {% elif publication.first_author_unregistered %}{{ publication.first_author_unregistered }} (unregistered){% endif %})
            <div class="row">
                <div class="col-md-5">
                  <p>registered authors:</p>
                  <ul>
                    {% for author in publication.authors.all %}
                      <li>
                        <a href="{% url 'journals:mark_first_author' publication_id=publication.id contributor_id=author.id %}">{{ author }}</a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
                <div class="col-md-5">
                  <p>unregistered authors:</p>
                  <ul>
                    {% for author_unreg in publication.authors_unregistered.all %}
                      <li>
                        <a href="{% url 'journals:mark_first_author_unregistered' publication_id=publication.id unregistered_author_id=author_unreg.id %}">{{ author_unreg }}</a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
            </div>
          </li>
          <li><a href="{% url 'journals:add_author' publication.id %}">Add a missing author</a></li>
          <li><a href="{% url 'journals:create_citation_list_metadata' publication.doi_label %}">Create/update citation list metadata</a></li>
          <li><a href="{% url 'journals:create_funding_info_metadata' publication.doi_label %}">Create/update funding info metadata</a></li>
          <li><a href="{% url 'journals:create_metadata_xml' publication.doi_label %}">Create/update the XML metadata</a></li>
          <li><a href="{% url 'journals:metadata_xml_deposit' publication.doi_label 'test' %}">Test metadata deposit (via Crossref test server)</a></li>
          <li><a href="{% url 'journals:metadata_xml_deposit' publication.doi_label 'deposit' %}">Deposit the metadata to Crossref</a></li>
          <li><a href="{% url 'journals:harvest_citedby_links' publication.doi_label %}">Update Crossref cited-by links</a></li>
        </ul>
        </div>
    </div>
    {% endif %}

{% endblock content %}
