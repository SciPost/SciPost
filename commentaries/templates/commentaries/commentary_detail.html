{% extends 'scipost/base.html' %}

{% block pagetitle %}: Commentary detail{% endblock pagetitle %}

{% block headsup %}

<script>
  $(document).ready(function(){
  $("#commentsbutton").click(function(){
  $("#commentslist").toggle();
  });
  });
</script>

{% endblock headsup %}

{% block bodysup %}

<!-- Temporary strip -->
{% if user.is_authenticated %}

<section>
  <div class="flex-greybox">
    <h1>SciPost Commentary Page &nbsp; (non-SciPost publications)</h1>
  </div>

  <hr class="hr12">
  <div class="row">
    <div class="col-4">
      <h2>Original publication: </h2>
    </div>
  </div>
  {{ commentary.header_as_table|safe }}

  <h3>Abstract:</h3>
  <p>{{ commentary.pub_abstract }}</p>
  
</section>

{% if reports %}
<section>
  <hr class="hr12">
  <div class="flex-greybox">
    <h2>Reports on this publication</h2>
  </div>
  <hr>
</section>
{% endif %}

{% if comments %}
<section>
  <hr class="hr12">
  <div class="flex-greybox">
    <h2>Comments on this publication</h2>
    <button id="commentsbutton">Toggle comments view</button>
  </div>

  <div id="commentslist">
    {% for comment in comments %}
    
    <hr class="hr6">

<!--
    <div class="row">      
      <div class="col-3">
	{{ comment.print_identifier|safe }}
      </div>
      
      <div class="col-9">
        {{ comment.categories_as_ul|safe }} 
	<br/>
	<div class="opinionsDisplay">
	  {% if user.is_authenticated and user.contributor.rank > 0 and user.contributor != comment.author %}
	  <form action="{% url 'comments:express_opinion' comment.id %}" method="post">
	    {% csrf_token %}
	    {{ opinion_form }}
	    <input type="submit" value="Submit"/>
	  </form>
	  {% endif %}
	  {{ comment.opinions_as_ul|safe }}
	</div>
      </div>
    </div>
-->
    <div class="flex-container">
      <div class="flex-commentbox">
	{{ comment.print_identifier|safe }}
        {{ comment.categories_as_ul|safe }} 
	<div class="opinionsDisplay">
	  {% if user.is_authenticated and user.contributor.rank > 0 and user.contributor != comment.author %}
	  <form action="{% url 'comments:express_opinion' comment.id %}" method="post">
	    {% csrf_token %}
	    {{ opinion_form }}
	    <input type="submit" value="Submit"/>
	  </form>
	  {% endif %}
	  {{ comment.opinions_as_ul|safe }}
	</div>
      </div>
    </div>

    <div class="row">
      <div class="col-1"></div>
      <div class="col-10">
	<p>{{ comment.comment_text|linebreaks }}</p>
      </div>
    </div>
  
    {% for reply in author_replies %}
    {% if reply.in_reply_to_comment.id = comment.id %}
    
    <div class="row">
      <div class="col-1"></div>
      <hr style="border-style: dotted;" />
      <div class="col-3">
	{{ reply.print_identifier|safe }}
      </div>
    </div>
    <div class="row">
      <div class="col-1"></div>
      <div class="col-10">
	<p>{{ reply.reply_text|linebreaks }}</p>
      </div>
    </div>
    
    {% endif %}
    {% endfor %}
    
    {% if user.is_authenticated and user.contributor.rank > 0 %}
    <div class="row">
      <div class="col-1"></div>
      <hr class="hr6"/>
    </div>
    <div class="row">
      <div class="col-1"></div>
      <div class="col-5">
	<h3><a href="{% url 'comments:author_reply_to_comment' comment_id=comment.id %}">Reply to this comment (Author)</a></h3>
      </div>
      <div class="col-5">
	<h3><a href="{% url 'comments:reply_to_comment' comment_id=comment.id %}">Reply to this comment (Contributor)</a></h3>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div id="commentslist">
</section>
{% endif %}

{% if user.is_authenticated and commentary.open_for_commenting and user.contributor.rank > 0 %}
<section>
  <hr class="hr12">
  <div class="flex-greybox">
    <h1>Contribute a Comment:</h1>
  </div>
  <form action="{% url 'commentaries:commentary' commentary.id %}" method="post">
    {% csrf_token %}
    {% load crispy_forms_tags %}
    {% crispy form %}
  </form>
</section>
{% endif %}

{% endif %} <!-- Temporary strip -->

{% endblock bodysup %}
