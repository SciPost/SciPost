{% extends 'production/base.html' %}

{% load crispy_forms_tags %}
{% load scipost_extras %}
{% load common_extras %}

{% block breadcrumb_items %}<span class="breadcrumb-item">Production streams</span>{% endblock %}

{% block pagetitle %}
  : Production page
{% endblock pagetitle %}


{% block content %}

  <div class="row">
    <div class="col-12 col-sm">
      <h1>Production Streams</h1>
    </div>
    <div class="col-12 col-sm-auto">

      {% if perms.scipost.can_promote_user_to_production_officer %}
        <a class="btn-link fs-4" href="{% url 'production:production_team' %}">Production Team</a>
        &nbsp;|&nbsp;
      {% endif %}

      <a class="btn-link fs-4" href="{% url 'finances:personal_timesheet' %}">Personal Timesheet</a>
    </div>
  </div>

  {% if perms.scipost.can_promote_user_to_production_officer and work_contracts %}
    <div class="row">
      <div class="col">
        <table class="table table-bordered mt-4">
          <thead class="table-light">
            <th>Employee</th>
            <th>Availability</th>
            <th>Contract hours</th>
            <th>Hours in {% now "F Y" %}</th>
          </thead>
          <tbody>
            {% for contract in work_contracts %}
              <tr>
                <td>{{ contract.employee.profile.full_name }}</td>
                <td>
                  <ul class="m-0 p-0 list-unstyled">
                    {% for period in contract.employee.current_unavailability_periods %}
                    <li>
                      <span class="text-danger me-1">{% include "bi/x-circle-fill.html" %}</span> 
                      <span>Unavailable from {{ period.start }}, back on {{ period.end }}</span>  
                    </li>
                    {% empty %}
                    <li>
                      <span class="text-success me-1">{% include "bi/check-circle-fill.html" %}</span>
                      <span>Available</span>
                    </li>
                    {% endfor %}
                  </ul>
                </td>
                <td>{{ contract.work_hours_month|duration }}</td>
                <td>
                  <span class="me-3">{{ contract.hours_worked_this_month|duration }}</span>
                  {% if contract.hours_worked_this_month > contract.work_hours_month %}
                    <span class="text-success me-1">{% include "bi/check-circle-fill.html" %}</span>
                    <span>Minimum hours satisfied</span>
                  {% else %}
                    <span class="text-danger me-1">{% include "bi/x-circle-fill.html" %}</span>
                    <span>{{ contract.work_hours_month|subtract:contract.hours_worked_this_month|duration }} remaining</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
  
  <details id="productionstreams-filter-details" class="card my-4">
    <summary class="card-header d-flex flex-row align-items-center justify-content-between list-triangle">
      <div class="fs-3">Search / Filter / Bulk Actions</div>
      <div class="d-none d-md-flex align-items-center">
 
        <div id="indicator-search-productionstreams" class="htmx-indicator">
          <button class="btn btn-warning text-white d-none d-md-block me-1"
                  type="button"
                  disabled>
            <strong>Loading...</strong>
 
            <div class="spinner-grow spinner-grow-sm ms-2"
                 role="status"
                 aria-hidden="true"></div>
          </button>
        </div>

        <button class="btn btn-outline-secondary me-1"
                type="button"
                hx-get="{% url 'production:_hx_productionstream_search_form' filter_set="empty" %}"
                hx-target="#productionstream-search-form-container">Clear Filters</button>
 
        <a id="refresh-button" class="m-2 btn btn-primary">
          {% include "bi/arrow-clockwise.html" %}
        &nbsp;Refresh</a>
      </div>

    </summary>
    <div class="card-body">
      <div id="productionstream-search-form-container">
        {% include 'production/_hx_productionstream_search_form.html' with form=search_productionstreams_form %}
      </div>

      {% comment %} Bulk Action buttons {% endcomment %}

      {% if perms.scipost.can_assign_production_officer or perms.scipost.can_assign_production_supervisor %}
        <hr />
        <div hx-get="{% url 'production:_hx_productionstream_actions_bulk_assign_officers' %}"
             hx-trigger="load"></div>
      {% endif %}

    </div>
  </details>

  <div id="search-productionstreams-results" class="mt-2"></div>

{% endblock content %}
