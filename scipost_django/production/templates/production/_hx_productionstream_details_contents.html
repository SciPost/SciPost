{% load guardian_tags %}

{% get_obj_perms request.user for productionstream as "sub_perms" %}

<p>
  <strong class="text-warning">While the new production page is being built</strong>: go the the <a href="{{ productionstream.get_absolute_url }}" target="_blank">(old) stream detail page</a> to manage this stream.
</p>

<div class="row">
  <div class="col-12 col-md-6">
    <h3>Actions</h3>
    {% if "can_perform_supervisory_actions" in sub_perms %}
      <div class="container">
        <details class="mb-3">
          <summary class="fs-6">Change stream property</summary>
          <div class="border-primary border-start ps-2 pt-4">
            {% include "production/_hx_productionstream_change_status.html" with form=status_form stream=productionstream %}
            {% include "production/_hx_productionstream_change_supervisor.html" with form=supervisor_form stream=productionstream %}
            {% include "production/_hx_productionstream_change_prodofficer.html" with form=prod_officer_form stream=productionstream %}
            {% include "production/_hx_productionstream_change_invofficer.html" with form=inv_officer_form stream=productionstream %}
          </div>
        </details>
      </div>
    {% endif %}
    <ul>
      <li>Worklog</li>

      {% if perms.scipost.can_publish_accepted_submission %}
        <div class="row">
          <div class="col-12 col-sm-auto col-md-12 col-lg-auto h-100 d-none-empty">
            <div class="row m-0 d-none-empty">
              <button class="btn btn-sm btn-warning text-white" hx-get="{% url 'production:mark_as_completed' stream_id=productionstream.id %}" hx-confim="Are you sure you want to mark this stream as completed?" hx-target="#productionstream-{{ productionstream.id }}-details">
                Mark this stream as completed
              </button>
            </div>
          </div>
        </div>
      {% endif %}
 
      {% if perms.scipost.can_draft_publication and stream.status == 'accepted' %}
        <div class="row">
          <div class="col-12 col-sm-auto col-md-12 col-lg-auto h-100 d-none-empty">
            <div class="row m-0 d-none-empty">
              <a class="btn btn-sm btn-primary text-white" href="{% url 'journals:create_publication' productionstream.submission.preprint.identifier_w_vn_nr %}">
                Draft publication
              </a>
            </div>
          </div>
        </div>
      {% endif %}
      <li>Accessibility</li>
      <li>Send Proofs</li>
    </ul>
  </div>

  <div id="productionstream-{{ productionstream.id }}-event-container"
       class="col-12 col-md-6 d-flex flex-column">
    {% comment %} This might be better to refactor with an OOB response on each event addition {% endcomment %}
    <h3>Events</h3>
    <div id="productionstream-{{ productionstream.id }}-event-list"
         class="overflow-scroll mb-4"
         style="max-height: max(50vh, 40em)"
         hx-get="{% url 'production:render_stream_events' productionstream.id %}"
         hx-trigger="load, submit from:#productionstream-{{ productionstream.id }}-details target:form delay:500">
    </div>
    <div id="productionstream-{{ productionstream.id }}-event-new-comment-form">
      <button hx-get="{% url 'production:_hx_event_form' productionstream_id=productionstream.id %}"
              hx-target="#productionstream-{{ productionstream.id }}-event-new-comment-form"
              hx-trigger="click"
              hx-swap="outerHTML"
              class="btn btn-primary">Add a comment to this stream</button>
    </div>
  </div>
 
</div>
