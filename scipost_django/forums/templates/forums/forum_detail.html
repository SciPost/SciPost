{% extends 'forums/base.html' %}

{% load bootstrap %}
{% load automarkup %}
{% load scipost_extras %}

{% block breadcrumb_items %}
  {{ block.super }}
  <span class="breadcrumb-item">{% if forum.meeting %}Meeting{% else %}Forum{% endif %} Details</span>
{% endblock %}

{% block pagetitle %}: {% if forum.meeting %}Meeting{% else %}Forum{% endif %} details{% endblock pagetitle %}

{% block content %}

  {% with can_add_forum=perms.forums.add_forum can_change_forum=perms.forums.change_forum meeting=forum.meeting %}

    <div class="row">
      <div class="col-12">
	<h2 class="highlight">
	  {% if meeting %}
	    {% with context_colors=meeting.context_colors %}
	      <span class="badge bg-{{ context_colors.bg }} mx-0 mb-2 p-2 text-{{ context_colors.text }}">
		{{ context_colors.message }}
		<span class="small text-muted"> [{{ meeting.date_from|date:"Y-m-d" }} to {{ meeting.date_until|date:"Y-m-d" }}]</span>
	      </span>
	    {% endwith %}
	    <br/>
	  {% endif %}

	  <span class="d-flex flex-wrap justify-content-between">
	    <a href="{{ forum.get_absolute_url }}">{{ forum }}</a>
	    <span class="badge bg-primary rounded-pill">{{ forum.cf_nr_posts }} post{{ forum.cf_nr_posts|pluralize }}</span>
	  </span>
	</h2>

	{% if forum.parent %}
	  <p>Parent: <a href="{{ forum.parent.get_absolute_url }}">{{ forum.parent }}</a></p>
	{% endif %}
	{% if forum.child_forums.all|length > 0 %}
	  <p>Descendants: {% for child in forum.child_forums.all %}<a href="{{ child.get_absolute_url }}">{{ child }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</p>
	{% endif %}

	{% if can_change_forum %}
	  <div class="container border border-danger m-2 p-2">
	    <h4>Admin actions:</h4>
	    <ul>
	      <li><a href="{% url 'forums:forum_update' slug=forum.slug %}" class="text-warning">Update this {% if meeting %}Meeting{% else %}Forum{% endif %}</a></li>
	      <li>
		{% if not forum.child_forums.all|length > 0 %}
		  <a href="{% url 'forums:forum_delete' slug=forum.slug %}" class="text-danger">Delete this {% if meeting %}Meeting{% else %}Forum{% endif %} (and all Posts {% if meeting %}and Motions {% endif %}it contains)</a>
		{% else %}
		  <span class="text-danger" style="text-decoration: line-through;">Delete this Forum</span> Please delete descendant Forums first.
		{% endif %}
	      </li>
	      {% if not meeting %}
		<li><a href="{% url 'forums:forum_create' parent_model='forum' parent_id=forum.id %}">Create a (sub)Forum within this one</a></li>
		<li><a href="{% url 'forums:meeting_create' parent_model='forum' parent_id=forum.id %}">Create a Meeting within this Forum</a></li>
	      {% endif %}
	    </ul>

	    {% if can_change_forum %}
	      <details id="forum-permissions-details"
		       class="border border-danger bg-danger bg-opacity-10 m-2">
		<summary class="bg-danger bg-opacity-10 p-2">
		  Permissions on this {% if forum.meeting %}Meeting{% else %}Forum{% endif %} instance (view/manage)
		  <span id="forum-permissions-details-contents-indicator" class="htmx-indicator p-2">
		    <button class="btn btn-warning" type="button" disabled>
		      <strong>Loading...</strong>
		      <div class="spinner-grow spinner-grow-sm ms-2" role="status" aria-hidden="true"></div>
		    </button>
		  </span>
		</summary>
		<div id="forum-permissions-details-contents"
		     class="p-2"
		     hx-get="{% url 'forums:_hx_forum_permissions' slug=forum.slug %}"
		     hx-trigger="toggle once from:#forum-permissions-details"
		     hx-target="#forum-permissions-details-contents"
		     hx-indicator="#forum-permissions-details-contents-indicator"
		>
		</div>

	      </details>
	    {% endif %}

	  </div>
	{% endif %}
      </div>
    </div>

    <div class="row">
      <div class="col">
	<h2>Table of Contents</h2>
	<div class="m-2">
	  <ul>
	    <li><a href="#Description">Description</a></li>
	    {% if meeting %}
	      <li><a href="#Preamble">Preamble</a></li>
	      <li><a href="#Motions">Motions</a></li>
	    {% endif %}
	    <li><a href="#Posts">Posts</a>
	    </li>
	    {% if meeting %}
	      <li><a href="#Minutes">Minutes</a></li>
	    {% endif %}
	  </ul>
	</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
	<div class="card">
	  <div class="card-header">
	    <button class="btn btn-primary btn-small" data-bs-toggle="collapse" data-bs-target="#recentPostsLinks">
	      Quick links: all posts and motions (click to toggle)
	    </button>
	  </div>
	  <div class="card-body collapse" id="recentPostsLinks">
	    <h3>(most recent first)</h3>
	    <ul>
	      {% for post in forum.posts_all.all reversed %}
		<li>
		  <a href="{{ post.get_absolute_url }}">{{ post.subject }}</a> posted by {{ post.posted_by.first_name }} {{ post.posted_by.last_name }} on {{ post.posted_on|date:"Y-m-d H:i" }}
		  {% if post.parent and not post.motion %}
		    - regarding <a href="{{ post.parent.get_absolute_url }}">{{ post.parent }}</a>
		  {% endif %}
		</li>
	      {% endfor %}
	    </ul>
	  </div>
	</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
	<div class="card">
	  <div class="card-header">
	    <button class="btn btn-primary btn-small" data-bs-toggle="collapse" data-bs-target="#anchorPostsLinks">
	      Quick links: anchor posts, latest followup (click to toggle)
	    </button>
	  </div>
	  <div class="card-body collapse" id="anchorPostsLinks">
	    <ul>
	      {% for post in forum.posts.all %}
		<li>
		  <a href="{{ post.get_absolute_url }}">{{ post.subject }}</a> posted by {{ post.posted_by.first_name }} {{ post.posted_by.last_name }} on {{ post.posted_on|date:"Y-m-d H:i" }}
		  <p>
		    {{ post.cf_nr_followups }} followup{{ post.cf_nr_followups|pluralize }}
		    {% with post.cf_latest_followup_in_hierarchy as latest_followup %}
		      {% if latest_followup %}
			,&emsp;latest: <a href="{{ latest_followup.get_absolute_url }}">
			{{ latest_followup.subject }}</a>
			posted by {{ latest_followup.posted_by.first_name }}
			{{ latest_followup.posted_by.last_name }}
			on {{ latest_followup.posted_on|date:"Y-m-d H:i" }}
		      {% endif %}
		    {% endwith %}
		  </p>
		</li>
	      {% endfor %}
	    </ul>
	  </div>
	</div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
	<h2 class="highlight" id="Description">Description</h2>
	<div class="m-2">
	  {% automarkup forum.description %}
	</div>
      </div>
    </div>

    {% if meeting %}
      <div class="row">
	<div class="col-12">
	  <h2 class="highlight" id="Preamble">Preamble</h2>
	  <div class="m-2">
	    {% automarkup meeting.preamble %}
	  </div>
	</div>
      </div>

      <div class="row">
	<div class="col-12">
	  <h2 class="highlight" id="Motions">Motions</h2>
	  <ul>
	    {% if meeting.future %}
	      <li>Adding Motions will be activated once the meeting starts</li>
	    {% elif meeting.past %}
	      <li><span class="text-danger">Adding Motions is deactivated</span> (Meeting is over)</li>
	    {% else %}
	      <li><a href="{% url 'forums:motion_create' slug=forum.slug parent_model='forum' parent_id=forum.id %}">Add a new Motion</a></li>
	    {% endif %}
	  </ul>
	  {% for motion in forum.motions.all %}
	    {% include 'forums/post_card.html' with forum=forum post=motion.post can_change_forum=can_change_forum %}
	  {% endfor %}
	</div>
      </div>

    {% endif %}

    <div class="row">
      <div class="col-12">
	<h2 class="highlight" id="Posts">Posts</h2>
	<ul>
	  <li><a href="{% url 'forums:post_create' slug=forum.slug parent_model='forum' parent_id=forum.id %}">Add a new Post</a></li>
	</ul>

	{% for post in forum.posts.motions_excluded %}
	  {% include 'forums/post_card.html' with forum=forum post=post can_change_forum=can_change_forum %}
	{% endfor %}

      </div>
    </div>

    {% if meeting %}
      <div class="row">
	<div class="col-12">
	  <h2 class="highlight" id="Minutes">Minutes</h2>
	  <div class="m-2">
	    {% automarkup meeting.minutes %}
	  </div>
	</div>
      </div>
    {% endif %}

  {% endwith %}

{% endblock content %}
