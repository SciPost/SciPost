{% load bootstrap %}

{% load user_groups %}
{% load guardian_tags %}
{% get_obj_perms request.user for subsidy.organization as "user_org_perms" %}

<div class="row">
  <div class="col-12">
    {% if perms.scipost.can_manage_subsidies %}
      <ul class="list-inline"><li class="list-inline-item"><strong>Admin actions:</strong></li>
	<li class="list-inline-item"><a href="{% url 'finances:subsidy_update' pk=subsidy.id %}"><span class="text-warning">Update</span></a></li>
	<li class="list-inline-item"><a href="{% url 'finances:subsidy_delete' pk=subsidy.id %}"><span class="text-danger">Delete</span></a></li>
      </ul>
    {% endif %}

    <table class="table">
      <tr>
	<td>From:</td><td>{% if subsidy.organization.details_publicly_viewable or perms.scipost.can_manage_organizations %}<a href="{{ subsidy.organization.get_absolute_url }}">{{ subsidy.organization }}</a>{% else %}{{ subsidy.organization }}{% endif %}</td>
      </tr>
      <tr>
	<td>Type:</td><td>{{ subsidy.get_subsidy_type_display }}</td>
      </tr>
      <tr>
	<td>Description:</td><td>{{ subsidy.description }}</td>
      </tr>
      <tr>
	<td>Amount:</td><td>{% if subsidy.amount_publicly_shown or perms.scipost.can_manage_subsidies or "can_view_org_contacts" in user_org_perms %}&euro;{{ subsidy.amount }}{% else %}-{% endif %}{% if perms.scipost.can_manage_subsidies or "can_view_org_contacts" in user_org_perms %} {% if subsidy.amount_publicly_shown %}<span class="text-success">publicly visible</span>{% else %}<span class="text-danger">publicly invisible</span>{% endif %}&nbsp;&nbsp;<a href="{% url 'finances:subsidy_toggle_amount_public_visibility' subsidy_id=subsidy.id %}" class="small">Make it {% if subsidy.amount_publicly_shown %}in{% endif %}visible</a>{% endif %}</td>
      </tr>
      <tr>
	<td>Date from:</td><td>{{ subsidy.date_from }}</td>
      </tr>
      {% if subsidy.date_until %}
	<tr>
	  <td>Date until:</td><td>{{ subsidy.date_until }}</td>
	</tr>
      {% endif %}
      {% if perms.scipost.can_manage_subsidies %}
	<tr>
	  <td>Renewable?</td><td>{% if subsidy.renewable == True %}Yes, renewal action date: <span class="bg-{{ subsidy.renewal_action_date_color_class }}">{{ subsidy.renewal_action_date }}</span>{% elif subsidy.renewable == None %}Undetermined [please update]{% else %}No{% endif %}</td>
	</tr>
	<tr>
	  <td>Status</td>
	  <td>{{ subsidy.get_status_display }}</td>
	</tr>
	<tr>
	  <td>Paid on</td>
	  <td>{% if subsidy.paid_on %}{{ subsidy.paid_on }}{% else %}<span class="text-warning">{% include "bi/cone-striped.html" %}</span>{% endif %}</td>
	</tr>
      {% endif %}
    </table>

    {% if subsidy.renewal_of.all|length > 0 %}
      <p>
	Renewal of:<ul>{% for prevsub in subsidy.renewal_of.all %}<li><a href="{% url 'finances:subsidy_details' pk=prevsub.id %}">{{ prevsub }}</a></li>{% endfor %}</ul>
      </p>
    {% endif %}
    {% if subsidy.renewed_by.all|length > 0 %}
      <p>
	Renewed by:<ul>{% for newsub in subsidy.renewed_by.all %}<li><a href="{% url 'finances:subsidy_details' pk=newsub.id %}">{{ newsub }}</a></li>{% endfor %}</ul>
      </p>
    {% endif %}

  </div>
</div>

<div class="row">
  <div class="col-12">
    <h3>Attachments</h3>
    {% if perms.scipost.can_manage_subsidies %}
      <ul>
	<li><a href="{% url 'finances:subsidyattachment_create' subsidy_id=subsidy.id %}">Add a Subsidy Attachment</a> to this Subsidy</li>
      </ul>
    {% endif %}
    <table class="table">
      <thead>
	<tr>
	  <th>File name</th>
	  <th>Date</th>
	  {% if perms.scipost.can_manage_subsidies or "can_view_org_contacts" in user_org_perms %}
	    <th>Visibility</th>
	  {% endif %}
	</tr>
      </thead>
      <tbody>
	{% for att in subsidy.attachments.all %}
	  {% if att.publicly_visible or perms.scipost.can_manage_subsidies or "can_view_org_contacts" in user_org_perms %}
	    <tr>
	      <td><a href="{{ att.get_absolute_url }}" target="_blank">{{ att.filename }}</a></td>
	      <td>{{ att.date }}</td>
	      {% if perms.scipost.can_manage_subsidies or "can_view_org_contacts" in user_org_perms %}
		<td>{{ att.get_visibility_display }}</td>
		{% if perms.scipost.can_manage_subsidies %}
		  <td><a href="{% url 'finances:subsidyattachment_update' pk=att.id %}"><span class="text-warning">Update</span></a></td>
		  <td><a href="{% url 'finances:subsidyattachment_delete' pk=att.id %}"><span class="text-danger">Delete</span></a></td>
		{% endif %}
	      {% endif %}
	    </tr>
	  {% endif %}
	{% empty %}
	  <tr>
	    <td>No attachment found</td>
	  </tr>
	{% endfor %}
      </tbody>
    </table>
  </div>
</div>


{% if 'edadmin' in user_roles %}
  {% if subsidy.amount_publicly_shown %}

    <div class="row">
      <div class="col-12">
	<h3 class="highlight">Expenditures compensated or covered by this Subsidy</h3>

	<table class="table mt-2 caption-top">
	  <caption>PubFrac Compensations</caption>
	  <thead class="table-light">
	    <tr>
	      <th>Publication</th>
	      <th>PubFrac value</th>
	      <th>PubFrac compensation</th>
	    </tr>
	  </thead>
	  <tbody>
	    {% for compensation in subsidy.pubfrac_compensations.all %}
	      <tr>
		<td>
		  <a href="{% url 'scipost:publication_detail' doi_label=compensation.pubfrac.publication.doi_label %}">{{ compensation.pubfrac.publication.doi_label }}</a>
		</td>
		<td>&euro;{{ compensation.pubfrac.cf_value }}</td>
		<td>&euro;{{ compensation.amount }}</td>
	      </tr>
	    {% empty %}
	      <tr>
		<td>No Compensation defined</td>
	      </tr>
	    {% endfor %}
	    <tr class="bg-secondary bg-opacity-10">
	      <th>Total compensations from this Subsidy</th>
	      <td></td>
	      <td>&euro;{{ subsidy.total_compensations }}</td>
	    </tr>
	  </tbody>
	</table>

	<table class="table caption-top">
	  <caption>Expenditure Coverages</caption>
	  <thead class="table-light">
	    <tr>
	      <th>Publication</th>
	      <th>Expenditure</th>
	      <th>Coverage</th>
	    </tr>
	  </thead>
	  <tbody>
	    {% for coverage in subsidy.pex_coverages.all %}
	      <tr>
		<td>
		  <a href="{% url 'scipost:publication_detail' doi_label=coverage.publication.doi_label %}">{{ coverage.publication.doi_label }}</a>
		</td>
		<td>&euro;{{ coverage.publication.expenditures }}</td>
		<td>&euro;{{ coverage.amount }}</td>
	      </tr>
	    {% empty %}
	      <tr>
		<td>No Coverage defined</td>
	      </tr>
	    {% endfor %}
	    <tr class="bg-secondary bg-opacity-10">
	      <th>Total coverages from this Subsidy</th>
	      <td></td>
	      <td>&euro;{{ subsidy.total_coverages }}</td>
	    </tr>
	  </tbody>
	</table>

	<table class="table mt-2 caption-top">
	  <caption>Balance</caption>
	  <tbody>
	    <tr>
	      <th>Subsidy amount</th>
	      <td>{{ subsidy.amount }}</td>
	    </tr>
	    <tr>
	      <th>Compensations</th>
	      <td>{{ subsidy.total_compensations }}</td>
	    </tr>
	    <tr>
	      <th>Coverages</th>
	      <td>{{ subsidy.total_coverages }}</td>
	    </tr>
	    <tr class="bg-secondary bg-opacity-10">
	      <th>Remainder (allocated to reserve fund)</th>
	      <td>{{ subsidy.remainder }}</td>
	    </tr>
	  </tbody>
	</table>

      </div>
    </div>
  {% endif %}
{% endif %}
