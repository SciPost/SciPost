<div class="row">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h2 class="card-title">Refereeing Tasks</h2>
                <ul class="mb-0">
                    <li><a href="{% url 'submissions:accept_or_decline_ref_invitations' %}">Accept/decline refereeing invitations</a> ({{ contributor.referee_invitations.open.count }})</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% if contributor.reports.in_draft.all %}
    <div class="row">
        <div class="col-12">
            <h3 class="highlight">Unfinished reports:</h3>
            <ul class="list-group list-group-flush">
            {% for report in contributor.reports.in_draft.all %}
                <li class="list-group-item">
                    <div class="card-body px-0">
                        {% include 'partials/submissions/submission_li.html' with submission=report.submission %}

                        <a class="btn btn-outline-primary my-2" href="{% url 'submissions:submit_report' report.submission.preprint.identifier_w_vn_nr %}">Finish report</a>
                    </div>
                </li>
            {% endfor %}
            </ul>
        </div>
    </div>
{% endif %}


<div class="row">
    <div class="col-12">
        <h3 class="highlight">Refereeing Invitations</h3>
        {% if contributor.referee_invitations.all %}
            <h3 class="mt-4">Pending Refereeing Invitations</h3>
            {% if contributor.referee_invitations.in_process.all %}
                <ul class="list-group list-group-flush">
                    {% for invitation in contributor.referee_invitations.in_process.all %}
                        <li class="list-group-item py-2">
                            {% include 'partials/submissions/submission_li.html' with submission=invitation.submission %}

                            <table>
                                <tr>
                                    <th style='min-width: 100px;'>Due:</th>
                                    <td>{{ invitation.submission.reporting_deadline|date:'d F Y' }}{% if invitation.submission.reporting_deadline_has_passed %} <span class="label label-sm label-danger ml-2 px-3">overdue</span> {% endif %}<td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>{{ invitation.get_status_display }}</td>
                                </tr>
                                {% if invitation.accepted is not None %}
                                    <tr>
                                        <th>{{ invitation.accepted|yesno:'Accepted,Declined' }}:</th>
                                        <td>{{ invitation.date_responded }}</td>
                                    </tr>
                                {% endif %}
                                <tr>
                                    <td colspan="2">
                                        <a class="d-inline-block" href="{% url 'submissions:submit_report' identifier_w_vn_nr=invitation.submission.preprint.identifier_w_vn_nr %}">Submit your Report</a> <span class="text-blue">|</span>
                                        <a class="d-inline-block" href="{% url 'submissions:communication' identifier_w_vn_nr=invitation.submission.preprint.identifier_w_vn_nr comtype='RtoE' referee_id=request.user.contributor.id %}">Write to the Editor-in-charge</a>
                                    </td>
                                </tr>
                            </table>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p><em>You do not have any pending refereeing task</em></p>
            {% endif %}

            <br>
            <h3><a href="javascript:;" data-toggle="toggle" data-target="#all-invitations">+ See all Refereeing Invitations ({{ contributor.referee_invitations.all|length }})</a></h3>
            <ul class="list-group list-group-flush ml-md-4" id="all-invitations" style="display: none;">
                {% for invitation in contributor.referee_invitations.all %}
                    <li class="list-group-item py-2">
                        {% include 'partials/submissions/submission_li.html' with submission=invitation.submission %}

                        <table>
                            <tr>
                                <th style='min-width: 100px;'>Status:</th>
                                <td>{{ invitation.get_status_display }}</td>
                            </tr>
                            {% if invitation.accepted is not None %}
                                <tr>
                                    <th>{{ invitation.accepted|yesno:'Accepted,Declined' }}:</th>
                                    <td>{{ invitation.date_responded }}</td>
                                </tr>
                            {% endif %}
                            {% if invitation.related_report %}
                                <tr>
                                    <th>Report:</th>
                                    <td><a href="{{ invitation.related_report.get_absolute_url }}">{{ invitation.related_report.citation|default:'Link' }}</a></td>
                                </tr>
                            {% endif %}
                        </table>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p><em>You do not have any refereeing invitation</em></p>
        {% endif %}
    </div>
</div>

{% if contributor.reports.non_draft.all %}
    <div class="row">
        <div class="col-12">
            <h3 class="highlight">Finished reports</h3>

            <ul class="list-group list-group-flush">
            {% for report in contributor.reports.non_draft.all %}
                <li class="list-group-item">
                    {% comment %}
                        Temporary: There is already a template for a "Report summary" in a parallel (unmerged) branch. Awaiting merge to use that template.
                    {% endcomment %}
                    <div class="card-body px-0 {% block cardblock_class_block %}{% endblock %}">
                        <h3>Report on Submission <a href="{{report.submission.get_absolute_url}}">{{report.submission.title}}</a></h3>
                        <table>
                            <tr>
                                <th style='min-width: 100px;'>Received:</th><td>{{ report.date_submitted|date:'Y-n-j' }}<td>
                            </tr>
                            <tr>
                                <th>Status:</th><td {% if report.status == 'vetted' %}class="text-success"{% elif report.status == 'unvetted' %}class="text-danger"{% endif %}>{{report.get_status_display}}</td>
                            </tr>
                            {% if report.doi_label %}
                                <tr>
                                  <th>DOI:</th>
                                  <td>{{ report.doi_string }}</td>
                              </tr>
                            {% endif %}
                            <tr>
                                <th>Anonymous:</th><td>{{report.anonymous|yesno:'Yes,No'}}</td>{% if report.anonymous %}<td>You can <a href="{% url 'journals:sign_existing_report' report_id=report.id %}">click here to sign this Report</a> (leads to confirmation page){% endif %}</td>
                            </tr>
                        </table>
                    </div>
                </li>
            {% endfor %}
            </ul>
        </div>
    </div>
{% endif %}
