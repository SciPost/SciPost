{% load scipost_extras %}
{% if comments %}
<section>
  <hr class="hr12">
  <div class="flex-greybox">
    <h2>Comments on this publication</h2>
    <button id="commentsbutton">Toggle comments view</button>
  </div>

  <div id="commentslist">
    {% for comment in comments %}
    
    <hr class="hr6">

    <div class="flex-container">
      <div class="flex-commentbox">
        {{ comment.print_identifier }}
        {{ comment.categories_as_ul }}
        <div class="opinionsDisplay">
          {% if user.is_authenticated and perms.scipost.can_express_opinion_on_comments %}
	  {% if user.contributor != comment.author %}
	  <form action="{% url 'comments:express_opinion' comment_id=comment.id opinion='A' %}" method="post">
	    {% csrf_token %}
	    <input type="submit" class="agree" value="Agree {{ comment.nr_A }} "/>
	  </form>
	  <form action="{% url 'comments:express_opinion' comment_id=comment.id opinion='N' %}" method="post">
	    {% csrf_token %}
	    <input type="submit" class="notsure" value="Not sure {{ comment.nr_N }}"/>
	  </form>
	  <form action="{% url 'comments:express_opinion' comment_id=comment.id opinion='D'%}" method="post">
	    {% csrf_token %}
	    <input type="submit" class="disagree" value="Disagree {{ comment.nr_D }}"/>
	  </form>
	  {% else %}
	  {{ comment.opinions_as_ul }}
	  {% endif %}
          {% endif %}
        </div>
      </div>
    </div>


    <div class="row">
      <div class="col-1"></div>
      <div class="col-10">
	<p>{{ comment.comment_text|linebreaks }}</p>
      </div>
    </div>
  
    {% for reply in author_replies %}
    {% if reply.in_reply_to_comment %}
    {% if reply.in_reply_to_comment.id = comment.id %}    
    <div class="row">
      <div class="col-1"></div>
      <hr style="border-style: dotted;" />

      <div class="flex-container">
	<div class="flex-commentbox">
          {{ reply.print_identifier }}
          {{ reply.categories_as_ul }}
          <div class="opinionsDisplay">
            {% if user.is_authenticated and perms.scipost.can_express_opinion_on_comments %}
	    {% if user.contributor != reply.author %}
	    <form action="{% url 'comments:express_opinion' comment_id=reply.id opinion='A' %}" method="post">
	      {% csrf_token %}
	      <input type="submit" class="agree" value="Agree {{ reply.nr_A }} "/>
	    </form>
	    <form action="{% url 'comments:express_opinion' comment_id=reply.id opinion='N' %}" method="post">
	      {% csrf_token %}
	      <input type="submit" class="notsure" value="Not sure {{ reply.nr_N }}"/>
	    </form>
	    <form action="{% url 'comments:express_opinion' comment_id=reply.id opinion='D'%}" method="post">
	      {% csrf_token %}
	      <input type="submit" class="disagree" value="Disagree {{ reply.nr_D }}"/>
	    </form>
	    {% else %}
	    {{ reply.opinions_as_ul }}
	    {% endif %}
            {% endif %}
          </div>
	</div>
      </div>
    </div>
    <div class="row">
      <div class="col-1"></div>
      <div class="col-10">
	<p>{{ reply.text|linebreaks }}</p>
      </div>
    </div>    

    {% endif %}
    {% endif %}
    {% endfor %}
    
    {% if user.is_authenticated and perms.scipost.can_submit_comments %}
    <div class="row">
      <div class="col-1"></div>
      <hr class="hr6"/>
    </div>
    <div class="row">
      <div class="col-1"></div>
      <div class="col-5">
	<h3><a href="{% url 'comments:reply_to_comment' comment_id=comment.id %}">Reply to this comment</a></h3>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div id="commentslist">
</section>
{% endif %}
