{% extends 'scipost/_personal_page_base.html' %}

{% block pagetitle %}: registration invitations{% endblock pagetitle %}

{% load scipost_extras %}
{% load bootstrap %}

{% block breadcrumb_items %}
    {{block.super}}
    <span class="breadcrumb-item">Registration invitations</span>
{% endblock %}

{% block content %}

<script>
$(document).ready(function(){

    $('#id_invitation_type').on('change', function() {
        switch ($(this).val()) {
            case "ci":
                $("#id_cited_in_submission").parents('.form-group').show();
                $("#id_cited_in_publication").parents('.form-group').hide();
            break;
            case "cp":
                $("#id_cited_in_submission").parents('.form-group').hide();
                $("#id_cited_in_publication").parents('.form-group').show();
            break;
            default:
                $("#id_cited_in_submission").parents('.form-group').hide();
                $("#id_cited_in_publication").parents('.form-group').hide();
        }
    }).trigger('change');
});
</script>

<div class="row">
    <div class="col-12">
        <div class="card card-grey">
            <div class="card-body">
                <h1 class="card-title">Registration Invitations</h1>
                {% if request.user|is_in_group:'SciPost Administrators' %}
                    <h3>Perform a <a href="{% url 'scipost:registration_invitations_cleanup' %}">cleanup</a> of existing invitations.</h3>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h2 class="highlight">Send a new invitation</h2>
        {% if errormessage %}
            <h3 class="text-danger">{{ errormessage }}</h3>
        {% endif %}
        <form action="{% url 'scipost:registration_invitations' %}" method="post">
            {% csrf_token %}
            {{reg_inv_form.media}}
            {{reg_inv_form|bootstrap}}
            <input type="submit" class="btn btn-secondary">
        </form>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <h2 class="highlight">Existing drafts (to be processed by Admin)</h2>
        <a href="javascript:void(0)" class="btn mb-2" data-toggle="toggle" data-target="#table_existing_drafts">view/hide ({{existing_drafts|length}}) +</a>

        <table class="table" id="table_existing_drafts" style="display: none;">
            <thead>
                <tr>
                    <th>Last name</th>
                    <th>First name</th>
                    <th>Email</th>
                    <th>Date drafted</th>
                    <th>Type</th>
                    <th>Drafted by</th>
                    <th colspan="2">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for draft in existing_drafts %}
                  <tr>
                    <td>{{ draft.last_name }}</td>
                    <td>{{ draft.first_name }}</td>
                    <td>{{ draft.email }}</td>
                    <td>{{ draft.date_drafted }} </td>
                    <td>{{ draft.get_invitation_type_display }}</td>
                    <td>{{ draft.drafted_by.user.first_name }} {{ draft.drafted_by.user.last_name }}</td>
                    <td>
                        <a href="{% url 'scipost:edit_draft_reg_inv' draft_id=draft.id %}">Edit</a> |
                        <a href="{% url 'scipost:registration_invitations_from_draft' draft_id=draft.id %}">Process</a> |
                        <a href="{% url 'scipost:mark_draft_inv_as_processed' draft_id=draft.id %}">Mark as processed</a>
                    </td>
                    <td>
                        <ul>
                        {% for ac in draft|associated_contributors %}
                            <li>
                                <a href="{% url 'scipost:map_draft_reg_inv_to_contributor' draft_id=draft.id contributor_id=ac.id %}">Map to {{ ac.user.first_name }} {{ ac.user.last_name }}</a>
                            </li>
                        {% empty %}
                            <li>No associated contributors found.</li>
                        {% endfor %}
                    </ul>
                    </td>
                  </tr>
                {% empty %}
                    <tr>
                        <td colspan="8">No drafts found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% include 'scipost/_draft_registration_tables.html' %}


{% endblock %}
