{% extends 'affiliates/base.html' %}

{% load bootstrap %}
{% load guardian_tags %}

{% block pagetitle %}: Publication: {{ object }}{% endblock %}

{% block breadcrumb_items %}
  <span class="breadcrumb-item">Affiliates</span>
  <span class="breadcrumb-item">
    <a href="{% url 'affiliates:journals' %}">Journals</a>
  </span>
  <span class="breadcrumb-item">
    <a href="{{ object.journal.get_absolute_url }}">{{ object.journal }}</a>
  </span>
  <span class="breadcrumb-item">{{ object }}</span>
{% endblock %}
{% block content %}

  {% get_obj_perms request.user for object.journal as "user_perms" %}

  <h2 class="highlight">Publication: {{ object }} </h2>
  <p>(in affiliate journal <a href="{{ object.journal.get_absolute_url}}">{{ object.journal }}</a>)</p>

  <table class="table">
    <tr><td>Title</td><td>{{ object.get_title }}</td></tr>
    <tr><td>Author list</td><td>{{ object.get_author_list }}</td></tr>
    <tr><td>Volume</td><td>{{ object.get_volume }}</td></tr>
    <tr><td>Pages</td><td>{{ object.get_pages }}</td></tr>
    <tr><td>Publication date</td><td>{{ object.get_publication_date }}</td></tr>
    <tr><td>DOI</td><td><a href="https://doi.org/{{ object.doi }}" rel="nofollow" target="_blank">{{ object.doi }}</a></td></tr>
  </table>

  <h3 class="highlight">PubFractions</h3>
  {% if 'manage_journal_content' in user_perms %}
    <div class="row">
      <div class="col">
	<h4>Add a PubFraction</h4>
	<form action="{% url 'affiliates:add_pubfraction' slug=object.journal.slug doi=object.doi %}" method="post">
	  {% csrf_token %}
	  {{ add_pubfraction_form }}
	  <input type="submit" value="Add PubFraction" class="btn btn-sm btn-primary">
	</form>
      </div>
    </div>
  {% endif %}
  <div class="row">
    <div class="col">
      <h4>PubFractions for this publication</h4>
      <table class="table">
	<thead>
	  <tr>
	    <td>Organization</td>
	    <td>Fraction</td>
	    <td></td>
	  </tr>
	</thead>
	<tbody>
	  {% for pubfrac in object.pubfractions.all %}
	    <tr>
	      <td><a href="{% url 'organizations:organization_details' pk=pubfrac.organization.id %}">{{ pubfrac.organization }}</a></td>
	      <td>{{ pubfrac.fraction }}</td>
	      {% if 'manage_journal_content' in user_perms %}
		<td>
		  <a href="{% url 'affiliates:delete_pubfraction' slug=object.journal.slug doi=object.doi pubfrac_id=pubfrac.id %}">
		    <span class="text-danger">{% include 'bi/x-square-fill.html' %}</span>
		  </a>
		</td>
	      {% endif %}
	    </tr>
	  {% empty %}
	    <tr>
	      <td>No PubFractions have been defined.</td>
	    </tr>
	  {% endfor %}
	</tbody>
      </table>
      {% if 'manage_journal_content' in user_perms %}
	{% with sum_pubfractions=object.get_sum_pubfractions %}
	  <p>Sum of PubFractions: {{ sum_pubfractions }}.&emsp;
	    {% if sum_pubfractions != 1 %}
	      <span class="bg-danger text-white p-2">WARNING: the PubFractions do not sum up to 1!</span>
	    {% else %}
	      <span class="bg-success text-white p-2">All good, PubFractions sum up to 1.</span>
	    {% endif %}
	  </p>
	{% endwith %}
      {% endif %}
    </div>
  </div>
{% endblock content %}

{% block footer_script %}
  {{ add_pubfraction_form.media }}
{% endblock footer_script %}
